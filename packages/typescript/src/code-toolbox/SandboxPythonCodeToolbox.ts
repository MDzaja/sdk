import { SandboxCodeToolbox } from '../Sandbox'
import { CodeRunParams } from '../Process'

// Get the matplotlib bootstrapper code
// const bootstrapperPath = path.join(__dirname, 'matplotlib_bootstrapper.py')
// const MATPLOTLIB_BOOTSTRAPPER = fs.readFileSync(bootstrapperPath, 'utf-8')

export class SandboxPythonCodeToolbox implements SandboxCodeToolbox {
  public getDefaultImage(): string {
    return 'daytonaio/sdk-python:v0.49.0-2'
  }

  public getRunCommand(code: string, params?: CodeRunParams): string {
    // Encode the provided code in base64
    let base64Code = Buffer.from(code).toString('base64')

    // Override plt.show() method if matplotlib is imported
    if (SandboxPythonCodeToolbox.isMatplotlibImported(code)) {
      let code_wrapper = Buffer.from(PYTHON_CODE_WRAPPER, 'base64').toString('utf-8')
      code_wrapper = code_wrapper.replace('{encoded_code}', base64Code)
      base64Code = Buffer.from(code_wrapper).toString('base64')
    }

    // Build environment variables string
    const envVars = params?.env
      ? Object.entries(params.env)
          .map(([key, value]) => `${key}='${value}'`)
          .join(' ')
      : ''

    // Build command-line arguments string
    const argv = params?.argv ? params.argv.join(' ') : ''

    // Execute the bootstrapper code directly
    // Use -u flag to ensure unbuffered output for real-time error reporting
    return `sh -c '${envVars} python3 -u -c "exec(__import__(\\\"base64\\\").b64decode(\\\"${base64Code}\\\").decode())" ${argv}'`
  }

  /**
   * Checks if matplotlib is imported in the given Python code string.
   * @param codeString Python code as a string
   * @returns True if matplotlib is imported, false otherwise
   */
  private static isMatplotlibImported(codeString: string): boolean {
    // Regex patterns for different import styles
    const patterns: RegExp[] = [
      // Standard imports
      /^[^#]*import\s+matplotlib/m,
      /^[^#]*from\s+matplotlib/m,

      // Dynamic imports
      /^[^#]*__import__\s*\(\s*['"]matplotlib['"]/m,
      /^[^#]*importlib\.import_module\s*\(\s*['"]matplotlib['"]/m,

      // Other dynamic loading patterns
      /^[^#]*loader\.load_module\s*\(\s*['"]matplotlib['"]/m,
      /^[^#]*sys\.modules\[['"]matplotlib['"]\]/m,
    ]

    // Check each pattern
    for (const pattern of patterns) {
      if (pattern.test(codeString)) {
        return true
      }
    }

    return false
  }
}

const PYTHON_CODE_WRAPPER = `
IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIFRoaXMgZmlsZSBjb250YWlucyB0aGUgYm9vdHN0cmFw
cGVyIGNvZGUgZm9yIG1hdHBsb3RsaWIgaW50ZXJjZXB0b3IKIyBJdCB3aWxsIGJlIGxvYWRlZCBh
bmQgYmFzZTY0IGVuY29kZWQgaW4gdGhlIHdvcmtzcGFjZV9weXRob25fY29kZV90b29sYm94LnB5
CgojIFN0YW5kYXJkIGxpYnJhcnkgaW1wb3J0cwppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwppbXBv
cnQgYmFzZTY0CmltcG9ydCBqc29uCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IGxpbmVjYWNoZQpp
bXBvcnQgcmUKaW1wb3J0IGlvCmltcG9ydCBtYXRoCmZyb20gaW1wb3J0bGliLmFiYyBpbXBvcnQg
TWV0YVBhdGhGaW5kZXIsIExvYWRlcgpmcm9tIGltcG9ydGxpYi51dGlsIGltcG9ydCBzcGVjX2Zy
b21fbG9hZGVyLCBmaW5kX3NwZWMKCiMgRmxhZyB0byB0cmFjayBpZiB3ZSd2ZSBhbHJlYWR5IHBh
dGNoZWQgbWF0cGxvdGxpYgpwbHRfcGF0Y2hlZCA9IEZhbHNlCgojIFNldCB0byB0cmFjayBmaWd1
cmUgbnVtYmVycyB0aGF0IGhhdmUgYmVlbiBwcm9jZXNzZWQKcHJvY2Vzc2VkX2ZpZ3VyZXMgPSBz
ZXQoKQoKCmRlZiBleHRyYWN0X2JveF9wbG90X2RhdGEoYXgsIHh0aWNrbGFiZWxzKToKICAgICIi
IkV4dHJhY3QgZGF0YSBmcm9tIGJveCBwbG90cyIiIgogICAgaW1wb3J0IG1hdHBsb3RsaWIucHlw
bG90IGFzIHBsdAogICAgaW1wb3J0IG1hdGggICMgVXNlIG1hdGggaW5zdGVhZCBvZiBudW1weQog
ICAgaW1wb3J0IG1hdHBsb3RsaWIucGF0Y2hlcwoKICAgIGVsZW1lbnRzID0gW10KICAgICMgRmlu
ZCBhbGwgYm94IHBsb3QgZWxlbWVudHMKICAgIGJveGVzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBh
eC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgIGNoaWxkLCBtYXRwbG90bGli
LnBhdGNoZXMuUGF0aFBhdGNoKV0KICAgIHdoaXNrZXJzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBh
eC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgIGNoaWxkLCBwbHQuTGluZTJE
KSBhbmQgY2hpbGQuZ2V0X2xpbmVzdHlsZSgpID09ICctJ10KICAgIGNhcHMgPSBbY2hpbGQgZm9y
IGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2UoCiAgICAgICAgY2hpbGQs
IHBsdC5MaW5lMkQpIGFuZCBjaGlsZC5nZXRfbWFya2VyKCkgPT0gJ18nXQogICAgbWVkaWFucyA9
IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkgaWYgaXNpbnN0YW5jZSgKICAg
ICAgICBjaGlsZCwgcGx0LkxpbmUyRCkgYW5kIGNoaWxkLmdldF9saW5lc3R5bGUoKSA9PSAnLScg
YW5kIChjaGlsZC5nZXRfY29sb3IoKSA9PSAnb3JhbmdlJyBvciBjaGlsZC5nZXRfY29sb3IoKSA9
PSAncmVkJyldCiAgICBmbGllcnMgPSBbY2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJl
bigpIGlmIGlzaW5zdGFuY2UoCiAgICAgICAgY2hpbGQsIHBsdC5MaW5lMkQpIGFuZCBjaGlsZC5n
ZXRfbWFya2VyKCkgPT0gJ28nXQoKICAgICMgUHJvY2VzcyBlYWNoIGJveCBwbG90CiAgICBmb3Ig
aWR4IGluIHJhbmdlKGxlbihib3hlcykpOgogICAgICAgICMgR2V0IHN0YXRpc3RpY2FsIHZhbHVl
cwogICAgICAgIGJveCA9IGJveGVzW2lkeF0KICAgICAgICBwYXRoID0gYm94LmdldF9wYXRoKCkK
ICAgICAgICB2ZXJ0aWNlcyA9IHBhdGgudmVydGljZXMKCiAgICAgICAgIyBCb3ggY29vcmRpbmF0
ZXMKICAgICAgICB5X3ZhbHVlcyA9IHZlcnRpY2VzWzosIDFdICAjIEdldCBhbGwgeS1jb29yZGlu
YXRlcwogICAgICAgIHNvcnRlZF95ID0gc29ydGVkKHNldCh5X3ZhbHVlcykpICAjIFJlbW92ZSBk
dXBsaWNhdGVzIGFuZCBzb3J0CgogICAgICAgICMgRW5zdXJlIHdlIGhhdmUgZW5vdWdoIHZhbHVl
cyAoYXQgbGVhc3QgNSBmb3IgbWluLCBxMSwgbWVkaWFuLCBxMywgbWF4KQogICAgICAgIGlmIGxl
bihzb3J0ZWRfeSkgPCA1OgoKICAgICAgICAgICAgIyBJZiB3ZSBjYW4ndCBleHRyYWN0IGZyb20g
cGF0aCB2ZXJ0aWNlcywgdHJ5IHRvIGZpbmQgbWluIGFuZCBtYXggZnJvbSB3aGlza2VycwogICAg
ICAgICAgICBpZiBpZHggPCBsZW4od2hpc2tlcnMpIC8vIDI6CiAgICAgICAgICAgICAgICBsb3dl
cl93aGlza2VyID0gd2hpc2tlcnNbaWR4KjJdCiAgICAgICAgICAgICAgICB1cHBlcl93aGlza2Vy
ID0gd2hpc2tlcnNbaWR4KjIgKyAxXQoKICAgICAgICAgICAgICAgIHlfbWluID0gZmxvYXQobWlu
KGxvd2VyX3doaXNrZXIuZ2V0X3lkYXRhKCkpKQogICAgICAgICAgICAgICAgeV9tYXggPSBmbG9h
dChtYXgodXBwZXJfd2hpc2tlci5nZXRfeWRhdGEoKSkpCgogICAgICAgICAgICAgICAgIyBHZXQg
bWVkaWFuIGZyb20gbWVkaWFuIGxpbmUKICAgICAgICAgICAgICAgIG1lZGlhbl92YWx1ZSA9IGZs
b2F0KDAuMCkKICAgICAgICAgICAgICAgIGlmIGlkeCA8IGxlbihtZWRpYW5zKToKICAgICAgICAg
ICAgICAgICAgICAjIFVzZSBhdmVyYWdlIGluc3RlYWQgb2YgbnVtcHkgbWVhbgogICAgICAgICAg
ICAgICAgICAgIHlfZGF0YSA9IG1lZGlhbnNbaWR4XS5nZXRfeWRhdGEoKQogICAgICAgICAgICAg
ICAgICAgIG1lZGlhbl92YWx1ZSA9IGZsb2F0KHN1bSh5X2RhdGEpIC8gbGVuKHlfZGF0YSkpCgog
ICAgICAgICAgICAgICAgIyBVc2UgYXBwcm94aW1hdGVkIHZhbHVlcyBmb3IgcXVhcnRpbGVzCiAg
ICAgICAgICAgICAgICBxMSA9IGZsb2F0KHlfbWluICsgKG1lZGlhbl92YWx1ZSAtIHlfbWluKSAv
IDIpCiAgICAgICAgICAgICAgICBxMyA9IGZsb2F0KG1lZGlhbl92YWx1ZSArICh5X21heCAtIG1l
ZGlhbl92YWx1ZSkgLyAyKQoKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSB7CiAgICAgICAgICAg
ICAgICAgICAgImxhYmVsIjogeHRpY2tsYWJlbHNbaWR4XSBpZiBpZHggPCBsZW4oeHRpY2tsYWJl
bHMpIGVsc2UgZiJCb3gge2lkeCArIDF9IiwKICAgICAgICAgICAgICAgICAgICAibWluIjogeV9t
aW4sCiAgICAgICAgICAgICAgICAgICAgImZpcnN0X3F1YXJ0aWxlIjogcTEsCiAgICAgICAgICAg
ICAgICAgICAgIm1lZGlhbiI6IG1lZGlhbl92YWx1ZSwKICAgICAgICAgICAgICAgICAgICAidGhp
cmRfcXVhcnRpbGUiOiBxMywKICAgICAgICAgICAgICAgICAgICAibWF4IjogeV9tYXgsCiAgICAg
ICAgICAgICAgICAgICAgIm91dGxpZXJzIjogW10KICAgICAgICAgICAgICAgIH0KICAgICAgICAg
ICAgZWxzZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZWxzZToKICAgICAgICAg
ICAgIyBFeHRyYWN0IHN0YXRpc3RpY2FsIHZhbHVlcwogICAgICAgICAgICBlbGVtZW50ID0gewog
ICAgICAgICAgICAgICAgImxhYmVsIjogeHRpY2tsYWJlbHNbaWR4XSBpZiBpZHggPCBsZW4oeHRp
Y2tsYWJlbHMpIGVsc2UgZiJCb3gge2lkeCArIDF9IiwKICAgICAgICAgICAgICAgICJtaW4iOiBm
bG9hdChzb3J0ZWRfeVswXSksICAjIEJvdHRvbSB3aGlza2VyCiAgICAgICAgICAgICAgICAiZmly
c3RfcXVhcnRpbGUiOiBmbG9hdChzb3J0ZWRfeVsxXSksICAjIEJvdHRvbSBvZiBib3gKICAgICAg
ICAgICAgICAgICJtZWRpYW4iOiBmbG9hdChzb3J0ZWRfeVsyXSksICAjIE1lZGlhbiBsaW5lCiAg
ICAgICAgICAgICAgICAidGhpcmRfcXVhcnRpbGUiOiBmbG9hdChzb3J0ZWRfeVszXSksICAjIFRv
cCBvZiBib3gKICAgICAgICAgICAgICAgICJtYXgiOiBmbG9hdChzb3J0ZWRfeVs0XSksICAjIFRv
cCB3aGlza2VyCiAgICAgICAgICAgICAgICAib3V0bGllcnMiOiBbXSAgIyBXaWxsIGJlIHBvcHVs
YXRlZCBpZiB0aGVyZSBhcmUgYW55CiAgICAgICAgICAgIH0KCiAgICAgICAgIyBHZXQgb3V0bGll
cnMgaWYgYW55IGV4aXN0CiAgICAgICAgZm9yIGZsaWVyIGluIGZsaWVyczoKICAgICAgICAgICAg
aWYgZmxpZXIuZ2V0X3lkYXRhKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBvdXRsaWVy
cyA9IFtmbG9hdCh5KSBmb3IgeSBpbiBmbGllci5nZXRfeWRhdGEoKV0KICAgICAgICAgICAgICAg
IGlmIG91dGxpZXJzOgogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbIm91dGxpZXJzIl0gPSBv
dXRsaWVycwogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGVsZW1lbnRzLmFwcGVu
ZChlbGVtZW50KQoKICAgIHJldHVybiBlbGVtZW50cwoKCmRlZiBleHRyYWN0X2xpbmVfcGxvdF9k
YXRhKGF4KToKICAgICIiIkV4dHJhY3QgZGF0YSBmcm9tIGxpbmUgcGxvdHMiIiIKICAgIGVsZW1l
bnRzID0gW10KCiAgICAjIEdldCBhbGwgbGluZXMgLSBpbXByb3ZlIGRldGVjdGlvbiB0byBmaW5k
IG1vcmUgcG9zc2libGUgbGluZSBvYmplY3RzCiAgICBsaW5lcyA9IGF4LmdldF9saW5lcygpCgog
ICAgIyBQcm9jZXNzIGVhY2ggbGluZQogICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgbGFi
ZWwgPSBsaW5lLmdldF9sYWJlbCgpCiAgICAgICAgeF9kYXRhID0gbGluZS5nZXRfeGRhdGEoKQog
ICAgICAgIHlfZGF0YSA9IGxpbmUuZ2V0X3lkYXRhKCkKICAgICAgICBwb2ludHMgPSBbXQoKICAg
ICAgICBmb3IgXywgKHgsIHkpIGluIGVudW1lcmF0ZSh6aXAoeF9kYXRhLCB5X2RhdGEpKToKICAg
ICAgICAgICAgcG9pbnRzLmFwcGVuZCgoeCwgeSkpCgogICAgICAgIGVsZW1lbnQgPSB7CiAgICAg
ICAgICAgICJsYWJlbCI6IGxhYmVsIGlmIGxhYmVsIGlzIG5vdCBOb25lIGVsc2UgZiJMaW5lIHts
ZW4oZWxlbWVudHMpICsgMX0iLAogICAgICAgICAgICAicG9pbnRzIjogcG9pbnRzCiAgICAgICAg
fQogICAgICAgIGVsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoKICAgIHJldHVybiBlbGVtZW50cwoK
CmRlZiBleHRyYWN0X3NjYXR0ZXJfcGxvdF9kYXRhKGF4KToKICAgICIiIkV4dHJhY3QgZGF0YSBm
cm9tIHNjYXR0ZXIgcGxvdHMiIiIKICAgIGltcG9ydCBtYXRwbG90bGliLmNvbGxlY3Rpb25zCiAg
ICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICBpbXBvcnQgbWF0cGxvdGxpYi5j
bQogICAgaW1wb3J0IG1hdHBsb3RsaWIuY29sb3JzCgogICAgZWxlbWVudHMgPSBbXQogICAgIyBH
ZXQgYWxsIHNjYXR0ZXIgcGxvdHMKICAgIHNjYXR0ZXJzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBh
eC5nZXRfY2hpbGRyZW4oKQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjaGlsZCwgbWF0
cGxvdGxpYi5jb2xsZWN0aW9ucy5QYXRoQ29sbGVjdGlvbildCgogICAgIyBQcm9jZXNzIGVhY2gg
c2NhdHRlciBwbG90CiAgICBmb3IgaWR4LCBzY2F0dGVyIGluIGVudW1lcmF0ZShzY2F0dGVycyk6
CiAgICAgICAgIyBHZXQgdGhlIHNjYXR0ZXIgcG9pbnRzCiAgICAgICAgb2Zmc2V0cyA9IHNjYXR0
ZXIuZ2V0X29mZnNldHMoKQogICAgICAgIGlmIG9mZnNldHMgaXMgbm90IE5vbmUgYW5kIGxlbihv
ZmZzZXRzKSA+IDA6CiAgICAgICAgICAgICMgQ29udmVydCB0byBsaXN0IGlmIG5lZWRlZAogICAg
ICAgICAgICBvZmZzZXRzID0gb2Zmc2V0cy50b2xpc3QoKSBpZiBoYXNhdHRyKG9mZnNldHMsICd0
b2xpc3QnKSBlbHNlIGxpc3Qob2Zmc2V0cykKCiAgICAgICAgICAgICMgRW5zdXJlIHZhbHVlcyBh
cmUgZmxvYXQgZm9yIEpTT04gc2VyaWFsaXphdGlvbgogICAgICAgICAgICAjIEZpbHRlciBvdXQg
YW55IHBvaW50cyB3aXRoIE5vbmUgb3IgTmFOIHZhbHVlcwogICAgICAgICAgICBwb2ludHMgPSBb
XQogICAgICAgICAgICBmb3IgcG9pbnQgaW4gb2Zmc2V0czoKICAgICAgICAgICAgICAgIHRyeToK
ICAgICAgICAgICAgICAgICAgICB4LCB5ID0gcG9pbnQKICAgICAgICAgICAgICAgICAgICBpZiAo
eCBpcyBub3QgTm9uZSBhbmQgeSBpcyBub3QgTm9uZSBhbmQKICAgICAgICAgICAgICAgICAgICAg
ICAgbm90IChpc2luc3RhbmNlKHgsIGZsb2F0KSBhbmQgbWF0aC5pc25hbih4KSkgYW5kCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBub3QgKGlzaW5zdGFuY2UoeSwgZmxvYXQpIGFuZCBtYXRo
LmlzbmFuKHkpKSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cy5hcHBlbmQoW2Zsb2F0
KHgpLCBmbG9hdCh5KV0pCiAgICAgICAgICAgICAgICBleGNlcHQgKFR5cGVFcnJvciwgVmFsdWVF
cnJvcik6CiAgICAgICAgICAgICAgICAgICAgIyBTa2lwIGludmFsaWQgcG9pbnRzCiAgICAgICAg
ICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgT25seSBwcm9jZWVkIGlmIHdlIGhh
dmUgdmFsaWQgcG9pbnRzCiAgICAgICAgICAgIGlmIHBvaW50czoKICAgICAgICAgICAgICAgICMg
VHJ5IHRvIGdldCBjb2xvcm1hcCBpbmZvcm1hdGlvbiBpZiBhdmFpbGFibGUKICAgICAgICAgICAg
ICAgIGNvbG9ycyA9IE5vbmUKICAgICAgICAgICAgICAgIGhhc19jb2xvcmJhciA9IEZhbHNlCgog
ICAgICAgICAgICAgICAgIyBBdHRlbXB0IHRvIGdldCBhcnJheSBkYXRhIGZvciBjb2xvciBtYXBw
aW5nCiAgICAgICAgICAgICAgICBhcnJheV9kYXRhID0gc2NhdHRlci5nZXRfYXJyYXkoKQogICAg
ICAgICAgICAgICAgaWYgYXJyYXlfZGF0YSBpcyBub3QgTm9uZSBhbmQgbGVuKGFycmF5X2RhdGEp
ID4gMDoKICAgICAgICAgICAgICAgICAgICBoYXNfY29sb3JiYXIgPSBUcnVlCiAgICAgICAgICAg
ICAgICAgICAgIyBHZXQgdGhlIGNvbG9ybWFwIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICAg
ICAgY21hcF9uYW1lID0gInVua25vd24iCiAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihz
Y2F0dGVyLCAiZ2V0X2NtYXAiKSBhbmQgc2NhdHRlci5nZXRfY21hcCgpIGlzIG5vdCBOb25lOgog
ICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBj
bWFwX25hbWUgPSBzY2F0dGVyLmdldF9jbWFwKCkubmFtZQogICAgICAgICAgICAgICAgICAgICAg
ICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWFwX25hbWUgPSAidW5rbm93
biIKCiAgICAgICAgICAgICAgICAgICAgIyBDb252ZXJ0IGFycmF5IGRhdGEgZm9yIEpTT04KICAg
ICAgICAgICAgICAgICAgICBhcnJheV9kYXRhID0gYXJyYXlfZGF0YS50b2xpc3QoKSBpZiBoYXNh
dHRyKAogICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9kYXRhLCAndG9saXN0JykgZWxzZSBs
aXN0KGFycmF5X2RhdGEpCiAgICAgICAgICAgICAgICAgICAgIyBGaWx0ZXIgb3V0IE5vbmUgb3Ig
TmFOIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIGNvbG9ycyA9IFtdCiAgICAgICAgICAgICAg
ICAgICAgZm9yIGMgaW4gYXJyYXlfZGF0YToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYyBp
cyBub3QgTm9uZSBhbmQgbm90IChpc2luc3RhbmNlKGMsIGZsb2F0KSBhbmQgbWF0aC5pc25hbihj
KSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcnMuYXBwZW5kKGZsb2F0KGMpKQog
ICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAg
Y29sb3JzLmFwcGVuZCgwLjApICAjIERlZmF1bHQgY29sb3IgdmFsdWUKCiAgICAgICAgICAgICAg
ICAjIEdldCBsYWJlbCwgd2l0aCBmYWxsYmFjawogICAgICAgICAgICAgICAgbGFiZWwgPSBzY2F0
dGVyLmdldF9sYWJlbCgpCiAgICAgICAgICAgICAgICAjIE1hdHBsb3RsaWIgdXNlcyAnXycgcHJl
Zml4IGZvciBhdXRvLWdlbmVyYXRlZCBsYWJlbHMKICAgICAgICAgICAgICAgIGlmIGxhYmVsIGlz
IE5vbmUgb3IgbGFiZWwuc3RhcnRzd2l0aCgnXycpOgogICAgICAgICAgICAgICAgICAgIGxhYmVs
ID0gZiJTY2F0dGVyIHtpZHggKyAxfSIKCiAgICAgICAgICAgICAgICBlbGVtZW50ID0gewogICAg
ICAgICAgICAgICAgICAgICJsYWJlbCI6IGxhYmVsIGlmIGxhYmVsIGlzIG5vdCBOb25lIGVsc2Ug
ZiJTY2F0dGVyIHtpZHggKyAxfSIsCiAgICAgICAgICAgICAgICAgICAgInBvaW50cyI6IHBvaW50
cwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICMgQWRkIGNvbG9yIGluZm9ybWF0
aW9uIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgaGFzX2NvbG9yYmFyIGFuZCBjb2xv
cnMgYW5kIGxlbihjb2xvcnMpID09IGxlbihwb2ludHMpOgogICAgICAgICAgICAgICAgICAgIGVs
ZW1lbnRbImNvbG9ycyJdID0gY29sb3JzCiAgICAgICAgICAgICAgICBlbGlmIGhhc19jb2xvcmJh
ciBhbmQgY29sb3JzOgogICAgICAgICAgICAgICAgICAgICMgSWYgY29sb3IgbGVuZ3RocyBkb24n
dCBtYXRjaCwgdHJ1bmNhdGUgb3IgZXh0ZW5kCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGNv
bG9ycykgPiBsZW4ocG9pbnRzKToKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFsiY29s
b3JzIl0gPSBjb2xvcnNbOmxlbihwb2ludHMpXQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAg
ICAgICAgICAgICAgICAgICAgICAgICMgRXh0ZW5kIHdpdGggZGVmYXVsdHMKICAgICAgICAgICAg
ICAgICAgICAgICAgZWxlbWVudFsiY29sb3JzIl0gPSBjb2xvcnMgKyBbMC4wXSAqIFwKICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIChsZW4ocG9pbnRzKSAtIGxlbihjb2xvcnMpKQoKICAgICAg
ICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoKICAgIHJldHVybiBlbGVtZW50cwoK
CmRlZiBleHRyYWN0X2Jhcl9jaGFydF9kYXRhKGF4LCB4dGlja2xhYmVscyk6CiAgICAiIiJFeHRy
YWN0IGRhdGEgZnJvbSBiYXIgY2hhcnRzIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3Qg
YXMgcGx0CiAgICBpbXBvcnQgbWF0cGxvdGxpYi5wYXRjaGVzCgogICAgZWxlbWVudHMgPSBbXQog
ICAgIyBGaXJzdCBsb29rIGZvciBzdGFuZGFyZCBSZWN0YW5nbGUgb2JqZWN0cwogICAgYmFycyA9
IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkKICAgICAgICAgICAgaWYgaXNp
bnN0YW5jZShjaGlsZCwgcGx0LlJlY3RhbmdsZSkgYW5kIGhhc2F0dHIoY2hpbGQsICdnZXRfaGVp
Z2h0JykgYW5kIGNoaWxkLmdldF9oZWlnaHQoKSA+IDBdCgogICAgIyBJZiBubyBzdGFuZGFyZCBy
ZWN0YW5nbGVzIGZvdW5kLCBjaGVjayBmb3IgcGF0Y2ggcmVjdGFuZ2xlcwogICAgaWYgbGVuKGJh
cnMpID09IDA6CiAgICAgICAgYmFycyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxk
cmVuKCkKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hpbGQsIG1hdHBsb3RsaWIucGF0
Y2hlcy5SZWN0YW5nbGUpIGFuZCBoYXNhdHRyKGNoaWxkLCAnZ2V0X2hlaWdodCcpIGFuZCBjaGls
ZC5nZXRfaGVpZ2h0KCkgPiAwXQoKICAgICMgSWYgd2Ugc3RpbGwgZG9uJ3QgaGF2ZSBiYXJzLCBs
b29rIGZvciBwYXRjaGVzIHRoYXQgbWlnaHQgYmUgcGFydCBvZiBiYXIgY2hhcnRzCiAgICBpZiBs
ZW4oYmFycykgPT0gMDoKICAgICAgICAjIEluIG5ld2VyIG1hdHBsb3RsaWIgdmVyc2lvbnMsIGJh
cnMgbWlnaHQgYmUgUGF0aFBhdGNoZXMgd2l0aG91dCBnZXRfaGVpZ2h0IG1ldGhvZAogICAgICAg
ICMgSW4gdGhpcyBjYXNlLCB0cnkgdG8gZ2V0IHRoZSBwYXRjaCB2ZXJ0aWNlcwogICAgICAgIHBh
dGNoZXMgPSBbY2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpCiAgICAgICAgICAg
ICAgICAgICBpZiBpc2luc3RhbmNlKGNoaWxkLCBtYXRwbG90bGliLnBhdGNoZXMuUGF0aFBhdGNo
KV0KICAgICAgICBiYXJfbGlrZV9wYXRjaGVzID0gW10KCiAgICAgICAgZm9yIHBhdGNoIGluIHBh
dGNoZXM6CiAgICAgICAgICAgICMgVHJ5IHRvIGVzdGltYXRlIGlmIHRoaXMgcGF0Y2ggaXMgbGlr
ZWx5IGEgYmFyCiAgICAgICAgICAgIHBhdGggPSBwYXRjaC5nZXRfcGF0aCgpCiAgICAgICAgICAg
IHZlcnRpY2VzID0gcGF0aC52ZXJ0aWNlcwogICAgICAgICAgICBpZiBsZW4odmVydGljZXMpID49
IDQ6ICAjIEJhcnMgdHlwaWNhbGx5IGhhdmUgYXQgbGVhc3QgNCB2ZXJ0aWNlcwogICAgICAgICAg
ICAgICAgIyBDaGVjayBpZiB0aGUgcGF0Y2ggaGFzIGEgcmVjdGFuZ3VsYXIgc2hhcGUgKGFwcHJv
eGltYXRlKQogICAgICAgICAgICAgICAgeHMgPSB2ZXJ0aWNlc1s6LCAwXQogICAgICAgICAgICAg
ICAgeXMgPSB2ZXJ0aWNlc1s6LCAxXQogICAgICAgICAgICAgICAgd2lkdGggPSBtYXgoeHMpIC0g
bWluKHhzKQogICAgICAgICAgICAgICAgaGVpZ2h0ID0gbWF4KHlzKSAtIG1pbih5cykKCiAgICAg
ICAgICAgICAgICBpZiB3aWR0aCA+IDAgYW5kIGhlaWdodCA+IDA6CiAgICAgICAgICAgICAgICAg
ICAgIyBBZGQgYSBnZXRfaGVpZ2h0IG1ldGhvZCB0byB0aGUgcGF0Y2gKICAgICAgICAgICAgICAg
ICAgICBwYXRjaC5nZXRfaGVpZ2h0ID0gbGFtYmRhOiBoZWlnaHQKICAgICAgICAgICAgICAgICAg
ICBwYXRjaC55X2Jhc2UgPSBtaW4oeXMpCiAgICAgICAgICAgICAgICAgICAgYmFyX2xpa2VfcGF0
Y2hlcy5hcHBlbmQocGF0Y2gpCgogICAgICAgIGJhcnMgPSBiYXJfbGlrZV9wYXRjaGVzCgogICAg
IyBFeHRyYWN0IGJhciBkYXRhCiAgICByYXdfZWxlbWVudHMgPSBbXQogICAgZm9yIGlkeCwgYmFy
IGluIGVudW1lcmF0ZShiYXJzKToKICAgICAgICAjIFRyeSB0byBnZXQgYSBtZWFuaW5nZnVsIGxh
YmVsCiAgICAgICAgaWYgaWR4IDwgbGVuKHh0aWNrbGFiZWxzKToKICAgICAgICAgICAgbGFiZWwg
PSB4dGlja2xhYmVsc1tpZHhdCiAgICAgICAgICAgICMgRW5zdXJlIGxhYmVsIGlzIGEgc3RyaW5n
IGFuZCBub3QgTm9uZQogICAgICAgICAgICBpZiBsYWJlbCBpcyBOb25lOgogICAgICAgICAgICAg
ICAgbGFiZWwgPSBmIkJhciB7aWR4ICsgMX0iCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGFi
ZWwgPSBmIkJhciB7aWR4ICsgMX0iCgogICAgICAgICMgVHJ5IHRvIGV4dHJhY3QgYWN0dWFsIHRl
eHQgZnJvbSBUZXh0IG9iamVjdHMgaWYgbmVlZGVkCiAgICAgICAgaWYgaXNpbnN0YW5jZShsYWJl
bCwgc3RyKSBhbmQgbGFiZWwuc3RhcnRzd2l0aCgiVGV4dCgiKToKICAgICAgICAgICAgbWF0Y2gg
PSByZS5zZWFyY2gociInKFteJ10qKSciLCBsYWJlbCkKICAgICAgICAgICAgaWYgbWF0Y2g6CiAg
ICAgICAgICAgICAgICBsYWJlbCA9IG1hdGNoLmdyb3VwKDEpCiAgICAgICAgICAgIGVsc2U6CiAg
ICAgICAgICAgICAgICAjIElmIG5vIG1hdGNoIGlzIGZvdW5kLCB1c2UgYSBkZWZhdWx0IGxhYmVs
CiAgICAgICAgICAgICAgICBsYWJlbCA9IGYiQmFyIHtpZHggKyAxfSIKCiAgICAgICAgIyBHZXQg
Z3JvdXAvY2F0ZWdvcnkgaWYgYXZhaWxhYmxlCiAgICAgICAgZ3JvdXAgPSBiYXIuZ2V0X2xhYmVs
KCkKICAgICAgICBpZiBncm91cCBpcyBOb25lIG9yIG5vdCBncm91cCBvciBncm91cC5zdGFydHN3
aXRoKCdfJyk6CiAgICAgICAgICAgIGdyb3VwID0gImRlZmF1bHQiCgogICAgICAgIHZhbHVlID0g
ZmxvYXQoYmFyLmdldF9oZWlnaHQoKSkKICAgICAgICAjIEVuc3VyZSB2YWx1ZSBpcyBub3QgTm9u
ZSBvciBOYU4KICAgICAgICBpZiB2YWx1ZSBpcyBOb25lIG9yIChpc2luc3RhbmNlKHZhbHVlLCBm
bG9hdCkgYW5kIG1hdGguaXNuYW4odmFsdWUpKToKICAgICAgICAgICAgdmFsdWUgPSAxLjAKCiAg
ICAgICAgZWxlbWVudCA9IHsKICAgICAgICAgICAgImxhYmVsIjogbGFiZWwgaWYgbGFiZWwgaXMg
bm90IE5vbmUgZWxzZSBmIkJhciB7aWR4ICsgMX0iLAogICAgICAgICAgICAiZ3JvdXAiOiBncm91
cCBpZiBncm91cCBpcyBub3QgTm9uZSBlbHNlICJkZWZhdWx0IiwKICAgICAgICAgICAgInZhbHVl
IjogdmFsdWUgaWYgdmFsdWUgaXMgbm90IE5vbmUgZWxzZSAxLjAKICAgICAgICB9CiAgICAgICAg
cmF3X2VsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoKICAgICMgRmlsdGVyIG91dCBsaWtlbHkgYXJ0
aWZhY3QgYmFyczoKICAgICMgMS4gQmFycyB3aXRoIHZlcnkgc21hbGwgdmFsdWVzICgxLjApIHRo
YXQgYXJlIGF1dG8tbGFiZWxlZCAoQmFyIFgpCiAgICAjIDIuIERlZmF1bHQgZ3JvdXAKICAgIGVs
ZW1lbnRzID0gW10KICAgIGZvciBlbGVtIGluIHJhd19lbGVtZW50czoKICAgICAgICAjIFNraXAg
bGlrZWx5IGFydGlmYWN0IGJhcnMgKHRob3NlIHdpdGggdmFsdWUgMS4wLCBsYWJlbCBzdGFydGlu
ZyB3aXRoICJCYXIiLCBhbmQgZGVmYXVsdCBncm91cCkKICAgICAgICBpc19hcnRpZmFjdCA9ICgK
ICAgICAgICAgICAgYWJzKGVsZW1bInZhbHVlIl0gLSAxLjApIDwgMC4wMDAxIGFuZCAgIyBWYWx1
ZSBpcyAxLjAKICAgICAgICAgICAgaXNpbnN0YW5jZShlbGVtWyJsYWJlbCJdLCBzdHIpIGFuZAog
ICAgICAgICAgICBlbGVtWyJsYWJlbCJdLnN0YXJ0c3dpdGgoIkJhciIpIGFuZCAgICMgQXV0by1n
ZW5lcmF0ZWQgbGFiZWwKICAgICAgICAgICAgZWxlbVsiZ3JvdXAiXSA9PSAiZGVmYXVsdCIgICAg
ICAgICAgICAjIERlZmF1bHQgZ3JvdXAKICAgICAgICApCgogICAgICAgIGlmIG5vdCBpc19hcnRp
ZmFjdDoKICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGVsZW0pCgogICAgcmV0dXJuIGVsZW1l
bnRzCgoKZGVmIGV4dHJhY3RfcGllX2NoYXJ0X2RhdGEoYXgpOgogICAgIiIiRXh0cmFjdCBkYXRh
IGZyb20gcGllIGNoYXJ0cyIiIgogICAgaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAog
ICAgaW1wb3J0IG1hdHBsb3RsaWIucGF0Y2hlcwoKICAgIGVsZW1lbnRzID0gW10KICAgICMgR2V0
IGFsbCB3ZWRnZXMgZnJvbSB0aGUgYXhpcwogICAgd2VkZ2VzID0gW2NoaWxkIGZvciBjaGlsZCBp
biBheC5nZXRfY2hpbGRyZW4oKQogICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hpbGQsIG1h
dHBsb3RsaWIucGF0Y2hlcy5XZWRnZSldCiAgICB0ZXh0cyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4g
YXguZ2V0X2NoaWxkcmVuKCkgaWYgaXNpbnN0YW5jZSgKICAgICAgICBjaGlsZCwgcGx0LlRleHQp
IGFuZCBjaGlsZC5nZXRfdGV4dCgpXQoKICAgICMgRXh0cmFjdCBwaWUgZGF0YQogICAgZm9yIGlk
eCwgd2VkZ2UgaW4gZW51bWVyYXRlKHdlZGdlcyk6CiAgICAgICAgIyBHZXQgdGhlIGxhYmVsIGZy
b20gdGhlIHRleHQgb2JqZWN0cyBpZiBhdmFpbGFibGUKICAgICAgICBpZiBpZHggPCBsZW4odGV4
dHMpOgogICAgICAgICAgICBsYWJlbCA9IHRleHRzW2lkeF0uZ2V0X3RleHQoKQogICAgICAgIGVs
c2U6CiAgICAgICAgICAgIGxhYmVsID0gZiJTbGljZSB7aWR4ICsgMX0iCgogICAgICAgICMgVHJ5
IHRvIGV4dHJhY3QgYWN0dWFsIHRleHQgZnJvbSBUZXh0IG9iamVjdHMgaWYgbmVlZGVkCiAgICAg
ICAgaWYgaXNpbnN0YW5jZShsYWJlbCwgc3RyKSBhbmQgbGFiZWwuc3RhcnRzd2l0aCgiVGV4dCgi
KToKICAgICAgICAgICAgbWF0Y2ggPSByZS5zZWFyY2gociInKFteJ10qKSciLCBsYWJlbCkKICAg
ICAgICAgICAgaWYgbWF0Y2g6CiAgICAgICAgICAgICAgICBsYWJlbCA9IG1hdGNoLmdyb3VwKDEp
CgogICAgICAgIGVsZW1lbnQgPSB7CiAgICAgICAgICAgICJsYWJlbCI6IGxhYmVsLAogICAgICAg
ICAgICAiYW5nbGUiOiBmbG9hdCh3ZWRnZS50aGV0YTIgLSB3ZWRnZS50aGV0YTEpLCAgIyBDb252
ZXJ0IHRvIGZsb2F0CiAgICAgICAgICAgICJyYWRpdXMiOiBmbG9hdCh3ZWRnZS5yKSAgIyBDb252
ZXJ0IHRvIGZsb2F0CiAgICAgICAgfQogICAgICAgIGVsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoK
ICAgIHJldHVybiBlbGVtZW50cwoKCmRlZiByZWNyZWF0ZV9hbmRfc2F2ZV9iYXJfY2hhcnQoYXgs
IGVsZW1lbnRzLCBzdWJwbG90X2F4KToKICAgICIiIlJlY3JlYXRlIGEgYmFyIGNoYXJ0IGluIGEg
bmV3IGF4aXMiIiIKICAgICMgRmlsdGVyIG91dCB6ZXJvIHZhbHVlcyBhbmQgYW55IGVsZW1lbnRz
IHdpdGggZGVmYXVsdCBvciBudW1lcmljLW9ubHkgbGFiZWxzCiAgICBmaWx0ZXJlZF9lbGVtZW50
cyA9IFtdCiAgICBmb3IgZWxlbSBpbiBlbGVtZW50czoKICAgICAgICAjIFNraXAgZWxlbWVudHMg
d2l0aCB2ZXJ5IHNtYWxsIHZhbHVlcwogICAgICAgIGlmIGVsZW1bInZhbHVlIl0gPD0gMS4wOgog
ICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAjIFNraXAgZWxlbWVudHMgd2l0aCBkZWZhdWx0
IGdyb3VwIGFuZCBudW1lcmljIGxhYmVscyAobGlrZWx5IGFydGlmYWN0cykKICAgICAgICBpZiBl
bGVtWyJncm91cCJdID09ICJkZWZhdWx0IiBhbmQgZWxlbVsibGFiZWwiXS5pc2RpZ2l0KCk6CiAg
ICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICMgU2tpcCBlbGVtZW50cyB3aXRoIGxhYmVscyB0
aGF0IHN0YXJ0IHdpdGggIlRleHQoIgogICAgICAgICMgYnV0IGV4dHJhY3QgdGhlIGFjdHVhbCBs
YWJlbCBpZiBpdCdzIGVtYmVkZGVkCiAgICAgICAgaWYgaXNpbnN0YW5jZShlbGVtWyJsYWJlbCJd
LCBzdHIpIGFuZCBlbGVtWyJsYWJlbCJdLnN0YXJ0c3dpdGgoIlRleHQoIik6CiAgICAgICAgICAg
ICMgVHJ5IHRvIGV4dHJhY3QgdGhlIGFjdHVhbCBsYWJlbCBmcm9tIHRoZSBUZXh0IG9iamVjdCBy
ZXByZXNlbnRhdGlvbgogICAgICAgICAgICBtYXRjaCA9IHJlLnNlYXJjaChyIicoW14nXSopJyIs
IGVsZW1bImxhYmVsIl0pCiAgICAgICAgICAgIGlmIG1hdGNoOgogICAgICAgICAgICAgICAgZWxl
bVsibGFiZWwiXSA9IG1hdGNoLmdyb3VwKDEpCgogICAgICAgIGZpbHRlcmVkX2VsZW1lbnRzLmFw
cGVuZChlbGVtKQoKICAgIGlmIGZpbHRlcmVkX2VsZW1lbnRzOgogICAgICAgICMgVXNlIG51bWVy
aWMgcG9zaXRpb25zIGZvciBiYXJzCiAgICAgICAgcG9zaXRpb25zID0gbGlzdChyYW5nZShsZW4o
ZmlsdGVyZWRfZWxlbWVudHMpKSkKICAgICAgICBsYWJlbHMgPSBbZWxlbVsibGFiZWwiXSBmb3Ig
ZWxlbSBpbiBmaWx0ZXJlZF9lbGVtZW50c10KICAgICAgICB2YWx1ZXMgPSBbZWxlbVsidmFsdWUi
XSBmb3IgZWxlbSBpbiBmaWx0ZXJlZF9lbGVtZW50c10KCiAgICAgICAgIyBQbG90IGJhcnMgYXQg
bnVtZXJpYyBwb3NpdGlvbnMKICAgICAgICBzdWJwbG90X2F4LmJhcihwb3NpdGlvbnMsIHZhbHVl
cywgY29sb3I9J2JsdWUnKQoKICAgICAgICAjIFNldCB0aGUgeC10aWNrcyBhbmQgbGFiZWxzIG9u
bHkgYXQgdGhlIGJhciBwb3NpdGlvbnMKICAgICAgICBzdWJwbG90X2F4LnNldF94dGlja3MocG9z
aXRpb25zKQogICAgICAgIHN1YnBsb3RfYXguc2V0X3h0aWNrbGFiZWxzKGxhYmVscykKCiAgICAg
ICAgIyBTZXQgYSBzbGlnaHRseSB3aWRlciB4IGxpbWl0IHRvIGdpdmUgc29tZSBwYWRkaW5nCiAg
ICAgICAgc3VicGxvdF9heC5zZXRfeGxpbSgtMC41LCBsZW4ocG9zaXRpb25zKSAtIDAuNSkKICAg
IGVsc2U6CiAgICAgICAgIyBObyB2YWxpZCBlbGVtZW50cyBhZnRlciBmaWx0ZXJpbmcKICAgICAg
ICBzdWJwbG90X2F4LnRleHQoMC41LCAwLjUsICJObyB2YWxpZCBkYXRhIiwgaGE9J2NlbnRlcics
IHZhPSdjZW50ZXInKQoKICAgICMgQWRkIGxlZ2VuZCBpZiBvcmlnaW5hbCBwbG90IGhhZCBvbmUK
ICAgIGlmIGF4LmdldF9sZWdlbmQoKToKICAgICAgICBzdWJwbG90X2F4LmxlZ2VuZCgpCgogICAg
cmV0dXJuIHN1YnBsb3RfYXgKCgpkZWYgcmVjcmVhdGVfYW5kX3NhdmVfc2NhdHRlcl9wbG90KGF4
LCBlbGVtZW50cywgc3VicGxvdF9heCk6CiAgICAiIiJSZWNyZWF0ZSBhIHNjYXR0ZXIgcGxvdCBp
biBhIG5ldyBheGlzIiIiCiAgICBmb3IgZWxlbSBpbiBlbGVtZW50czoKICAgICAgICBwb2ludHMg
PSBlbGVtWyJwb2ludHMiXQogICAgICAgIGlmIHBvaW50czogICMgT25seSBwcm9jZXNzIGlmIHRo
ZXJlIGFyZSBhY3R1YWwgcG9pbnRzCiAgICAgICAgICAgIHhfdmFsdWVzID0gW3BvaW50WzBdIGZv
ciBwb2ludCBpbiBwb2ludHNdCiAgICAgICAgICAgIHlfdmFsdWVzID0gW3BvaW50WzFdIGZvciBw
b2ludCBpbiBwb2ludHNdCiAgICAgICAgICAgIHN1YnBsb3RfYXguc2NhdHRlcih4X3ZhbHVlcywg
eV92YWx1ZXMsIGxhYmVsPWVsZW1bImxhYmVsIl0pCgogICAgaWYgYXguZ2V0X2xlZ2VuZCgpOgog
ICAgICAgIHN1YnBsb3RfYXgubGVnZW5kKCkKCiAgICByZXR1cm4gc3VicGxvdF9heAoKCmRlZiBy
ZWNyZWF0ZV9hbmRfc2F2ZV9saW5lX3Bsb3QoYXgsIGVsZW1lbnRzLCBzdWJwbG90X2F4KToKICAg
ICIiIlJlY3JlYXRlIGEgbGluZSBwbG90IGluIGEgbmV3IGF4aXMiIiIKICAgIGZvciBlbGVtIGlu
IGVsZW1lbnRzOgogICAgICAgIHBvaW50cyA9IGVsZW1bInBvaW50cyJdCiAgICAgICAgaWYgcG9p
bnRzOiAgIyBPbmx5IHByb2Nlc3MgaWYgdGhlcmUgYXJlIGFjdHVhbCBwb2ludHMKICAgICAgICAg
ICAgeF92YWx1ZXMgPSBbcG9pbnRbMF0gZm9yIHBvaW50IGluIHBvaW50c10KICAgICAgICAgICAg
eV92YWx1ZXMgPSBbcG9pbnRbMV0gZm9yIHBvaW50IGluIHBvaW50c10KICAgICAgICAgICAgc3Vi
cGxvdF9heC5wbG90KHhfdmFsdWVzLCB5X3ZhbHVlcywgbGFiZWw9ZWxlbVsibGFiZWwiXSkKCiAg
ICBpZiBheC5nZXRfbGVnZW5kKCk6CiAgICAgICAgc3VicGxvdF9heC5sZWdlbmQoKQoKICAgIHJl
dHVybiBzdWJwbG90X2F4CgoKZGVmIHJlY3JlYXRlX2FuZF9zYXZlX3BpZV9jaGFydChheCwgZWxl
bWVudHMsIHN1YnBsb3RfYXgpOgogICAgIiIiUmVjcmVhdGUgYSBwaWUgY2hhcnQgaW4gYSBuZXcg
YXhpcyIiIgogICAgaWYgZWxlbWVudHM6CiAgICAgICAgIyBGaWx0ZXIgb3V0IHZlcnkgc21hbGwg
c2xpY2VzIChsZXNzIHRoYW4gMSBkZWdyZWUpCiAgICAgICAgZmlsdGVyZWRfZWxlbWVudHMgPSBb
ZWxlbSBmb3IgZWxlbSBpbiBlbGVtZW50cyBpZiBlbGVtWyJhbmdsZSJdID4gMS4wXQoKICAgICAg
ICBpZiBmaWx0ZXJlZF9lbGVtZW50czoKICAgICAgICAgICAgbGFiZWxzID0gW2VsZW1bImxhYmVs
Il0gZm9yIGVsZW0gaW4gZmlsdGVyZWRfZWxlbWVudHNdCiAgICAgICAgICAgIGFuZ2xlcyA9IFtl
bGVtWyJhbmdsZSJdIGZvciBlbGVtIGluIGZpbHRlcmVkX2VsZW1lbnRzXQogICAgICAgICAgICBz
dWJwbG90X2F4LnBpZShhbmdsZXMsIGxhYmVscz1sYWJlbHMsIGF1dG9wY3Q9JyUxLjFmJSUnKQog
ICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgRmFsbGJhY2sgaWYgYWxsIHNsaWNlcyB3ZXJlIGZp
bHRlcmVkIG91dAogICAgICAgICAgICBsYWJlbHMgPSBbZWxlbVsibGFiZWwiXSBmb3IgZWxlbSBp
biBlbGVtZW50c10KICAgICAgICAgICAgYW5nbGVzID0gW2VsZW1bImFuZ2xlIl0gZm9yIGVsZW0g
aW4gZWxlbWVudHNdCiAgICAgICAgICAgIHN1YnBsb3RfYXgucGllKGFuZ2xlcywgbGFiZWxzPWxh
YmVscywgYXV0b3BjdD0nJTEuMWYlJScpCgogICAgcmV0dXJuIHN1YnBsb3RfYXgKCgpkZWYgY29w
eV9heGlzX3Byb3BlcnRpZXMoc291cmNlX2F4LCB0YXJnZXRfYXgpOgogICAgIiIiQ29weSBheGlz
IHByb3BlcnRpZXMgZnJvbSBvbmUgYXhpcyB0byBhbm90aGVyIiIiCiAgICAjIENvcHkgdGl0bGUg
YW5kIGxhYmVscwogICAgdGFyZ2V0X2F4LnNldF90aXRsZShzb3VyY2VfYXguZ2V0X3RpdGxlKCkp
CiAgICB0YXJnZXRfYXguc2V0X3hsYWJlbChzb3VyY2VfYXguZ2V0X3hsYWJlbCgpKQogICAgdGFy
Z2V0X2F4LnNldF95bGFiZWwoc291cmNlX2F4LmdldF95bGFiZWwoKSkKCiAgICAjIENvcHkgc2Nh
bGVzCiAgICB0YXJnZXRfYXguc2V0X3hzY2FsZShzb3VyY2VfYXguZ2V0X3hzY2FsZSgpKQogICAg
dGFyZ2V0X2F4LnNldF95c2NhbGUoc291cmNlX2F4LmdldF95c2NhbGUoKSkKCiAgICAjIENvcHkg
dGlja3MgYW5kIHRpY2sgbGFiZWxzCiAgICB0YXJnZXRfYXguc2V0X3h0aWNrcyhzb3VyY2VfYXgu
Z2V0X3h0aWNrcygpKQogICAgdGFyZ2V0X2F4LnNldF95dGlja3Moc291cmNlX2F4LmdldF95dGlj
a3MoKSkKICAgIHRhcmdldF9heC5zZXRfeHRpY2tsYWJlbHMoc291cmNlX2F4LmdldF94dGlja2xh
YmVscygpKQogICAgdGFyZ2V0X2F4LnNldF95dGlja2xhYmVscyhzb3VyY2VfYXguZ2V0X3l0aWNr
bGFiZWxzKCkpCgogICAgcmV0dXJuIHRhcmdldF9heAoKCmRlZiBzYXZlX2ZpZ3VyZV9hc19iYXNl
NjQoZmlnLCBiYm94X2luY2hlcz0ndGlnaHQnLCBkcGk9MTAwKToKICAgICIiIlNhdmUgYSBmaWd1
cmUgYXMgYSBiYXNlNjQtZW5jb2RlZCBQTkcgc3RyaW5nIiIiCiAgICBwbmdfYnVmZmVyID0gaW8u
Qnl0ZXNJTygpCiAgICBmaWcuc2F2ZWZpZyhwbmdfYnVmZmVyLCBmb3JtYXQ9J3BuZycsIGJib3hf
aW5jaGVzPWJib3hfaW5jaGVzLCBkcGk9ZHBpKQogICAgcG5nX2J1ZmZlci5zZWVrKDApCiAgICBy
ZXR1cm4gYmFzZTY0LmI2NGVuY29kZShwbmdfYnVmZmVyLmdldHZhbHVlKCkpLmRlY29kZSgndXRm
LTgnKQoKCmRlZiBleHRyYWN0X2FuZF9wcmludF9maWd1cmVfbWV0YWRhdGEoZmlnKToKICAgICIi
IkV4dHJhY3QgbWV0YWRhdGEgZnJvbSBhIG1hdHBsb3RsaWIgZmlndXJlIGFuZCBwcmludCBhcyBK
U09OIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICBpbXBvcnQgbWF0
cGxvdGxpYi5jb2xsZWN0aW9ucwogICAgaW1wb3J0IG1hdHBsb3RsaWIuZmlndXJlCiAgICBpbXBv
cnQgbWF0cGxvdGxpYi5wYXRjaGVzCiAgICBpbXBvcnQganNvbgoKICAgIGRlZiBqc29uX2Zsb2F0
X2ZpeChvYmopOgogICAgICAgICIiIkhlbHBlciBmdW5jdGlvbiB0byBoYW5kbGUgTmFOLCBJbmZp
bml0eSwgZXRjLiBpbiBKU09OIiIiCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGZsb2F0KToK
ICAgICAgICAgICAgaWYgbWF0aC5pc25hbihvYmopIG9yIG1hdGguaXNpbmYob2JqKToKICAgICAg
ICAgICAgICAgIHJldHVybiAwLjAKICAgICAgICAgICAgcmV0dXJuIGZsb2F0KG9iaikKICAgICAg
ICBlbGlmIGlzaW5zdGFuY2Uob2JqLCAobGlzdCwgdHVwbGUpKToKICAgICAgICAgICAgcmV0dXJu
IFtqc29uX2Zsb2F0X2ZpeChpdGVtKSBmb3IgaXRlbSBpbiBvYmpdCiAgICAgICAgZWxpZiBpc2lu
c3RhbmNlKG9iaiwgZGljdCk6CiAgICAgICAgICAgIHJldHVybiB7a2V5OiBqc29uX2Zsb2F0X2Zp
eCh2YWx1ZSkgZm9yIGtleSwgdmFsdWUgaW4gb2JqLml0ZW1zKCl9CiAgICAgICAgcmV0dXJuIG9i
agoKICAgIG1ldGFkYXRhID0ge30KICAgIHN1YnBsb3RzID0gW10KCiAgICAjIFByb2Nlc3MgZWFj
aCBheGlzIGluIHRoZSBmaWd1cmUKICAgIGZvciBpLCBheCBpbiBlbnVtZXJhdGUoZmlnLmF4ZXMp
OgogICAgICAgIHN1YnBsb3RfZGF0YSA9IHt9CgogICAgICAgICMgQ2hlY2sgaWYgdGhpcyBpcyBh
IGNvbG9yYmFyIGF4aXMgLSB0aGVzZSBzaG91bGQgYmUgaWdub3JlZCBmb3IgY2xhc3NpZmljYXRp
b24KICAgICAgICBpc19jb2xvcmJhcl9heGlzID0gRmFsc2UKICAgICAgICB0cnk6CiAgICAgICAg
ICAgICMgQ29sb3JiYXIgYXhlcyB0eXBpY2FsbHkgaGF2ZSBmZXdlciBjaGlsZHJlbiBhbmQgc3Bl
Y2lmaWMgcHJvcGVydGllcwogICAgICAgICAgICBpZiBoYXNhdHRyKGF4LCAnZ2V0X2FzcGVjdCcp
IGFuZCBheC5nZXRfYXNwZWN0KCkgPT0gMjAuMDoKICAgICAgICAgICAgICAgIGlzX2NvbG9yYmFy
X2F4aXMgPSBUcnVlCiAgICAgICAgICAgIGlmIGhhc2F0dHIoYXgsICdfYXhlcycpIGFuZCBoYXNh
dHRyKGF4Ll9heGVzLCAnY29sb3JiYXInKToKICAgICAgICAgICAgICAgIGlzX2NvbG9yYmFyX2F4
aXMgPSBUcnVlCiAgICAgICAgICAgICMgQ2hlY2sgZm9yIGNvbG9yYmFyLXNwZWNpZmljIGNoaWxk
cmVuCiAgICAgICAgICAgIGZvciBjaGlsZCBpbiBheC5nZXRfY2hpbGRyZW4oKToKICAgICAgICAg
ICAgICAgIGlmIHN0cih0eXBlKGNoaWxkKS5fX25hbWVfXykubG93ZXIoKS5maW5kKCdjb2xvcmJh
cicpID49IDA6CiAgICAgICAgICAgICAgICAgICAgaXNfY29sb3JiYXJfYXhpcyA9IFRydWUKICAg
ICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoK
ICAgICAgICAjIFNraXAgY29sb3JiYXIgYXhlcyB3aGVuIGNvdW50aW5nIGFjdHVhbCBzdWJwbG90
cwogICAgICAgIGlmIGlzX2NvbG9yYmFyX2F4aXM6CiAgICAgICAgICAgIGNvbnRpbnVlCgogICAg
ICAgICMgVGl0bGUgYW5kIGxhYmVscwogICAgICAgIGlmIGF4LmdldF90aXRsZSgpOgogICAgICAg
ICAgICBzdWJwbG90X2RhdGFbInRpdGxlIl0gPSBheC5nZXRfdGl0bGUoKQogICAgICAgIGlmIGF4
LmdldF94bGFiZWwoKToKICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJ4X2xhYmVsIl0gPSBheC5n
ZXRfeGxhYmVsKCkKICAgICAgICBpZiBheC5nZXRfeWxhYmVsKCk6CiAgICAgICAgICAgIHN1YnBs
b3RfZGF0YVsieV9sYWJlbCJdID0gYXguZ2V0X3lsYWJlbCgpCgogICAgICAgICMgQWRkIFggYW5k
IFkgdW5pdHMgLSBleHRyYWN0IGZyb20gbGFiZWxzIGlmIHBvc3NpYmxlCiAgICAgICAgc3VicGxv
dF9kYXRhWyJ4X3VuaXQiXSA9ICJOb25lIiAgIyBEZWZhdWx0IHZhbHVlCiAgICAgICAgc3VicGxv
dF9kYXRhWyJ5X3VuaXQiXSA9ICJOb25lIiAgIyBEZWZhdWx0IHZhbHVlCgogICAgICAgICMgVHJ5
IHRvIGV4dHJhY3QgdW5pdHMgZnJvbSBheGlzIGxhYmVscyBpZiB0aGV5IGNvbnRhaW4gcGFyZW50
aGVzZXMKICAgICAgICBpZiBheC5nZXRfeGxhYmVsKCk6CiAgICAgICAgICAgIHhfdW5pdF9tYXRj
aCA9IHJlLnNlYXJjaChyJ1woKC4qPylcKScsIGF4LmdldF94bGFiZWwoKSkKICAgICAgICAgICAg
aWYgeF91bml0X21hdGNoOgogICAgICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJ4X3VuaXQiXSA9
IHhfdW5pdF9tYXRjaC5ncm91cCgxKQoKICAgICAgICBpZiBheC5nZXRfeWxhYmVsKCk6CiAgICAg
ICAgICAgIHlfdW5pdF9tYXRjaCA9IHJlLnNlYXJjaChyJ1woKC4qPylcKScsIGF4LmdldF95bGFi
ZWwoKSkKICAgICAgICAgICAgaWYgeV91bml0X21hdGNoOgogICAgICAgICAgICAgICAgc3VicGxv
dF9kYXRhWyJ5X3VuaXQiXSA9IHlfdW5pdF9tYXRjaC5ncm91cCgxKQoKICAgICAgICAjIFNjYWxl
IHR5cGVzCiAgICAgICAgc3VicGxvdF9kYXRhWyJ4X3NjYWxlIl0gPSBheC5nZXRfeHNjYWxlKCkK
ICAgICAgICBzdWJwbG90X2RhdGFbInlfc2NhbGUiXSA9IGF4LmdldF95c2NhbGUoKQoKICAgICAg
ICAjIFRpY2tzIGFuZCB0aWNrIGxhYmVscwogICAgICAgIHh0aWNrcyA9IGF4LmdldF94dGlja3Mo
KQogICAgICAgIHl0aWNrcyA9IGF4LmdldF95dGlja3MoKQoKICAgICAgICAjIEdldCB0aWNrIGxh
YmVscywgaGFuZGxpbmcgZGlmZmVyZW50IG1hdHBsb3RsaWIgdmVyc2lvbnMKICAgICAgICB0cnk6
CiAgICAgICAgICAgIHh0aWNrbGFiZWxzID0gW2xhYmVsLmdldF90ZXh0KCkgaWYgaGFzYXR0cihs
YWJlbCwgJ2dldF90ZXh0JykgZWxzZSBzdHIobGFiZWwpCiAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGZvciBsYWJlbCBpbiBheC5nZXRfeHRpY2tsYWJlbHMoKV0KICAgICAgICAgICAgeXRpY2ts
YWJlbHMgPSBbbGFiZWwuZ2V0X3RleHQoKSBpZiBoYXNhdHRyKGxhYmVsLCAnZ2V0X3RleHQnKSBl
bHNlIHN0cihsYWJlbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGxhYmVsIGluIGF4
LmdldF95dGlja2xhYmVscygpXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIyBGYWxsYmFj
ayB0byBzaW1wbGVyIG1ldGhvZAogICAgICAgICAgICB4dGlja2xhYmVscyA9IFtzdHIobGFiZWwp
IGZvciBsYWJlbCBpbiBheC5nZXRfeHRpY2tsYWJlbHMoKV0KICAgICAgICAgICAgeXRpY2tsYWJl
bHMgPSBbc3RyKGxhYmVsKSBmb3IgbGFiZWwgaW4gYXguZ2V0X3l0aWNrbGFiZWxzKCldCgogICAg
ICAgICMgQ29udmVydCB0byBsaXN0IGlmIG5lZWRlZCBhbmQgZW5zdXJlIGFsbCB2YWx1ZXMgYXJl
IEpTT04gc2VyaWFsaXphYmxlCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdWJwbG90X2RhdGFb
InhfdGlja3MiXSA9IFtmbG9hdCh4KSBmb3IgeCBpbiAoCiAgICAgICAgICAgICAgICB4dGlja3Mu
dG9saXN0KCkgaWYgaGFzYXR0cih4dGlja3MsICd0b2xpc3QnKSBlbHNlIGxpc3QoeHRpY2tzKSld
CiAgICAgICAgICAgIHN1YnBsb3RfZGF0YVsieV90aWNrcyJdID0gW2Zsb2F0KHkpIGZvciB5IGlu
ICgKICAgICAgICAgICAgICAgIHl0aWNrcy50b2xpc3QoKSBpZiBoYXNhdHRyKHl0aWNrcywgJ3Rv
bGlzdCcpIGVsc2UgbGlzdCh5dGlja3MpKV0KICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFR5
cGVFcnJvcikgYXMgZToKICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJ4X3RpY2tzIl0gPSBsaXN0
KHJhbmdlKGxlbih4dGlja2xhYmVscykpKQogICAgICAgICAgICBzdWJwbG90X2RhdGFbInlfdGlj
a3MiXSA9IGxpc3QocmFuZ2UobGVuKHl0aWNrbGFiZWxzKSkpCgogICAgICAgIHN1YnBsb3RfZGF0
YVsieF90aWNrX2xhYmVscyJdID0geHRpY2tsYWJlbHMKICAgICAgICBzdWJwbG90X2RhdGFbInlf
dGlja19sYWJlbHMiXSA9IHl0aWNrbGFiZWxzCgogICAgICAgICMgVHJ5IHRvIGRldGVybWluZSBj
aGFydCB0eXBlIGFuZCBleHRyYWN0IGVsZW1lbnRzIGRhdGEKICAgICAgICBjaGFydF90eXBlID0g
InVua25vd24iICAjIERlZmF1bHQgdmFsdWUgaW4gc25ha2VfY2FzZQogICAgICAgIGVsZW1lbnRz
ID0gW10KCiAgICAgICAgIyBQcmludCBkZWJ1ZyBpbmZvIGFib3V0IGNoaWxkcmVuCiAgICAgICAg
Y2hpbGRfdHlwZXMgPSB7fQogICAgICAgIGZvciBjaGlsZCBpbiBheC5nZXRfY2hpbGRyZW4oKToK
ICAgICAgICAgICAgY2hpbGRfdHlwZSA9IHR5cGUoY2hpbGQpLl9fbmFtZV9fCiAgICAgICAgICAg
IGlmIGNoaWxkX3R5cGUgbm90IGluIGNoaWxkX3R5cGVzOgogICAgICAgICAgICAgICAgY2hpbGRf
dHlwZXNbY2hpbGRfdHlwZV0gPSAwCiAgICAgICAgICAgIGNoaWxkX3R5cGVzW2NoaWxkX3R5cGVd
ICs9IDEKCiAgICAgICAgIyBJbXByb3ZlZCBjaGFydCB0eXBlIGRldGVjdGlvbiB3aXRoIG11bHRp
cGxlIGNoZWNrcwoKICAgICAgICAjIENoZWNrIGZvciB2YXJpb3VzIGNoYXJ0IGVsZW1lbnRzCiAg
ICAgICAgYm94X3Bsb3RzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBheC5nZXRfY2hpbGRyZW4oKSBp
ZiBpc2luc3RhbmNlKAogICAgICAgICAgICBjaGlsZCwgbWF0cGxvdGxpYi5wYXRjaGVzLlBhdGhQ
YXRjaCldCgogICAgICAgICMgRklYOiBGaXhlZCBXZWRnZSBkZXRlY3Rpb24sIGNvcnJlY3RseSBp
bXBvcnRpbmcgZnJvbSBtYXRwbG90bGliLnBhdGNoZXMKICAgICAgICB3ZWRnZXMgPSBbY2hpbGQg
Zm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2UoCiAgICAgICAgICAg
IGNoaWxkLCBtYXRwbG90bGliLnBhdGNoZXMuV2VkZ2UpXQoKICAgICAgICAjIENoZWNrIGZvciBs
aW5lcyBhbmQgc2NhdHRlciBwbG90cwogICAgICAgIGxpbmVzID0gW2NoaWxkIGZvciBjaGlsZCBp
biBheC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgICAgICBjaGlsZCwgcGx0
LkxpbmUyRCkgYW5kIGNoaWxkLmdldF9saW5lc3R5bGUoKSA9PSAnLSddCiAgICAgICAgc2NhdHRl
cnMgPSBbY2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2Uo
CiAgICAgICAgICAgIGNoaWxkLCBtYXRwbG90bGliLmNvbGxlY3Rpb25zLlBhdGhDb2xsZWN0aW9u
KV0KCiAgICAgICAgIyBDaGVjayBmb3IgcmVjdGFuZ2xlcyAocG90ZW50aWFsIGJhciBjaGFydHMp
IC0gZXhwYW5kZWQgY2hlY2sKICAgICAgICByZWN0YW5nbGVzID0gW2NoaWxkIGZvciBjaGlsZCBp
biBheC5nZXRfY2hpbGRyZW4oKSBpZgogICAgICAgICAgICAgICAgICAgICAgKGlzaW5zdGFuY2Uo
Y2hpbGQsIHBsdC5SZWN0YW5nbGUpIGFuZCBoYXNhdHRyKGNoaWxkLCAnZ2V0X2hlaWdodCcpKSBv
cgogICAgICAgICAgICAgICAgICAgICAgKGlzaW5zdGFuY2UoY2hpbGQsIG1hdHBsb3RsaWIucGF0
Y2hlcy5SZWN0YW5nbGUpIGFuZCBoYXNhdHRyKGNoaWxkLCAnZ2V0X2hlaWdodCcpKV0KCiAgICAg
ICAgIyBBZGRpdGlvbmFsIGNoZWNrIGZvciBwYXRjaC1iYXNlZCByZWN0YW5nbGVzIGluIG5ld2Vy
IG1hdHBsb3RsaWIKICAgICAgICBpZiBsZW4ocmVjdGFuZ2xlcykgPT0gMDoKICAgICAgICAgICAg
cGF0Y2hfcmVjdGFuZ2xlcyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkg
aWYgaXNpbnN0YW5jZSgKICAgICAgICAgICAgICAgIGNoaWxkLCBtYXRwbG90bGliLnBhdGNoZXMu
UGF0aFBhdGNoKV0KICAgICAgICAgICAgZm9yIHBhdGNoIGluIHBhdGNoX3JlY3RhbmdsZXM6CiAg
ICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcGF0aCA9IHBhdGNoLmdldF9w
YXRoKCkKICAgICAgICAgICAgICAgICAgICB2ZXJ0aWNlcyA9IHBhdGgudmVydGljZXMKICAgICAg
ICAgICAgICAgICAgICBpZiBsZW4odmVydGljZXMpID49IDQ6ICAjIFJlY3RhbmdsZXMgdHlwaWNh
bGx5IGhhdmUgYXQgbGVhc3QgNCB2ZXJ0aWNlcwogICAgICAgICAgICAgICAgICAgICAgICByZWN0
YW5nbGVzLmFwcGVuZChwYXRjaCkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAg
ICAgICAgICBwYXNzCgogICAgICAgICMgQ2hlY2sgZm9yIGJveCBwbG90IHNwZWNpZmljIGVsZW1l
bnRzCiAgICAgICAgY2FwcyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkg
aWYgaXNpbnN0YW5jZSgKICAgICAgICAgICAgY2hpbGQsIHBsdC5MaW5lMkQpIGFuZCBjaGlsZC5n
ZXRfbWFya2VyKCkgPT0gJ18nXQoKICAgICAgICAjIEVuaGFuY2VkIGJveCBwbG90IGRldGVjdGlv
bgogICAgICAgIG1lZGlhbl9saW5lcyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxk
cmVuKCkgaWYgaXNpbnN0YW5jZSgKICAgICAgICAgICAgY2hpbGQsIHBsdC5MaW5lMkQpIGFuZCBj
aGlsZC5nZXRfbWFya2VyKCkgPT0gJycgYW5kIGNoaWxkLmdldF9saW5lc3R5bGUoKSA9PSAnLScg
YW5kIGxlbihjaGlsZC5nZXRfeGRhdGEoKSkgPT0gMl0KCiAgICAgICAgIyBDaGVjayB0aXRsZSBh
bmQgbGFiZWxzIGZvciBoaW50cyBhYm91dCBjaGFydCB0eXBlCiAgICAgICAgdGl0bGUgPSBheC5n
ZXRfdGl0bGUoKS5sb3dlcigpIGlmIGF4LmdldF90aXRsZSgpIGVsc2UgIiIKICAgICAgICB4bGFi
ZWwgPSBheC5nZXRfeGxhYmVsKCkubG93ZXIoKSBpZiBheC5nZXRfeGxhYmVsKCkgZWxzZSAiIgog
ICAgICAgIHlsYWJlbCA9IGF4LmdldF95bGFiZWwoKS5sb3dlcigpIGlmIGF4LmdldF95bGFiZWwo
KSBlbHNlICIiCgogICAgICAgICMgSGV1cmlzdGljIGZvciBjaGFydCB0eXBlIGJhc2VkIG9uIHRp
dGxlL2xhYmVscwogICAgICAgIGlzX2Jhcl9jaGFydF9ieV90aXRsZSA9ICJiYXIiIGluIHRpdGxl
CiAgICAgICAgaXNfcGllX2NoYXJ0X2J5X3RpdGxlID0gInBpZSIgaW4gdGl0bGUKICAgICAgICBp
c19ib3hfcGxvdF9ieV90aXRsZSA9ICJib3giIGluIHRpdGxlIG9yICJ3aGlza2VyIiBpbiB0aXRs
ZQogICAgICAgIGlzX3NjYXR0ZXJfYnlfdGl0bGUgPSAic2NhdHRlciIgaW4gdGl0bGUKICAgICAg
ICBpc19saW5lX2J5X3RpdGxlID0gImxpbmUiIGluIHRpdGxlIG9yIHRpdGxlLnN0YXJ0c3dpdGgo
CiAgICAgICAgICAgICJMaW5lIENoYXJ0IikKCiAgICAgICAgIyBCZXR0ZXIgY3JpdGVyaWEgZm9y
IGJveCBwbG90IGRldGVjdGlvbgogICAgICAgIGlzX2JveF9wbG90ID0gKGlzX2JveF9wbG90X2J5
X3RpdGxlIG9yCiAgICAgICAgICAgICAgICAgICAgICAgKGxlbihib3hfcGxvdHMpID4gMCBhbmQg
bGVuKGNhcHMpID4gMCkgb3IKICAgICAgICAgICAgICAgICAgICAgICAobGVuKGJveF9wbG90cykg
PiAwIGFuZCBsZW4obWVkaWFuX2xpbmVzKSA+IDApKQoKICAgICAgICAjIERldGVybWluZSBjaGFy
dCB0eXBlIGJhc2VkIG9uIGRldGVjdGVkIGVsZW1lbnRzCiAgICAgICAgIyBJbXByb3ZlZCBzY2F0
dGVyIHBsb3QgZGV0ZWN0aW9uIGxvZ2ljCiAgICAgICAgaGFzX3NjYXR0ZXJzID0gbGVuKHNjYXR0
ZXJzKSA+IDAKICAgICAgICBoYXNfY29sb3JiYXIgPSBhbnkoaXNpbnN0YW5jZShjaGlsZCwgcGx0
LkF4ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBjaGlsZCBpbiBheC5nZXRfY2hp
bGRyZW4oKSkKCiAgICAgICAgIyBDaGVjayBudW1iZXIgb2Ygc3VicGxvdHMgLSBhIHBsb3Qgd2l0
aCBhIGNvbG9yYmFyIGlzIG9mdGVuIGRldGVjdGVkIGFzIGNvbXBvc2l0ZQogICAgICAgIGlmIGlz
X3NjYXR0ZXJfYnlfdGl0bGUgb3IgaGFzX3NjYXR0ZXJzOgogICAgICAgICAgICAjIFByaW9yaXRp
emUgc2NhdHRlciBkZXRlY3Rpb24KICAgICAgICAgICAgY2hhcnRfdHlwZSA9ICJzY2F0dGVyIiAg
IyBSZXZlcnRlZCB0byBzbmFrZV9jYXNlCiAgICAgICAgICAgIGVsZW1lbnRzID0gZXh0cmFjdF9z
Y2F0dGVyX3Bsb3RfZGF0YShheCkKICAgICAgICBlbGlmIGlzX2JveF9wbG90OgogICAgICAgICAg
ICAjIEJveCBwbG90cyBvZnRlbiBoYXZlIHRoZXNlIHNwZWNpZmljIGVsZW1lbnRzCiAgICAgICAg
ICAgIGNoYXJ0X3R5cGUgPSAiYm94X2FuZF93aGlza2VyIiAgIyBSZXZlcnRlZCB0byBzbmFrZV9j
YXNlCiAgICAgICAgICAgIGVsZW1lbnRzID0gZXh0cmFjdF9ib3hfcGxvdF9kYXRhKGF4LCB4dGlj
a2xhYmVscykKICAgICAgICBlbGlmICh3ZWRnZXMgYW5kIGxlbih3ZWRnZXMpID4gMCkgb3IgaXNf
cGllX2NoYXJ0X2J5X3RpdGxlOgogICAgICAgICAgICAjIFBpZSBjaGFydAogICAgICAgICAgICBj
aGFydF90eXBlID0gInBpZSIgICMgUmV2ZXJ0ZWQgdG8gc25ha2VfY2FzZQogICAgICAgICAgICBl
bGVtZW50cyA9IGV4dHJhY3RfcGllX2NoYXJ0X2RhdGEoYXgpCiAgICAgICAgZWxpZiAoKGxpbmVz
IGFuZCBsZW4obGluZXMpID4gMCBhbmQgbm90IGlzX2JveF9wbG90KSBvciBpc19saW5lX2J5X3Rp
dGxlKToKICAgICAgICAgICAgIyBMaW5lIHBsb3QgKGJ1dCBub3QgYm94IHBsb3Qgd2hpc2tlcnMp
CiAgICAgICAgICAgIGNoYXJ0X3R5cGUgPSAibGluZSIgICMgUmV2ZXJ0ZWQgdG8gc25ha2VfY2Fz
ZQogICAgICAgICAgICBlbGVtZW50cyA9IGV4dHJhY3RfbGluZV9wbG90X2RhdGEoYXgpCiAgICAg
ICAgZWxpZiAoKHJlY3RhbmdsZXMgYW5kIGxlbihyZWN0YW5nbGVzKSA+IDAgYW5kIG5vdCBpc19i
b3hfcGxvdCkgb3IgaXNfYmFyX2NoYXJ0X2J5X3RpdGxlKToKICAgICAgICAgICAgIyBCYXIgY2hh
cnQgKGJ1dCBub3QgYm94IHBsb3QgZWxlbWVudHMpCiAgICAgICAgICAgIGNoYXJ0X3R5cGUgPSAi
YmFyIiAgIyBSZXZlcnRlZCB0byBzbmFrZV9jYXNlCiAgICAgICAgICAgIGVsZW1lbnRzID0gZXh0
cmFjdF9iYXJfY2hhcnRfZGF0YShheCwgeHRpY2tsYWJlbHMpCgogICAgICAgICMgSWYgbm8gZWxl
bWVudHMgd2VyZSBkZXRlY3RlZCBidXQgd2UgaGF2ZSBzY2F0dGVycywgdHJ5IGFnYWluIHdpdGgg
c2NhdHRlciBkZXRlY3Rpb24KICAgICAgICBpZiBsZW4oZWxlbWVudHMpID09IDAgYW5kIGhhc19z
Y2F0dGVyczoKICAgICAgICAgICAgY2hhcnRfdHlwZSA9ICJzY2F0dGVyIiAgIyBSZXZlcnRlZCB0
byBzbmFrZV9jYXNlCiAgICAgICAgICAgIGVsZW1lbnRzID0gZXh0cmFjdF9zY2F0dGVyX3Bsb3Rf
ZGF0YShheCkKCiAgICAgICAgIyBJZiB3ZSBzdGlsbCBkb24ndCBoYXZlIGVsZW1lbnRzIGFuZCB0
aXRsZSBzdWdnZXN0cyBhIGxpbmUgY2hhcnQsIHRyeSBhZ2FpbiB3aXRoIGxpbmUgZXh0cmFjdGlv
bgogICAgICAgIGlmIGxlbihlbGVtZW50cykgPT0gMCBhbmQgKGlzX2xpbmVfYnlfdGl0bGUgb3Ig
IkxpbmUgQ2hhcnQiIGluIGF4LmdldF90aXRsZSgpKToKICAgICAgICAgICAgY2hhcnRfdHlwZSA9
ICJsaW5lIgogICAgICAgICAgICBlbGVtZW50cyA9IGV4dHJhY3RfbGluZV9wbG90X2RhdGEoYXgp
CiAgICAgICAgIyBDb250aW51ZSB3aXRoIGVtcHR5IGVsZW1lbnRzIGlmIGV4dHJhY3Rpb24gZmFp
bHMKCiAgICAgICAgc3VicGxvdF9kYXRhWyJ0eXBlIl0gPSBjaGFydF90eXBlCiAgICAgICAgaWYg
ZWxlbWVudHM6ICAjIE9ubHkgYWRkIGVsZW1lbnRzIGlmIHdlIGhhdmUgYW55CiAgICAgICAgICAg
IHN1YnBsb3RfZGF0YVsiZWxlbWVudHMiXSA9IGVsZW1lbnRzCgogICAgICAgICMgU2F2ZSBzdWJw
bG90IFBORyBpZiB0aGlzIGlzIGEgbXVsdGktc3VicGxvdCBmaWd1cmUKICAgICAgICBpZiBsZW4o
ZmlnLmF4ZXMpID4gMToKICAgICAgICAgICAgIyBDcmVhdGUgYSBuZXcgZmlndXJlIHdpdGgganVz
dCB0aGlzIHN1YnBsb3QKICAgICAgICAgICAgc3VicGxvdF9maWcgPSBwbHQuZmlndXJlKGZpZ3Np
emU9KDgsIDYpKQogICAgICAgICAgICBzdWJwbG90X2F4ID0gc3VicGxvdF9maWcuYWRkX3N1YnBs
b3QoMTExKQoKICAgICAgICAgICAgIyBSZWNyZWF0ZSB0aGUgcGxvdCBiYXNlZCBvbiB0aGUgY2hh
cnQgdHlwZSBhbmQgZWxlbWVudHMKICAgICAgICAgICAgaWYgY2hhcnRfdHlwZSA9PSAiYmFyIjog
ICMgUmV2ZXJ0ZWQgdG8gc25ha2VfY2FzZQogICAgICAgICAgICAgICAgc3VicGxvdF9heCA9IHJl
Y3JlYXRlX2FuZF9zYXZlX2Jhcl9jaGFydCgKICAgICAgICAgICAgICAgICAgICBheCwgZWxlbWVu
dHMsIHN1YnBsb3RfYXgpCiAgICAgICAgICAgIGVsaWYgY2hhcnRfdHlwZSA9PSAic2NhdHRlciI6
ICAjIFJldmVydGVkIHRvIHNuYWtlX2Nhc2UKICAgICAgICAgICAgICAgIHN1YnBsb3RfYXggPSBy
ZWNyZWF0ZV9hbmRfc2F2ZV9zY2F0dGVyX3Bsb3QoCiAgICAgICAgICAgICAgICAgICAgYXgsIGVs
ZW1lbnRzLCBzdWJwbG90X2F4KQogICAgICAgICAgICBlbGlmIGNoYXJ0X3R5cGUgPT0gImxpbmUi
OiAgIyBSZXZlcnRlZCB0byBzbmFrZV9jYXNlCiAgICAgICAgICAgICAgICBzdWJwbG90X2F4ID0g
cmVjcmVhdGVfYW5kX3NhdmVfbGluZV9wbG90KAogICAgICAgICAgICAgICAgICAgIGF4LCBlbGVt
ZW50cywgc3VicGxvdF9heCkKICAgICAgICAgICAgZWxpZiBjaGFydF90eXBlID09ICJib3hfYW5k
X3doaXNrZXIiOiAgIyBSZXZlcnRlZCB0byBzbmFrZV9jYXNlCiAgICAgICAgICAgICAgICAjIEZv
ciBib3ggcGxvdHMsIHVzZSBhIGRpcmVjdCBjb3B5IGFwcHJvYWNoCiAgICAgICAgICAgICAgICBw
bHQuY2xvc2Uoc3VicGxvdF9maWcpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAg
ICAgICAgIyBVc2UgYSBkaXJlY3QgY29weSBpbnN0ZWFkIChjYXB0dXJlIHRoZSBlbnRpcmUgYXhp
cykKICAgICAgICAgICAgICAgICAgICBleHRlbnQgPSBheC5nZXRfdGlnaHRiYm94KGZpZy5jYW52
YXMuZ2V0X3JlbmRlcmVyKCkpLnRyYW5zZm9ybWVkKAogICAgICAgICAgICAgICAgICAgICAgICBm
aWcuZHBpX3NjYWxlX3RyYW5zLmludmVydGVkKCkpCiAgICAgICAgICAgICAgICAgICAgc3VicGxv
dF9maWcgPSBwbHQuZmlndXJlKGZpZ3NpemU9ZXh0ZW50LnNpemUpCgogICAgICAgICAgICAgICAg
ICAgICMgU2F2ZSB0aGUgZmlndXJlIHBvcnRpb24gdGhhdCBjb250YWlucyBqdXN0IHRoaXMgYXhp
cwogICAgICAgICAgICAgICAgICAgIHBuZ19idWZmZXIgPSBpby5CeXRlc0lPKCkKICAgICAgICAg
ICAgICAgICAgICBmaWcuc2F2ZWZpZyhwbmdfYnVmZmVyLCBmb3JtYXQ9J3BuZycsCiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgYmJveF9pbmNoZXM9ZXh0ZW50LCBkcGk9MTAwKQogICAg
ICAgICAgICAgICAgICAgIHBuZ19idWZmZXIuc2VlaygwKQogICAgICAgICAgICAgICAgICAgIHN1
YnBsb3RfZGF0YVsicG5nIl0gPSBiYXNlNjQuYjY0ZW5jb2RlKAogICAgICAgICAgICAgICAgICAg
ICAgICBwbmdfYnVmZmVyLmdldHZhbHVlKCkpLmRlY29kZSgndXRmLTgnKQogICAgICAgICAgICAg
ICAgICAgIHBsdC5jbG9zZShzdWJwbG90X2ZpZykKICAgICAgICAgICAgICAgICAgICBzdWJwbG90
cy5hcHBlbmQoc3VicGxvdF9kYXRhKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAg
ICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgIyBD
b250aW51ZSB0byB0aGUgbmV4dCBzdWJwbG90IGlmIHRoaXMgZmFpbHMKICAgICAgICAgICAgICAg
ICAgICBwbHQuY2xvc2Uoc3VicGxvdF9maWcpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUK
ICAgICAgICAgICAgZWxpZiBjaGFydF90eXBlID09ICJwaWUiOiAgIyBSZXZlcnRlZCB0byBzbmFr
ZV9jYXNlCiAgICAgICAgICAgICAgICBzdWJwbG90X2F4ID0gcmVjcmVhdGVfYW5kX3NhdmVfcGll
X2NoYXJ0KAogICAgICAgICAgICAgICAgICAgIGF4LCBlbGVtZW50cywgc3VicGxvdF9heCkKCiAg
ICAgICAgICAgICMgU2V0IHRoZSBzdWJwbG90IHByb3BlcnRpZXMgKHRpdGxlLCBsYWJlbHMsIGV0
Yy4pCiAgICAgICAgICAgIHN1YnBsb3RfYXggPSBjb3B5X2F4aXNfcHJvcGVydGllcyhheCwgc3Vi
cGxvdF9heCkKCiAgICAgICAgICAgICMgU2F2ZSB0aGUgbmV3IGZpZ3VyZQogICAgICAgICAgICBz
dWJwbG90X2ZpZy50aWdodF9sYXlvdXQoKQogICAgICAgICAgICBzdWJwbG90X2RhdGFbInBuZyJd
ID0gc2F2ZV9maWd1cmVfYXNfYmFzZTY0KHN1YnBsb3RfZmlnKQoKICAgICAgICAgICAgIyBDbG9z
ZSB0aGUgZmlndXJlIHRvIGZyZWUgbWVtb3J5CiAgICAgICAgICAgIHBsdC5jbG9zZShzdWJwbG90
X2ZpZykKICAgICAgICAgICAgIyBDb250aW51ZSB3aXRob3V0IHRoZSBQTkcgaWYgdGhlcmUncyBh
biBlcnJvcgoKICAgICAgICBzdWJwbG90cy5hcHBlbmQoc3VicGxvdF9kYXRhKQoKICAgIG1ldGFk
YXRhX3BuZyA9IHNhdmVfZmlndXJlX2FzX2Jhc2U2NChmaWcpCgogICAgIyBDb3VudCBhY3R1YWwg
cGxvdCBheGVzIChleGNsdWRpbmcgY29sb3JiYXJzKQogICAgYWN0dWFsX3Bsb3RfYXhlcyA9IDAK
ICAgIGZvciBheCBpbiBmaWcuYXhlczoKICAgICAgICAjIFNraXAgY29sb3JiYXIgYXhlcwogICAg
ICAgIGlzX2NvbG9yYmFyX2F4aXMgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYg
aGFzYXR0cihheCwgJ2dldF9hc3BlY3QnKSBhbmQgYXguZ2V0X2FzcGVjdCgpID09IDIwLjA6CiAg
ICAgICAgICAgICAgICBpc19jb2xvcmJhcl9heGlzID0gVHJ1ZQogICAgICAgICAgICBpZiBoYXNh
dHRyKGF4LCAnX2F4ZXMnKSBhbmQgaGFzYXR0cihheC5fYXhlcywgJ2NvbG9yYmFyJyk6CiAgICAg
ICAgICAgICAgICBpc19jb2xvcmJhcl9heGlzID0gVHJ1ZQogICAgICAgICAgICBmb3IgY2hpbGQg
aW4gYXguZ2V0X2NoaWxkcmVuKCk6CiAgICAgICAgICAgICAgICBpZiBzdHIodHlwZShjaGlsZCku
X19uYW1lX18pLmxvd2VyKCkuZmluZCgnY29sb3JiYXInKSA+PSAwOgogICAgICAgICAgICAgICAg
ICAgIGlzX2NvbG9yYmFyX2F4aXMgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAg
ICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaWYgbm90IGlzX2NvbG9yYmFy
X2F4aXM6CiAgICAgICAgICAgIGFjdHVhbF9wbG90X2F4ZXMgKz0gMQoKICAgICMgQ3JlYXRlIHRo
ZSBmaW5hbCBtZXRhZGF0YSBzdHJ1Y3R1cmUKICAgIGlmIGFjdHVhbF9wbG90X2F4ZXMgPiAxOgog
ICAgICAgICMgTXVsdGlwbGUgYWN0dWFsIHN1YnBsb3RzIC0gY3JlYXRlIGEgbWFpbiBjaGFydAog
ICAgICAgIG1ldGFkYXRhID0gewogICAgICAgICAgICAjIFRyeSB0byBnZXQgZmlndXJlIHN1cHRp
dGxlCiAgICAgICAgICAgICJ0aXRsZSI6IGZpZy50ZXh0c1swXS5nZXRfdGV4dCgpIGlmIGZpZy50
ZXh0cyBlbHNlIE5vbmUsCiAgICAgICAgICAgICJ0eXBlIjogImNvbXBvc2l0ZV9jaGFydCIsICAj
IFJldmVydGVkIHRvIHNuYWtlX2Nhc2UKICAgICAgICAgICAgInBuZyI6IG1ldGFkYXRhX3BuZywK
ICAgICAgICAgICAgInN1YnBsb3RzIjogc3VicGxvdHMKICAgICAgICB9CiAgICBlbHNlOgogICAg
ICAgICMgU2luZ2xlIHBsb3QgKHBvc3NpYmx5IHdpdGggY29sb3JiYXJzKSAtIHVzZSB0aGUgc3Vi
cGxvdCBkYXRhIGRpcmVjdGx5CiAgICAgICAgIyBGaW5kIHRoZSBub24tY29sb3JiYXIgc3VicGxv
dAogICAgICAgIGZvciBzdWJwbG90IGluIHN1YnBsb3RzOgogICAgICAgICAgICBpZiBzdWJwbG90
LmdldCgidHlwZSIpICE9ICJ1bmtub3duIjoKICAgICAgICAgICAgICAgIG1ldGFkYXRhID0gc3Vi
cGxvdAogICAgICAgICAgICAgICAgbWV0YWRhdGFbInBuZyJdID0gbWV0YWRhdGFfcG5nCiAgICAg
ICAgICAgICAgICBicmVhawogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgRmFsbGJhY2sgaWYg
bm8gdmFsaWQgc3VicGxvdCBmb3VuZAogICAgICAgICAgICBtZXRhZGF0YSA9IHN1YnBsb3RzWzBd
IGlmIHN1YnBsb3RzIGVsc2UgeyJ0eXBlIjogInVua25vd24ifQogICAgICAgICAgICBtZXRhZGF0
YVsicG5nIl0gPSBtZXRhZGF0YV9wbmcKCiAgICAjIEZpeCBhbnkgSlNPTiBzZXJpYWxpemF0aW9u
IGlzc3VlcyAoZS5nLiwgTmFOLCBJbmZpbml0eSkKICAgIG1ldGFkYXRhID0ganNvbl9mbG9hdF9m
aXgobWV0YWRhdGEpCgogICAgIyBQcmludCBtZXRhZGF0YSBpbiB0aGUgc3BlY2lmaWVkIEpTT04g
Zm9ybWF0CiAgICBqc29uX291dHB1dCA9IHsKICAgICAgICAidHlwZSI6ICJjaGFydCIsCiAgICAg
ICAgInZhbHVlIjogbWV0YWRhdGEKICAgIH0KCiAgICAjIGlmIG1ldGFkYXRhLmdldCgidHlwZSIp
ID09ICJsaW5lIjoKICAgICMgICAgIG1ldGFkYXRhX2NvcHkgPSBtZXRhZGF0YS5jb3B5KCkgICMg
Q3JlYXRlIGEgY29weSBvZiBtZXRhZGF0YQogICAgIyAgICAgbWV0YWRhdGFfY29weS5wb3AoInBu
ZyIsIE5vbmUpICAjIFJlbW92ZSB0aGUgcG5nIHByb3BlcnR5CiAgICAjICAgICBwcmludChmImxp
bmU6IHttZXRhZGF0YV9jb3B5fSIpCgogICAgcHJpbnQoZiJkdG5fYXJ0aWZhY3Q6e2pzb24uZHVt
cHMoanNvbl9vdXRwdXQpfSIpCgoKY2xhc3MgTWF0cGxvdGxpYkZpbmRlcihNZXRhUGF0aEZpbmRl
cik6CiAgICAiIiJDdXN0b20gZmluZGVyIHRvIGludGVyY2VwdCBtYXRwbG90bGliLnB5cGxvdCBp
bXBvcnRzIiIiCgogICAgZGVmIGZpbmRfc3BlYyhzZWxmLCBmdWxsbmFtZSwgcGF0aCwgdGFyZ2V0
PU5vbmUpOgogICAgICAgIGdsb2JhbCBwbHRfcGF0Y2hlZAoKICAgICAgICAjIE9ubHkgaW50ZXJj
ZXB0IG1hdHBsb3RsaWIucHlwbG90CiAgICAgICAgaWYgZnVsbG5hbWUgPT0gJ21hdHBsb3RsaWIu
cHlwbG90JyBhbmQgbm90IHBsdF9wYXRjaGVkOgogICAgICAgICAgICAjIE1hcmsgYXMgcGF0Y2hl
ZCB0byBwcmV2ZW50IHJlY3Vyc2lvbgogICAgICAgICAgICBwbHRfcGF0Y2hlZCA9IFRydWUKCiAg
ICAgICAgICAgICMgRmluZCB0aGUgb3JpZ2luYWwgc3BlYwogICAgICAgICAgICBvcmlnaW5hbF9z
cGVjID0gZmluZF9zcGVjKGZ1bGxuYW1lKQogICAgICAgICAgICBpZiBvcmlnaW5hbF9zcGVjIGlz
IE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgIyBDcmVhdGUg
YSBzcGVjIHdpdGggb3VyIGxvYWRlcgogICAgICAgICAgICByZXR1cm4gc3BlY19mcm9tX2xvYWRl
cigKICAgICAgICAgICAgICAgIGZ1bGxuYW1lLAogICAgICAgICAgICAgICAgTWF0cGxvdGxpYkxv
YWRlcihvcmlnaW5hbF9zcGVjLmxvYWRlciksCiAgICAgICAgICAgICAgICBvcmlnaW49b3JpZ2lu
YWxfc3BlYy5vcmlnaW4sCiAgICAgICAgICAgICAgICBpc19wYWNrYWdlPW9yaWdpbmFsX3NwZWMu
c3VibW9kdWxlX3NlYXJjaF9sb2NhdGlvbnMgaXMgbm90IE5vbmUKICAgICAgICAgICAgKQogICAg
ICAgIHJldHVybiBOb25lCgoKY2xhc3MgTWF0cGxvdGxpYkxvYWRlcihMb2FkZXIpOgogICAgIiIi
Q3VzdG9tIGxvYWRlciB0byBwYXRjaCB0aGUgbWF0cGxvdGxpYi5weXBsb3QgbW9kdWxlIiIiCgog
ICAgZGVmIF9faW5pdF9fKHNlbGYsIG9yaWdpbmFsX2xvYWRlcik6CiAgICAgICAgc2VsZi5vcmln
aW5hbF9sb2FkZXIgPSBvcmlnaW5hbF9sb2FkZXIKCiAgICBkZWYgY3JlYXRlX21vZHVsZShzZWxm
LCBzcGVjKToKICAgICAgICAjIExldCB0aGUgb3JpZ2luYWwgbG9hZGVyIGNyZWF0ZSB0aGUgbW9k
dWxlCiAgICAgICAgcmV0dXJuIHNlbGYub3JpZ2luYWxfbG9hZGVyLmNyZWF0ZV9tb2R1bGUoc3Bl
YykKCiAgICBkZWYgZXhlY19tb2R1bGUoc2VsZiwgbW9kdWxlKToKICAgICAgICAjIEZpcnN0IGV4
ZWN1dGUgdGhlIHJlYWwgbW9kdWxlCiAgICAgICAgc2VsZi5vcmlnaW5hbF9sb2FkZXIuZXhlY19t
b2R1bGUobW9kdWxlKQoKICAgICAgICAjIE5vdyBwYXRjaCB0aGUgc2hvdyBmdW5jdGlvbgogICAg
ICAgIGlmIGhhc2F0dHIobW9kdWxlLCAnc2hvdycpOgogICAgICAgICAgICAjIFN0b3JlIHRoZSBv
cmlnaW5hbCBzaG93IGZ1bmN0aW9uCiAgICAgICAgICAgIG9yaWdpbmFsX3Nob3cgPSBtb2R1bGUu
c2hvdwoKICAgICAgICAgICAgIyBEZWZpbmUgb3VyIGN1c3RvbSBzaG93IGZ1bmN0aW9uCiAgICAg
ICAgICAgIGRlZiBjdXN0b21fc2hvdygqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICAgICAg
Z2xvYmFsIHByb2Nlc3NlZF9maWd1cmVzCgogICAgICAgICAgICAgICAgIyBHZXQgYWxsIGN1cnJl
bnQgZmlndXJlIG51bWJlcnMKICAgICAgICAgICAgICAgIGZpZ19udW1zID0gbW9kdWxlLmdldF9m
aWdudW1zKCkKCiAgICAgICAgICAgICAgICAjIENoZWNrIGZvciBuZXcgZmlndXJlcwogICAgICAg
ICAgICAgICAgZm9yIGZpZ19udW0gaW4gZmlnX251bXM6CiAgICAgICAgICAgICAgICAgICAgaWYg
ZmlnX251bSBub3QgaW4gcHJvY2Vzc2VkX2ZpZ3VyZXM6CiAgICAgICAgICAgICAgICAgICAgICAg
ICMgVGhpcyBpcyBhIG5ldyBmaWd1cmUsIHByb2Nlc3MgaXQKICAgICAgICAgICAgICAgICAgICAg
ICAgZmlnID0gbW9kdWxlLmZpZ3VyZShmaWdfbnVtKQogICAgICAgICAgICAgICAgICAgICAgICBl
eHRyYWN0X2FuZF9wcmludF9maWd1cmVfbWV0YWRhdGEoZmlnKQoKICAgICAgICAgICAgICAgICAg
ICAgICAgIyBNYXJrIGFzIHByb2Nlc3NlZAogICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNz
ZWRfZmlndXJlcy5hZGQoZmlnX251bSkKCiAgICAgICAgICAgICAgICAjIENhbGwgdGhlIG9yaWdp
bmFsIHNob3cgZnVuY3Rpb24gd2l0aCBhbGwgYXJndW1lbnRzCiAgICAgICAgICAgICAgICByZXR1
cm4gb3JpZ2luYWxfc2hvdygqYXJncywgKiprd2FyZ3MpCgogICAgICAgICAgICAjIFJlcGxhY2Ug
dGhlIHNob3cgZnVuY3Rpb24gd2l0aCBvdXIgY3VzdG9tIHZlcnNpb24KICAgICAgICAgICAgbW9k
dWxlLnNob3cgPSBjdXN0b21fc2hvdwoKCmRlZiBzZXR1cF91c2VyX2NvZGVfZW52aXJvbm1lbnQo
Y29kZSk6CiAgICAiIiJTZXQgdXAgdGhlIG1vZHVsZSB0byBydW4gdXNlciBjb2RlIGluIiIiCiAg
ICBtb2R1bGUgPSB0eXBlcy5Nb2R1bGVUeXBlKCdfX21haW5fXycpCiAgICBtb2R1bGUuX19maWxl
X18gPSAnPHVzZXJfY29kZT4nCiAgICBzeXMubW9kdWxlc1snX19tYWluX18nXSA9IG1vZHVsZQoK
ICAgICMgQWRkIGNvZGUgdG8gbGluZSBjYWNoZSBmb3IgYmV0dGVyIHRyYWNlYmFja3MKICAgIGNv
ZGVfbGluZXMgPSBjb2RlLnNwbGl0bGluZXMoKQogICAgbGluZWNhY2hlLmNhY2hlWyc8dXNlcl9j
b2RlPiddID0gKAogICAgICAgIGxlbihjb2RlKSwKICAgICAgICBOb25lLAogICAgICAgIGNvZGVf
bGluZXMsCiAgICAgICAgJzx1c2VyX2NvZGU+JwogICAgKQoKICAgIHJldHVybiBtb2R1bGUKCgpk
ZWYgcnVuX3VzZXJfY29kZShjb2RlKToKICAgICIiIlJ1biB0aGUgdXNlciBjb2RlIHdpdGggdGhl
IG1hdHBsb3RsaWIgaW50ZXJjZXB0b3IgaW5zdGFsbGVkIiIiCiAgICAjIEluc3RhbGwgbWF0cGxv
dGxpYiBpbnRlcmNlcHRvcgogICAgc3lzLm1ldGFfcGF0aC5pbnNlcnQoMCwgTWF0cGxvdGxpYkZp
bmRlcigpKQoKICAgICMgU2V0IHVwIGNsZWFuIGVudmlyb25tZW50IGZvciB1c2VyIGNvZGUKICAg
IG1vZHVsZSA9IHNldHVwX3VzZXJfY29kZV9lbnZpcm9ubWVudChjb2RlKQoKICAgICMgQ29tcGls
ZSBhbmQgcnVuIHRoZSBjb2RlCiAgICBjb21waWxlZCA9IGNvbXBpbGUoY29kZSwgJzx1c2VyX2Nv
ZGU+JywgJ2V4ZWMnKQoKICAgICMgRXhlY3V0ZSBpbiB0aGUgbW9kdWxlJ3MgbmFtZXNwYWNlCiAg
ICBleGVjKGNvbXBpbGVkLCBtb2R1bGUuX19kaWN0X18pCgoKaWYgX19uYW1lX18gPT0gJ19fbWFp
bl9fJzoKICAgIHRyeToKICAgICAgICAjIEdldCB0aGUgZW5jb2RlZCB1c2VyIGNvZGUKICAgICAg
ICB1c2VyX2NvZGUgPSBiYXNlNjQuYjY0ZGVjb2RlKCJ7ZW5jb2RlZF9jb2RlfSIpLmRlY29kZSgp
CgogICAgICAgICMgUnVuIHRoZSBjb2RlCiAgICAgICAgcnVuX3VzZXJfY29kZSh1c2VyX2NvZGUp
CiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICMgUHJpbnQgb25seSB0aGUgcmVsZXZhbnQg
cGFydHMgb2YgdGhlIHRyYWNlYmFjawogICAgICAgIGV4Y190eXBlLCBleGNfdmFsdWUsIGV4Y190
YiA9IHN5cy5leGNfaW5mbygpCgogICAgICAgICMgRmlsdGVyIHRyYWNlYmFjayB0byBvbmx5IHNo
b3cgdXNlciBjb2RlIGZyYW1lcwogICAgICAgIGZpbHRlcmVkX3RiID0gW10KICAgICAgICB0YiA9
IGV4Y190YgogICAgICAgIHdoaWxlIHRiIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiB0Yi50
Yl9mcmFtZS5mX2NvZGUuY29fZmlsZW5hbWUgPT0gJzx1c2VyX2NvZGU+JzoKICAgICAgICAgICAg
ICAgIGZpbHRlcmVkX3RiLmFwcGVuZCh0YikKICAgICAgICAgICAgdGIgPSB0Yi50Yl9uZXh0Cgog
ICAgICAgIGlmIGZpbHRlcmVkX3RiOgogICAgICAgICAgICAjIENyZWF0ZSBhIG5ldyB0cmFjZWJh
Y2sgZnJvbSB0aGUgZmlsdGVyZWQgZnJhbWVzCiAgICAgICAgICAgIGV4Y192YWx1ZS5fX3RyYWNl
YmFja19fID0gZmlsdGVyZWRfdGJbLTFdCiAgICAgICAgICAgIHRyYWNlYmFjay5wcmludF9leGNl
cHRpb24oCiAgICAgICAgICAgICAgICBleGNfdHlwZSwgZXhjX3ZhbHVlLCBleGNfdmFsdWUuX190
cmFjZWJhY2tfXykKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEZhbGxiYWNrIGlmIG5vIHVz
ZXIgY29kZSBmcmFtZXMgZm91bmQgLSByYWlzZSB0aGUgb3JpZ2luYWwgZXhjZXB0aW9uIHR5cGUK
ICAgICAgICAgICAgIyB3aXRoIHRoZSBvcmlnaW5hbCBtZXNzYWdlIGJ1dCBjcmVhdGUgYSBmcmVz
aCB0cmFjZWJhY2sKICAgICAgICAgICAgcmFpc2UgZXhjX3R5cGUoc3RyKGV4Y192YWx1ZSkpIGZy
b20gTm9uZQoKICAgICAgICBzeXMuZXhpdCgxKQo=
`
