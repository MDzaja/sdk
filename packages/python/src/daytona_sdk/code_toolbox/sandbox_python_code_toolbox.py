import base64
from typing import Optional

from ..common.code_run_params import CodeRunParams
import re


class SandboxPythonCodeToolbox:
    def get_run_command(self, code: str, params: Optional[CodeRunParams] = None) -> str:
        # Encode the provided code in base64
        base64_code = base64.b64encode(code.encode()).decode()

        # # Override plt.show() method if matplotlib is imported
        # if self._is_matplotlib_imported(code):
        #     code_wrapper = base64.b64decode(PYTHON_CODE_WRAPPER.encode()).decode()
        #     code_wrapper = code_wrapper.replace("{encoded_code}", base64_code)
        #     base64_code = base64.b64encode(code_wrapper.encode()).decode()

        with open("/workspaces/sdk/hack/code_run_python_wrapper.py", "r") as file:
            code_wrapper = file.read()
            code_wrapper = code_wrapper.replace("{encoded_code}", base64_code)
            base64_code = base64.b64encode(code_wrapper.encode()).decode()

        # Build environment variables string
        env_vars = ""
        if params and params.env:
            env_vars = ' '.join(f"{key}='{value}'" for key, value in params.env.items())

        # Build command-line arguments string
        argv = ""
        if params and params.argv:
            argv = " ".join(params.argv)

        # Execute the bootstrapper code directly
        # Use -u flag to ensure unbuffered output for real-time error reporting
        return f""" sh -c '{env_vars} python3 -u -c "exec(__import__(\\\"base64\\\").b64decode(\\\"{base64_code}\\\").decode())" {argv}' """

    @staticmethod
    def _is_matplotlib_imported(code: str) -> bool:
        """Simplified version that only uses regex to check for matplotlib imports"""
        patterns = [
            # Standard imports
            r'^[^#]*import\s+matplotlib',
            r'^[^#]*from\s+matplotlib',
            
            # Dynamic imports
            r'^[^#]*__import__\s*\(\s*[\'"]matplotlib[\'"]',
            r'^[^#]*importlib\.import_module\s*\(\s*[\'"]matplotlib[\'"]',
            
            # Other dynamic loading patterns
            r'^[^#]*loader\.load_module\s*\(\s*[\'"]matplotlib[\'"]',
            r'^[^#]*sys\.modules\[[\'"]matplotlib[\'"]\]',
        ]
        
        for pattern in patterns:
            if re.search(pattern, code, re.MULTILINE):
                return True
        
        return False


PYTHON_CODE_WRAPPER = """
IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIFRoaXMgZmlsZSBjb250YWlucyB0aGUgYm9vdHN0cmFw
cGVyIGNvZGUgZm9yIG1hdHBsb3RsaWIgaW50ZXJjZXB0b3IKIyBJdCB3aWxsIGJlIGxvYWRlZCBh
bmQgYmFzZTY0IGVuY29kZWQgaW4gdGhlIHdvcmtzcGFjZV9weXRob25fY29kZV90b29sYm94LnB5
CgojIFN0YW5kYXJkIGxpYnJhcnkgaW1wb3J0cwppbXBvcnQgc3lzCmltcG9ydCB0eXBlcwppbXBv
cnQgYmFzZTY0CmltcG9ydCBqc29uCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IGxpbmVjYWNoZQpp
bXBvcnQgcmUKaW1wb3J0IGlvCmltcG9ydCBtYXRoCmZyb20gaW1wb3J0bGliLmFiYyBpbXBvcnQg
TWV0YVBhdGhGaW5kZXIsIExvYWRlcgpmcm9tIGltcG9ydGxpYi51dGlsIGltcG9ydCBzcGVjX2Zy
b21fbG9hZGVyLCBmaW5kX3NwZWMKCiMgRmxhZyB0byB0cmFjayBpZiB3ZSd2ZSBhbHJlYWR5IHBh
dGNoZWQgbWF0cGxvdGxpYgpwbHRfcGF0Y2hlZCA9IEZhbHNlCgojIFNldCB0byB0cmFjayBmaWd1
cmUgbnVtYmVycyB0aGF0IGhhdmUgYmVlbiBwcm9jZXNzZWQKcHJvY2Vzc2VkX2ZpZ3VyZXMgPSBz
ZXQoKQoKCmRlZiBleHRyYWN0X2JveF9wbG90X2RhdGEoYXgsIHh0aWNrbGFiZWxzKToKICAgICIi
IkV4dHJhY3QgZGF0YSBmcm9tIGJveCBwbG90cyIiIgogICAgaW1wb3J0IG1hdHBsb3RsaWIucHlw
bG90IGFzIHBsdAogICAgaW1wb3J0IG1hdGggICMgVXNlIG1hdGggaW5zdGVhZCBvZiBudW1weQog
ICAgaW1wb3J0IG1hdHBsb3RsaWIucGF0Y2hlcwoKICAgIGVsZW1lbnRzID0gW10KICAgICMgRmlu
ZCBhbGwgYm94IHBsb3QgZWxlbWVudHMKICAgIGJveGVzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBh
eC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgIGNoaWxkLCBtYXRwbG90bGli
LnBhdGNoZXMuUGF0aFBhdGNoKV0KICAgIHdoaXNrZXJzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBh
eC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgIGNoaWxkLCBwbHQuTGluZTJE
KSBhbmQgY2hpbGQuZ2V0X2xpbmVzdHlsZSgpID09ICctJ10KICAgIGNhcHMgPSBbY2hpbGQgZm9y
IGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2UoCiAgICAgICAgY2hpbGQs
IHBsdC5MaW5lMkQpIGFuZCBjaGlsZC5nZXRfbWFya2VyKCkgPT0gJ18nXQogICAgbWVkaWFucyA9
IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkgaWYgaXNpbnN0YW5jZSgKICAg
ICAgICBjaGlsZCwgcGx0LkxpbmUyRCkgYW5kIGNoaWxkLmdldF9saW5lc3R5bGUoKSA9PSAnLScg
YW5kIChjaGlsZC5nZXRfY29sb3IoKSA9PSAnb3JhbmdlJyBvciBjaGlsZC5nZXRfY29sb3IoKSA9
PSAncmVkJyldCiAgICBmbGllcnMgPSBbY2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJl
bigpIGlmIGlzaW5zdGFuY2UoCiAgICAgICAgY2hpbGQsIHBsdC5MaW5lMkQpIGFuZCBjaGlsZC5n
ZXRfbWFya2VyKCkgPT0gJ28nXQoKICAgICMgUHJvY2VzcyBlYWNoIGJveCBwbG90CiAgICBmb3Ig
aWR4IGluIHJhbmdlKGxlbihib3hlcykpOgogICAgICAgICMgR2V0IHN0YXRpc3RpY2FsIHZhbHVl
cwogICAgICAgIGJveCA9IGJveGVzW2lkeF0KICAgICAgICBwYXRoID0gYm94LmdldF9wYXRoKCkK
ICAgICAgICB2ZXJ0aWNlcyA9IHBhdGgudmVydGljZXMKCiAgICAgICAgIyBCb3ggY29vcmRpbmF0
ZXMKICAgICAgICB5X3ZhbHVlcyA9IHZlcnRpY2VzWzosIDFdICAjIEdldCBhbGwgeS1jb29yZGlu
YXRlcwogICAgICAgIHNvcnRlZF95ID0gc29ydGVkKHNldCh5X3ZhbHVlcykpICAjIFJlbW92ZSBk
dXBsaWNhdGVzIGFuZCBzb3J0CgogICAgICAgICMgRW5zdXJlIHdlIGhhdmUgZW5vdWdoIHZhbHVl
cyAoYXQgbGVhc3QgNSBmb3IgbWluLCBxMSwgbWVkaWFuLCBxMywgbWF4KQogICAgICAgIGlmIGxl
bihzb3J0ZWRfeSkgPCA1OgoKICAgICAgICAgICAgIyBJZiB3ZSBjYW4ndCBleHRyYWN0IGZyb20g
cGF0aCB2ZXJ0aWNlcywgdHJ5IHRvIGZpbmQgbWluIGFuZCBtYXggZnJvbSB3aGlza2VycwogICAg
ICAgICAgICBpZiBpZHggPCBsZW4od2hpc2tlcnMpIC8vIDI6CiAgICAgICAgICAgICAgICBsb3dl
cl93aGlza2VyID0gd2hpc2tlcnNbaWR4KjJdCiAgICAgICAgICAgICAgICB1cHBlcl93aGlza2Vy
ID0gd2hpc2tlcnNbaWR4KjIgKyAxXQoKICAgICAgICAgICAgICAgIHlfbWluID0gZmxvYXQobWlu
KGxvd2VyX3doaXNrZXIuZ2V0X3lkYXRhKCkpKQogICAgICAgICAgICAgICAgeV9tYXggPSBmbG9h
dChtYXgodXBwZXJfd2hpc2tlci5nZXRfeWRhdGEoKSkpCgogICAgICAgICAgICAgICAgIyBHZXQg
bWVkaWFuIGZyb20gbWVkaWFuIGxpbmUKICAgICAgICAgICAgICAgIG1lZGlhbl92YWx1ZSA9IGZs
b2F0KDAuMCkKICAgICAgICAgICAgICAgIGlmIGlkeCA8IGxlbihtZWRpYW5zKToKICAgICAgICAg
ICAgICAgICAgICAjIFVzZSBhdmVyYWdlIGluc3RlYWQgb2YgbnVtcHkgbWVhbgogICAgICAgICAg
ICAgICAgICAgIHlfZGF0YSA9IG1lZGlhbnNbaWR4XS5nZXRfeWRhdGEoKQogICAgICAgICAgICAg
ICAgICAgIG1lZGlhbl92YWx1ZSA9IGZsb2F0KHN1bSh5X2RhdGEpIC8gbGVuKHlfZGF0YSkpCgog
ICAgICAgICAgICAgICAgIyBVc2UgYXBwcm94aW1hdGVkIHZhbHVlcyBmb3IgcXVhcnRpbGVzCiAg
ICAgICAgICAgICAgICBxMSA9IGZsb2F0KHlfbWluICsgKG1lZGlhbl92YWx1ZSAtIHlfbWluKSAv
IDIpCiAgICAgICAgICAgICAgICBxMyA9IGZsb2F0KG1lZGlhbl92YWx1ZSArICh5X21heCAtIG1l
ZGlhbl92YWx1ZSkgLyAyKQoKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSB7CiAgICAgICAgICAg
ICAgICAgICAgImxhYmVsIjogeHRpY2tsYWJlbHNbaWR4XSBpZiBpZHggPCBsZW4oeHRpY2tsYWJl
bHMpIGVsc2UgZiJCb3gge2lkeCArIDF9IiwKICAgICAgICAgICAgICAgICAgICAibWluIjogeV9t
aW4sCiAgICAgICAgICAgICAgICAgICAgImZpcnN0X3F1YXJ0aWxlIjogcTEsCiAgICAgICAgICAg
ICAgICAgICAgIm1lZGlhbiI6IG1lZGlhbl92YWx1ZSwKICAgICAgICAgICAgICAgICAgICAidGhp
cmRfcXVhcnRpbGUiOiBxMywKICAgICAgICAgICAgICAgICAgICAibWF4IjogeV9tYXgsCiAgICAg
ICAgICAgICAgICAgICAgIm91dGxpZXJzIjogW10KICAgICAgICAgICAgICAgIH0KICAgICAgICAg
ICAgZWxzZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZWxzZToKICAgICAgICAg
ICAgIyBFeHRyYWN0IHN0YXRpc3RpY2FsIHZhbHVlcwogICAgICAgICAgICBlbGVtZW50ID0gewog
ICAgICAgICAgICAgICAgImxhYmVsIjogeHRpY2tsYWJlbHNbaWR4XSBpZiBpZHggPCBsZW4oeHRp
Y2tsYWJlbHMpIGVsc2UgZiJCb3gge2lkeCArIDF9IiwKICAgICAgICAgICAgICAgICJtaW4iOiBm
bG9hdChzb3J0ZWRfeVswXSksICAjIEJvdHRvbSB3aGlza2VyCiAgICAgICAgICAgICAgICAiZmly
c3RfcXVhcnRpbGUiOiBmbG9hdChzb3J0ZWRfeVsxXSksICAjIEJvdHRvbSBvZiBib3gKICAgICAg
ICAgICAgICAgICJtZWRpYW4iOiBmbG9hdChzb3J0ZWRfeVsyXSksICAjIE1lZGlhbiBsaW5lCiAg
ICAgICAgICAgICAgICAidGhpcmRfcXVhcnRpbGUiOiBmbG9hdChzb3J0ZWRfeVszXSksICAjIFRv
cCBvZiBib3gKICAgICAgICAgICAgICAgICJtYXgiOiBmbG9hdChzb3J0ZWRfeVs0XSksICAjIFRv
cCB3aGlza2VyCiAgICAgICAgICAgICAgICAib3V0bGllcnMiOiBbXSAgIyBXaWxsIGJlIHBvcHVs
YXRlZCBpZiB0aGVyZSBhcmUgYW55CiAgICAgICAgICAgIH0KCiAgICAgICAgIyBHZXQgb3V0bGll
cnMgaWYgYW55IGV4aXN0CiAgICAgICAgZm9yIGZsaWVyIGluIGZsaWVyczoKICAgICAgICAgICAg
aWYgZmxpZXIuZ2V0X3lkYXRhKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBvdXRsaWVy
cyA9IFtmbG9hdCh5KSBmb3IgeSBpbiBmbGllci5nZXRfeWRhdGEoKV0KICAgICAgICAgICAgICAg
IGlmIG91dGxpZXJzOgogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbIm91dGxpZXJzIl0gPSBv
dXRsaWVycwogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGVsZW1lbnRzLmFwcGVu
ZChlbGVtZW50KQoKICAgIHJldHVybiBlbGVtZW50cwoKCmRlZiBleHRyYWN0X2xpbmVfcGxvdF9k
YXRhKGF4KToKICAgICIiIkV4dHJhY3QgZGF0YSBmcm9tIGxpbmUgcGxvdHMiIiIKICAgIGVsZW1l
bnRzID0gW10KCiAgICAjIEdldCBhbGwgbGluZXMgLSBpbXByb3ZlIGRldGVjdGlvbiB0byBmaW5k
IG1vcmUgcG9zc2libGUgbGluZSBvYmplY3RzCiAgICBsaW5lcyA9IGF4LmdldF9saW5lcygpCgog
ICAgIyBQcm9jZXNzIGVhY2ggbGluZQogICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgbGFi
ZWwgPSBsaW5lLmdldF9sYWJlbCgpCiAgICAgICAgeF9kYXRhID0gbGluZS5nZXRfeGRhdGEoKQog
ICAgICAgIHlfZGF0YSA9IGxpbmUuZ2V0X3lkYXRhKCkKICAgICAgICBwb2ludHMgPSBbXQoKICAg
ICAgICBmb3IgXywgKHgsIHkpIGluIGVudW1lcmF0ZSh6aXAoeF9kYXRhLCB5X2RhdGEpKToKICAg
ICAgICAgICAgcG9pbnRzLmFwcGVuZCgoeCwgeSkpCgogICAgICAgIGVsZW1lbnQgPSB7CiAgICAg
ICAgICAgICJsYWJlbCI6IGxhYmVsIGlmIGxhYmVsIGlzIG5vdCBOb25lIGVsc2UgZiJMaW5lIHts
ZW4oZWxlbWVudHMpICsgMX0iLAogICAgICAgICAgICAicG9pbnRzIjogcG9pbnRzCiAgICAgICAg
fQogICAgICAgIGVsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoKICAgIHJldHVybiBlbGVtZW50cwoK
CmRlZiBleHRyYWN0X3NjYXR0ZXJfcGxvdF9kYXRhKGF4KToKICAgICIiIkV4dHJhY3QgZGF0YSBm
cm9tIHNjYXR0ZXIgcGxvdHMiIiIKICAgIGltcG9ydCBtYXRwbG90bGliLmNvbGxlY3Rpb25zCiAg
ICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICBpbXBvcnQgbWF0cGxvdGxpYi5j
bQogICAgaW1wb3J0IG1hdHBsb3RsaWIuY29sb3JzCgogICAgZWxlbWVudHMgPSBbXQogICAgIyBH
ZXQgYWxsIHNjYXR0ZXIgcGxvdHMKICAgIHNjYXR0ZXJzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBh
eC5nZXRfY2hpbGRyZW4oKQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjaGlsZCwgbWF0
cGxvdGxpYi5jb2xsZWN0aW9ucy5QYXRoQ29sbGVjdGlvbildCgogICAgIyBQcm9jZXNzIGVhY2gg
c2NhdHRlciBwbG90CiAgICBmb3IgaWR4LCBzY2F0dGVyIGluIGVudW1lcmF0ZShzY2F0dGVycyk6
CiAgICAgICAgIyBHZXQgdGhlIHNjYXR0ZXIgcG9pbnRzCiAgICAgICAgb2Zmc2V0cyA9IHNjYXR0
ZXIuZ2V0X29mZnNldHMoKQogICAgICAgIGlmIG9mZnNldHMgaXMgbm90IE5vbmUgYW5kIGxlbihv
ZmZzZXRzKSA+IDA6CiAgICAgICAgICAgICMgQ29udmVydCB0byBsaXN0IGlmIG5lZWRlZAogICAg
ICAgICAgICBvZmZzZXRzID0gb2Zmc2V0cy50b2xpc3QoKSBpZiBoYXNhdHRyKG9mZnNldHMsICd0
b2xpc3QnKSBlbHNlIGxpc3Qob2Zmc2V0cykKCiAgICAgICAgICAgICMgRW5zdXJlIHZhbHVlcyBh
cmUgZmxvYXQgZm9yIEpTT04gc2VyaWFsaXphdGlvbgogICAgICAgICAgICAjIEZpbHRlciBvdXQg
YW55IHBvaW50cyB3aXRoIE5vbmUgb3IgTmFOIHZhbHVlcwogICAgICAgICAgICBwb2ludHMgPSBb
XQogICAgICAgICAgICBmb3IgcG9pbnQgaW4gb2Zmc2V0czoKICAgICAgICAgICAgICAgIHRyeToK
ICAgICAgICAgICAgICAgICAgICB4LCB5ID0gcG9pbnQKICAgICAgICAgICAgICAgICAgICBpZiAo
eCBpcyBub3QgTm9uZSBhbmQgeSBpcyBub3QgTm9uZSBhbmQKICAgICAgICAgICAgICAgICAgICAg
ICAgbm90IChpc2luc3RhbmNlKHgsIGZsb2F0KSBhbmQgbWF0aC5pc25hbih4KSkgYW5kCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBub3QgKGlzaW5zdGFuY2UoeSwgZmxvYXQpIGFuZCBtYXRo
LmlzbmFuKHkpKSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cy5hcHBlbmQoW2Zsb2F0
KHgpLCBmbG9hdCh5KV0pCiAgICAgICAgICAgICAgICBleGNlcHQgKFR5cGVFcnJvciwgVmFsdWVF
cnJvcik6CiAgICAgICAgICAgICAgICAgICAgIyBTa2lwIGludmFsaWQgcG9pbnRzCiAgICAgICAg
ICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgT25seSBwcm9jZWVkIGlmIHdlIGhh
dmUgdmFsaWQgcG9pbnRzCiAgICAgICAgICAgIGlmIHBvaW50czoKICAgICAgICAgICAgICAgICMg
VHJ5IHRvIGdldCBjb2xvcm1hcCBpbmZvcm1hdGlvbiBpZiBhdmFpbGFibGUKICAgICAgICAgICAg
ICAgIGNvbG9ycyA9IE5vbmUKICAgICAgICAgICAgICAgIGhhc19jb2xvcmJhciA9IEZhbHNlCgog
ICAgICAgICAgICAgICAgIyBBdHRlbXB0IHRvIGdldCBhcnJheSBkYXRhIGZvciBjb2xvciBtYXBw
aW5nCiAgICAgICAgICAgICAgICBhcnJheV9kYXRhID0gc2NhdHRlci5nZXRfYXJyYXkoKQogICAg
ICAgICAgICAgICAgaWYgYXJyYXlfZGF0YSBpcyBub3QgTm9uZSBhbmQgbGVuKGFycmF5X2RhdGEp
ID4gMDoKICAgICAgICAgICAgICAgICAgICBoYXNfY29sb3JiYXIgPSBUcnVlCiAgICAgICAgICAg
ICAgICAgICAgIyBHZXQgdGhlIGNvbG9ybWFwIGlmIHBvc3NpYmxlCiAgICAgICAgICAgICAgICAg
ICAgY21hcF9uYW1lID0gInVua25vd24iCiAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihz
Y2F0dGVyLCAiZ2V0X2NtYXAiKSBhbmQgc2NhdHRlci5nZXRfY21hcCgpIGlzIG5vdCBOb25lOgog
ICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBj
bWFwX25hbWUgPSBzY2F0dGVyLmdldF9jbWFwKCkubmFtZQogICAgICAgICAgICAgICAgICAgICAg
ICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWFwX25hbWUgPSAidW5rbm93
biIKCiAgICAgICAgICAgICAgICAgICAgIyBDb252ZXJ0IGFycmF5IGRhdGEgZm9yIEpTT04KICAg
ICAgICAgICAgICAgICAgICBhcnJheV9kYXRhID0gYXJyYXlfZGF0YS50b2xpc3QoKSBpZiBoYXNh
dHRyKAogICAgICAgICAgICAgICAgICAgICAgICBhcnJheV9kYXRhLCAndG9saXN0JykgZWxzZSBs
aXN0KGFycmF5X2RhdGEpCiAgICAgICAgICAgICAgICAgICAgIyBGaWx0ZXIgb3V0IE5vbmUgb3Ig
TmFOIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIGNvbG9ycyA9IFtdCiAgICAgICAgICAgICAg
ICAgICAgZm9yIGMgaW4gYXJyYXlfZGF0YToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYyBp
cyBub3QgTm9uZSBhbmQgbm90IChpc2luc3RhbmNlKGMsIGZsb2F0KSBhbmQgbWF0aC5pc25hbihj
KSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcnMuYXBwZW5kKGZsb2F0KGMpKQog
ICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAg
Y29sb3JzLmFwcGVuZCgwLjApICAjIERlZmF1bHQgY29sb3IgdmFsdWUKCiAgICAgICAgICAgICAg
ICAjIEdldCBsYWJlbCwgd2l0aCBmYWxsYmFjawogICAgICAgICAgICAgICAgbGFiZWwgPSBzY2F0
dGVyLmdldF9sYWJlbCgpCiAgICAgICAgICAgICAgICAjIE1hdHBsb3RsaWIgdXNlcyAnXycgcHJl
Zml4IGZvciBhdXRvLWdlbmVyYXRlZCBsYWJlbHMKICAgICAgICAgICAgICAgIGlmIGxhYmVsIGlz
IE5vbmUgb3IgbGFiZWwuc3RhcnRzd2l0aCgnXycpOgogICAgICAgICAgICAgICAgICAgIGxhYmVs
ID0gZiJTY2F0dGVyIHtpZHggKyAxfSIKCiAgICAgICAgICAgICAgICBlbGVtZW50ID0gewogICAg
ICAgICAgICAgICAgICAgICJsYWJlbCI6IGxhYmVsIGlmIGxhYmVsIGlzIG5vdCBOb25lIGVsc2Ug
ZiJTY2F0dGVyIHtpZHggKyAxfSIsCiAgICAgICAgICAgICAgICAgICAgInBvaW50cyI6IHBvaW50
cwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICMgQWRkIGNvbG9yIGluZm9ybWF0
aW9uIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgaGFzX2NvbG9yYmFyIGFuZCBjb2xv
cnMgYW5kIGxlbihjb2xvcnMpID09IGxlbihwb2ludHMpOgogICAgICAgICAgICAgICAgICAgIGVs
ZW1lbnRbImNvbG9ycyJdID0gY29sb3JzCiAgICAgICAgICAgICAgICBlbGlmIGhhc19jb2xvcmJh
ciBhbmQgY29sb3JzOgogICAgICAgICAgICAgICAgICAgICMgSWYgY29sb3IgbGVuZ3RocyBkb24n
dCBtYXRjaCwgdHJ1bmNhdGUgb3IgZXh0ZW5kCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGNv
bG9ycykgPiBsZW4ocG9pbnRzKToKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFsiY29s
b3JzIl0gPSBjb2xvcnNbOmxlbihwb2ludHMpXQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAg
ICAgICAgICAgICAgICAgICAgICAgICMgRXh0ZW5kIHdpdGggZGVmYXVsdHMKICAgICAgICAgICAg
ICAgICAgICAgICAgZWxlbWVudFsiY29sb3JzIl0gPSBjb2xvcnMgKyBbMC4wXSAqIFwKICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIChsZW4ocG9pbnRzKSAtIGxlbihjb2xvcnMpKQoKICAgICAg
ICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoKICAgIHJldHVybiBlbGVtZW50cwoK
CmRlZiBleHRyYWN0X2Jhcl9jaGFydF9kYXRhKGF4LCB4dGlja2xhYmVscyk6CiAgICAiIiJFeHRy
YWN0IGRhdGEgZnJvbSBiYXIgY2hhcnRzIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3Qg
YXMgcGx0CiAgICBpbXBvcnQgbWF0cGxvdGxpYi5wYXRjaGVzCgogICAgZWxlbWVudHMgPSBbXQog
ICAgIyBGaXJzdCBsb29rIGZvciBzdGFuZGFyZCBSZWN0YW5nbGUgb2JqZWN0cwogICAgYmFycyA9
IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkKICAgICAgICAgICAgaWYgaXNp
bnN0YW5jZShjaGlsZCwgcGx0LlJlY3RhbmdsZSkgYW5kIGhhc2F0dHIoY2hpbGQsICdnZXRfaGVp
Z2h0JykgYW5kIGNoaWxkLmdldF9oZWlnaHQoKSA+IDBdCgogICAgIyBJZiBubyBzdGFuZGFyZCBy
ZWN0YW5nbGVzIGZvdW5kLCBjaGVjayBmb3IgcGF0Y2ggcmVjdGFuZ2xlcwogICAgaWYgbGVuKGJh
cnMpID09IDA6CiAgICAgICAgYmFycyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxk
cmVuKCkKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hpbGQsIG1hdHBsb3RsaWIucGF0
Y2hlcy5SZWN0YW5nbGUpIGFuZCBoYXNhdHRyKGNoaWxkLCAnZ2V0X2hlaWdodCcpIGFuZCBjaGls
ZC5nZXRfaGVpZ2h0KCkgPiAwXQoKICAgICMgSWYgd2Ugc3RpbGwgZG9uJ3QgaGF2ZSBiYXJzLCBs
b29rIGZvciBwYXRjaGVzIHRoYXQgbWlnaHQgYmUgcGFydCBvZiBiYXIgY2hhcnRzCiAgICBpZiBs
ZW4oYmFycykgPT0gMDoKICAgICAgICAjIEluIG5ld2VyIG1hdHBsb3RsaWIgdmVyc2lvbnMsIGJh
cnMgbWlnaHQgYmUgUGF0aFBhdGNoZXMgd2l0aG91dCBnZXRfaGVpZ2h0IG1ldGhvZAogICAgICAg
ICMgSW4gdGhpcyBjYXNlLCB0cnkgdG8gZ2V0IHRoZSBwYXRjaCB2ZXJ0aWNlcwogICAgICAgIHBh
dGNoZXMgPSBbY2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpCiAgICAgICAgICAg
ICAgICAgICBpZiBpc2luc3RhbmNlKGNoaWxkLCBtYXRwbG90bGliLnBhdGNoZXMuUGF0aFBhdGNo
KV0KICAgICAgICBiYXJfbGlrZV9wYXRjaGVzID0gW10KCiAgICAgICAgZm9yIHBhdGNoIGluIHBh
dGNoZXM6CiAgICAgICAgICAgICMgVHJ5IHRvIGVzdGltYXRlIGlmIHRoaXMgcGF0Y2ggaXMgbGlr
ZWx5IGEgYmFyCiAgICAgICAgICAgIHBhdGggPSBwYXRjaC5nZXRfcGF0aCgpCiAgICAgICAgICAg
IHZlcnRpY2VzID0gcGF0aC52ZXJ0aWNlcwogICAgICAgICAgICBpZiBsZW4odmVydGljZXMpID49
IDQ6ICAjIEJhcnMgdHlwaWNhbGx5IGhhdmUgYXQgbGVhc3QgNCB2ZXJ0aWNlcwogICAgICAgICAg
ICAgICAgIyBDaGVjayBpZiB0aGUgcGF0Y2ggaGFzIGEgcmVjdGFuZ3VsYXIgc2hhcGUgKGFwcHJv
eGltYXRlKQogICAgICAgICAgICAgICAgeHMgPSB2ZXJ0aWNlc1s6LCAwXQogICAgICAgICAgICAg
ICAgeXMgPSB2ZXJ0aWNlc1s6LCAxXQogICAgICAgICAgICAgICAgd2lkdGggPSBtYXgoeHMpIC0g
bWluKHhzKQogICAgICAgICAgICAgICAgaGVpZ2h0ID0gbWF4KHlzKSAtIG1pbih5cykKCiAgICAg
ICAgICAgICAgICBpZiB3aWR0aCA+IDAgYW5kIGhlaWdodCA+IDA6CiAgICAgICAgICAgICAgICAg
ICAgIyBBZGQgYSBnZXRfaGVpZ2h0IG1ldGhvZCB0byB0aGUgcGF0Y2gKICAgICAgICAgICAgICAg
ICAgICBwYXRjaC5nZXRfaGVpZ2h0ID0gbGFtYmRhOiBoZWlnaHQKICAgICAgICAgICAgICAgICAg
ICBwYXRjaC55X2Jhc2UgPSBtaW4oeXMpCiAgICAgICAgICAgICAgICAgICAgYmFyX2xpa2VfcGF0
Y2hlcy5hcHBlbmQocGF0Y2gpCgogICAgICAgIGJhcnMgPSBiYXJfbGlrZV9wYXRjaGVzCgogICAg
IyBFeHRyYWN0IGJhciBkYXRhCiAgICByYXdfZWxlbWVudHMgPSBbXQogICAgZm9yIGlkeCwgYmFy
IGluIGVudW1lcmF0ZShiYXJzKToKICAgICAgICAjIFRyeSB0byBnZXQgYSBtZWFuaW5nZnVsIGxh
YmVsCiAgICAgICAgaWYgaWR4IDwgbGVuKHh0aWNrbGFiZWxzKToKICAgICAgICAgICAgbGFiZWwg
PSB4dGlja2xhYmVsc1tpZHhdCiAgICAgICAgICAgICMgRW5zdXJlIGxhYmVsIGlzIGEgc3RyaW5n
IGFuZCBub3QgTm9uZQogICAgICAgICAgICBpZiBsYWJlbCBpcyBOb25lOgogICAgICAgICAgICAg
ICAgbGFiZWwgPSBmIkJhciB7aWR4ICsgMX0iCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGFi
ZWwgPSBmIkJhciB7aWR4ICsgMX0iCgogICAgICAgICMgVHJ5IHRvIGV4dHJhY3QgYWN0dWFsIHRl
eHQgZnJvbSBUZXh0IG9iamVjdHMgaWYgbmVlZGVkCiAgICAgICAgaWYgaXNpbnN0YW5jZShsYWJl
bCwgc3RyKSBhbmQgbGFiZWwuc3RhcnRzd2l0aCgiVGV4dCgiKToKICAgICAgICAgICAgbWF0Y2gg
PSByZS5zZWFyY2gociInKFteJ10qKSciLCBsYWJlbCkKICAgICAgICAgICAgaWYgbWF0Y2g6CiAg
ICAgICAgICAgICAgICBsYWJlbCA9IG1hdGNoLmdyb3VwKDEpCiAgICAgICAgICAgIGVsc2U6CiAg
ICAgICAgICAgICAgICAjIElmIG5vIG1hdGNoIGlzIGZvdW5kLCB1c2UgYSBkZWZhdWx0IGxhYmVs
CiAgICAgICAgICAgICAgICBsYWJlbCA9IGYiQmFyIHtpZHggKyAxfSIKCiAgICAgICAgIyBHZXQg
Z3JvdXAvY2F0ZWdvcnkgaWYgYXZhaWxhYmxlCiAgICAgICAgZ3JvdXAgPSBiYXIuZ2V0X2xhYmVs
KCkKICAgICAgICBpZiBncm91cCBpcyBOb25lIG9yIG5vdCBncm91cCBvciBncm91cC5zdGFydHN3
aXRoKCdfJyk6CiAgICAgICAgICAgIGdyb3VwID0gImRlZmF1bHQiCgogICAgICAgIHZhbHVlID0g
ZmxvYXQoYmFyLmdldF9oZWlnaHQoKSkKICAgICAgICAjIEVuc3VyZSB2YWx1ZSBpcyBub3QgTm9u
ZSBvciBOYU4KICAgICAgICBpZiB2YWx1ZSBpcyBOb25lIG9yIChpc2luc3RhbmNlKHZhbHVlLCBm
bG9hdCkgYW5kIG1hdGguaXNuYW4odmFsdWUpKToKICAgICAgICAgICAgdmFsdWUgPSAxLjAKCiAg
ICAgICAgZWxlbWVudCA9IHsKICAgICAgICAgICAgImxhYmVsIjogbGFiZWwgaWYgbGFiZWwgaXMg
bm90IE5vbmUgZWxzZSBmIkJhciB7aWR4ICsgMX0iLAogICAgICAgICAgICAiZ3JvdXAiOiBncm91
cCBpZiBncm91cCBpcyBub3QgTm9uZSBlbHNlICJkZWZhdWx0IiwKICAgICAgICAgICAgInZhbHVl
IjogdmFsdWUgaWYgdmFsdWUgaXMgbm90IE5vbmUgZWxzZSAxLjAKICAgICAgICB9CiAgICAgICAg
cmF3X2VsZW1lbnRzLmFwcGVuZChlbGVtZW50KQoKICAgICMgRmlsdGVyIG91dCBsaWtlbHkgYXJ0
aWZhY3QgYmFyczoKICAgICMgMS4gQmFycyB3aXRoIHZlcnkgc21hbGwgdmFsdWVzICgxLjApIHRo
YXQgYXJlIGF1dG8tbGFiZWxlZCAoQmFyIFgpCiAgICAjIDIuIERlZmF1bHQgZ3JvdXAKICAgIGVs
ZW1lbnRzID0gW10KICAgIGZvciBlbGVtIGluIHJhd19lbGVtZW50czoKICAgICAgICAjIFNraXAg
bGlrZWx5IGFydGlmYWN0IGJhcnMgKHRob3NlIHdpdGggdmFsdWUgMS4wLCBsYWJlbCBzdGFydGlu
ZyB3aXRoICJCYXIiLCBhbmQgZGVmYXVsdCBncm91cCkKICAgICAgICBpc19hcnRpZmFjdCA9ICgK
ICAgICAgICAgICAgYWJzKGVsZW1bInZhbHVlIl0gLSAxLjApIDwgMC4wMDAxIGFuZCAgIyBWYWx1
ZSBpcyAxLjAKICAgICAgICAgICAgaXNpbnN0YW5jZShlbGVtWyJsYWJlbCJdLCBzdHIpIGFuZAog
ICAgICAgICAgICBlbGVtWyJsYWJlbCJdLnN0YXJ0c3dpdGgoIkJhciIpIGFuZCAgICMgQXV0by1n
ZW5lcmF0ZWQgbGFiZWwKICAgICAgICAgICAgZWxlbVsiZ3JvdXAiXSA9PSAiZGVmYXVsdCIgICAg
ICAgICAgICAjIERlZmF1bHQgZ3JvdXAKICAgICAgICApCgogICAgICAgIGlmIG5vdCBpc19hcnRp
ZmFjdDoKICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGVsZW0pCgogICAgcmV0dXJuIGVsZW1l
bnRzCgoKZGVmIGV4dHJhY3RfcGllX2NoYXJ0X2RhdGEoYXgpOgogICAgaW1wb3J0IG1hdHBsb3Rs
aWIucHlwbG90IGFzIHBsdAogICAgaW1wb3J0IG1hdHBsb3RsaWIucGF0Y2hlcwogICAgCiAgICBl
bGVtZW50cyA9IFtdCiAgICAKICAgICMgR2V0IGFsbCB3ZWRnZXMgZnJvbSB0aGUgYXhpcwogICAg
d2VkZ2VzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBheC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3Rh
bmNlKGNoaWxkLCBtYXRwbG90bGliLnBhdGNoZXMuV2VkZ2UpXQogICAgCiAgICAjIEdldCBhbGwg
dGV4dCBvYmplY3RzIChsYWJlbHMgJiBwZXJjZW50YWdlcykKICAgIHRleHRfb2JqZWN0cyA9IFtj
aGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkgaWYgaXNpbnN0YW5jZShjaGlsZCwg
cGx0LlRleHQpXQogICAgCiAgICBsYWJlbHMgPSBbXQogICAgYXV0b3BjdF92YWx1ZXMgPSBbXQog
ICAgCiAgICAjIERldGVybWluZSBjZW50ZXIgb2YgcGllIGNoYXJ0CiAgICBwaWVfY2VudGVyX3gs
IHBpZV9jZW50ZXJfeSA9IDAsIDAgICMgQXNzdW1pbmcgdGhlIHBpZSBjaGFydCBpcyBjZW50ZXJl
ZCBhdCAoMCwwKQogICAgCiAgICAjIFNlcGFyYXRlIGxhYmVscyAmIGF1dG9wY3QgdmFsdWVzIGJh
c2VkIG9uIHBvc2l0aW9uCiAgICBmb3IgdGV4dCBpbiB0ZXh0X29iamVjdHM6CiAgICAgICAgdGV4
dF92YWx1ZSA9IHRleHQuZ2V0X3RleHQoKS5zdHJpcCgpCiAgICAgICAgaWYgbm90IHRleHRfdmFs
dWU6CiAgICAgICAgICAgIGNvbnRpbnVlICAjIFNraXAgZW1wdHkgdGV4dCBvYmplY3RzCgogICAg
ICAgICMgR2V0IHRleHQgcG9zaXRpb24KICAgICAgICBiYm94ID0gdGV4dC5nZXRfd2luZG93X2V4
dGVudChyZW5kZXJlcj1heC5maWd1cmUuY2FudmFzLmdldF9yZW5kZXJlcigpKQogICAgICAgIHRl
eHRfeCwgdGV4dF95ID0gYmJveC54MCwgYmJveC55MCAgIyBBcHByb3hpbWF0ZSBwb3NpdGlvbgoK
ICAgICAgICAjIENvbXBhcmUgcG9zaXRpb246IGxhYmVscyB0ZW5kIHRvIGJlIGZ1cnRoZXIgZnJv
bSB0aGUgcGllIGNlbnRlcgogICAgICAgIG1heF93ZWRnZV9yYWRpdXMgPSBtYXgod2VkZ2UuciBm
b3Igd2VkZ2UgaW4gd2VkZ2VzKSAgIyBHZXQgbWF4IHdlZGdlIHJhZGl1cwoKICAgICAgICAjIEhl
dXJpc3RpYzogSWYgdGV4dCBpcyBmdXJ0aGVyIGZyb20gdGhlIGNlbnRlciB0aGFuIHRoZSBtYXgg
d2VkZ2UgcmFkaXVzLCBpdCdzIGEgbGFiZWwKICAgICAgICBkaXN0YW5jZV9mcm9tX2NlbnRlciA9
ICgodGV4dF94IC0gcGllX2NlbnRlcl94KSAqKiAyICsgKHRleHRfeSAtIHBpZV9jZW50ZXJfeSkg
KiogMikgKiogMC41CiAgICAgICAgaWYgZGlzdGFuY2VfZnJvbV9jZW50ZXIgPiBtYXhfd2VkZ2Vf
cmFkaXVzICogMC43NTogICMgTGFiZWxzIHVzdWFsbHkgYXBwZWFyIGZ1cnRoZXIgb3V0CiAgICAg
ICAgICAgIGxhYmVscy5hcHBlbmQodGV4dF92YWx1ZSkKICAgICAgICBlbHNlOgogICAgICAgICAg
ICBhdXRvcGN0X3ZhbHVlcy5hcHBlbmQodGV4dF92YWx1ZSkgICMgVmFsdWVzIGFwcGVhciBuZWFy
IHdlZGdlcwoKICAgIHRvdGFsX2FuZ2xlID0gc3VtKHdlZGdlLnRoZXRhMiAtIHdlZGdlLnRoZXRh
MSBmb3Igd2VkZ2UgaW4gd2VkZ2VzKSAgIyBTaG91bGQgYmUgMzYwwrAKICAgIAogICAgZm9yIGlk
eCwgd2VkZ2UgaW4gZW51bWVyYXRlKHdlZGdlcyk6CiAgICAgICAgbGFiZWwgPSBsYWJlbHNbaWR4
XSBpZiBpZHggPCBsZW4obGFiZWxzKSBlbHNlIGYiU2xpY2Uge2lkeCArIDF9IgogICAgICAgIAog
ICAgICAgICMgQ29tcHV0ZSBwcmVjaXNlIHBlcmNlbnRhZ2UgZnJvbSBhbmdsZXMKICAgICAgICBw
ZXJjZW50YWdlID0gKCh3ZWRnZS50aGV0YTIgLSB3ZWRnZS50aGV0YTEpIC8gdG90YWxfYW5nbGUp
ICogMTAwICAjIEV4YWN0IGNhbGN1bGF0aW9uCiAgICAgICAgCiAgICAgICAgIyBHZXQgdGhlIGRp
c3BsYXllZCBhdXRvcGN0IHZhbHVlIChpZiBleGlzdHMpCiAgICAgICAgYXV0b3BjdF92YWx1ZSA9
IGF1dG9wY3RfdmFsdWVzW2lkeF0gaWYgaWR4IDwgbGVuKGF1dG9wY3RfdmFsdWVzKSBlbHNlIE5v
bmUKCiAgICAgICAgZWxlbWVudCA9IHsKICAgICAgICAgICAgImxhYmVsIjogbGFiZWwsCiAgICAg
ICAgICAgICJhbmdsZSI6IGZsb2F0KHdlZGdlLnRoZXRhMiAtIHdlZGdlLnRoZXRhMSksICAjIENv
bnZlcnQgdG8gZmxvYXQKICAgICAgICAgICAgInJhZGl1cyI6IGZsb2F0KHdlZGdlLnIpLCAgIyBD
b252ZXJ0IHRvIGZsb2F0CiAgICAgICAgICAgICJwZXJjZW50YWdlIjogZmxvYXQocGVyY2VudGFn
ZSksICAjIFByZWNpc2UsIHVucm91bmRlZCBwZXJjZW50YWdlCiAgICAgICAgICAgICJhdXRvcGN0
X3ZhbHVlIjogYXV0b3BjdF92YWx1ZSAgIyBUZXh0IGxhYmVsIGZyb20gYXV0b3BjdAogICAgICAg
IH0KICAgICAgICBlbGVtZW50cy5hcHBlbmQoZWxlbWVudCkKCiAgICByZXR1cm4gZWxlbWVudHMK
CgpkZWYgcmVjcmVhdGVfYW5kX3NhdmVfYmFyX2NoYXJ0KGF4LCBlbGVtZW50cywgc3VicGxvdF9h
eCk6CiAgICAiIiJSZWNyZWF0ZSBhIGJhciBjaGFydCBpbiBhIG5ldyBheGlzIiIiCiAgICAjIEZp
bHRlciBvdXQgemVybyB2YWx1ZXMgYW5kIGFueSBlbGVtZW50cyB3aXRoIGRlZmF1bHQgb3IgbnVt
ZXJpYy1vbmx5IGxhYmVscwogICAgZmlsdGVyZWRfZWxlbWVudHMgPSBbXQogICAgZm9yIGVsZW0g
aW4gZWxlbWVudHM6CiAgICAgICAgIyBTa2lwIGVsZW1lbnRzIHdpdGggdmVyeSBzbWFsbCB2YWx1
ZXMKICAgICAgICBpZiBlbGVtWyJ2YWx1ZSJdIDw9IDEuMDoKICAgICAgICAgICAgY29udGludWUK
CiAgICAgICAgIyBTa2lwIGVsZW1lbnRzIHdpdGggZGVmYXVsdCBncm91cCBhbmQgbnVtZXJpYyBs
YWJlbHMgKGxpa2VseSBhcnRpZmFjdHMpCiAgICAgICAgaWYgZWxlbVsiZ3JvdXAiXSA9PSAiZGVm
YXVsdCIgYW5kIGVsZW1bImxhYmVsIl0uaXNkaWdpdCgpOgogICAgICAgICAgICBjb250aW51ZQoK
ICAgICAgICAjIFNraXAgZWxlbWVudHMgd2l0aCBsYWJlbHMgdGhhdCBzdGFydCB3aXRoICJUZXh0
KCIKICAgICAgICAjIGJ1dCBleHRyYWN0IHRoZSBhY3R1YWwgbGFiZWwgaWYgaXQncyBlbWJlZGRl
ZAogICAgICAgIGlmIGlzaW5zdGFuY2UoZWxlbVsibGFiZWwiXSwgc3RyKSBhbmQgZWxlbVsibGFi
ZWwiXS5zdGFydHN3aXRoKCJUZXh0KCIpOgogICAgICAgICAgICAjIFRyeSB0byBleHRyYWN0IHRo
ZSBhY3R1YWwgbGFiZWwgZnJvbSB0aGUgVGV4dCBvYmplY3QgcmVwcmVzZW50YXRpb24KICAgICAg
ICAgICAgbWF0Y2ggPSByZS5zZWFyY2gociInKFteJ10qKSciLCBlbGVtWyJsYWJlbCJdKQogICAg
ICAgICAgICBpZiBtYXRjaDoKICAgICAgICAgICAgICAgIGVsZW1bImxhYmVsIl0gPSBtYXRjaC5n
cm91cCgxKQoKICAgICAgICBmaWx0ZXJlZF9lbGVtZW50cy5hcHBlbmQoZWxlbSkKCiAgICBpZiBm
aWx0ZXJlZF9lbGVtZW50czoKICAgICAgICAjIFVzZSBudW1lcmljIHBvc2l0aW9ucyBmb3IgYmFy
cwogICAgICAgIHBvc2l0aW9ucyA9IGxpc3QocmFuZ2UobGVuKGZpbHRlcmVkX2VsZW1lbnRzKSkp
CiAgICAgICAgbGFiZWxzID0gW2VsZW1bImxhYmVsIl0gZm9yIGVsZW0gaW4gZmlsdGVyZWRfZWxl
bWVudHNdCiAgICAgICAgdmFsdWVzID0gW2VsZW1bInZhbHVlIl0gZm9yIGVsZW0gaW4gZmlsdGVy
ZWRfZWxlbWVudHNdCgogICAgICAgICMgUGxvdCBiYXJzIGF0IG51bWVyaWMgcG9zaXRpb25zCiAg
ICAgICAgc3VicGxvdF9heC5iYXIocG9zaXRpb25zLCB2YWx1ZXMsIGNvbG9yPSdibHVlJykKCiAg
ICAgICAgIyBTZXQgdGhlIHgtdGlja3MgYW5kIGxhYmVscyBvbmx5IGF0IHRoZSBiYXIgcG9zaXRp
b25zCiAgICAgICAgc3VicGxvdF9heC5zZXRfeHRpY2tzKHBvc2l0aW9ucykKICAgICAgICBzdWJw
bG90X2F4LnNldF94dGlja2xhYmVscyhsYWJlbHMpCgogICAgICAgICMgU2V0IGEgc2xpZ2h0bHkg
d2lkZXIgeCBsaW1pdCB0byBnaXZlIHNvbWUgcGFkZGluZwogICAgICAgIHN1YnBsb3RfYXguc2V0
X3hsaW0oLTAuNSwgbGVuKHBvc2l0aW9ucykgLSAwLjUpCiAgICBlbHNlOgogICAgICAgICMgTm8g
dmFsaWQgZWxlbWVudHMgYWZ0ZXIgZmlsdGVyaW5nCiAgICAgICAgc3VicGxvdF9heC50ZXh0KDAu
NSwgMC41LCAiTm8gdmFsaWQgZGF0YSIsIGhhPSdjZW50ZXInLCB2YT0nY2VudGVyJykKCiAgICAj
IEFkZCBsZWdlbmQgaWYgb3JpZ2luYWwgcGxvdCBoYWQgb25lCiAgICBpZiBheC5nZXRfbGVnZW5k
KCk6CiAgICAgICAgc3VicGxvdF9heC5sZWdlbmQoKQoKICAgIHJldHVybiBzdWJwbG90X2F4CgoK
ZGVmIHJlY3JlYXRlX2FuZF9zYXZlX3NjYXR0ZXJfcGxvdChheCwgZWxlbWVudHMsIHN1YnBsb3Rf
YXgpOgogICAgIiIiUmVjcmVhdGUgYSBzY2F0dGVyIHBsb3QgaW4gYSBuZXcgYXhpcyIiIgogICAg
Zm9yIGVsZW0gaW4gZWxlbWVudHM6CiAgICAgICAgcG9pbnRzID0gZWxlbVsicG9pbnRzIl0KICAg
ICAgICBpZiBwb2ludHM6ICAjIE9ubHkgcHJvY2VzcyBpZiB0aGVyZSBhcmUgYWN0dWFsIHBvaW50
cwogICAgICAgICAgICB4X3ZhbHVlcyA9IFtwb2ludFswXSBmb3IgcG9pbnQgaW4gcG9pbnRzXQog
ICAgICAgICAgICB5X3ZhbHVlcyA9IFtwb2ludFsxXSBmb3IgcG9pbnQgaW4gcG9pbnRzXQogICAg
ICAgICAgICBzdWJwbG90X2F4LnNjYXR0ZXIoeF92YWx1ZXMsIHlfdmFsdWVzLCBsYWJlbD1lbGVt
WyJsYWJlbCJdKQoKICAgIGlmIGF4LmdldF9sZWdlbmQoKToKICAgICAgICBzdWJwbG90X2F4Lmxl
Z2VuZCgpCgogICAgcmV0dXJuIHN1YnBsb3RfYXgKCgpkZWYgcmVjcmVhdGVfYW5kX3NhdmVfbGlu
ZV9wbG90KGF4LCBlbGVtZW50cywgc3VicGxvdF9heCk6CiAgICAiIiJSZWNyZWF0ZSBhIGxpbmUg
cGxvdCBpbiBhIG5ldyBheGlzIiIiCiAgICBmb3IgZWxlbSBpbiBlbGVtZW50czoKICAgICAgICBw
b2ludHMgPSBlbGVtWyJwb2ludHMiXQogICAgICAgIGlmIHBvaW50czogICMgT25seSBwcm9jZXNz
IGlmIHRoZXJlIGFyZSBhY3R1YWwgcG9pbnRzCiAgICAgICAgICAgIHhfdmFsdWVzID0gW3BvaW50
WzBdIGZvciBwb2ludCBpbiBwb2ludHNdCiAgICAgICAgICAgIHlfdmFsdWVzID0gW3BvaW50WzFd
IGZvciBwb2ludCBpbiBwb2ludHNdCiAgICAgICAgICAgIHN1YnBsb3RfYXgucGxvdCh4X3ZhbHVl
cywgeV92YWx1ZXMsIGxhYmVsPWVsZW1bImxhYmVsIl0pCgogICAgaWYgYXguZ2V0X2xlZ2VuZCgp
OgogICAgICAgIHN1YnBsb3RfYXgubGVnZW5kKCkKCiAgICByZXR1cm4gc3VicGxvdF9heAoKCmRl
ZiByZWNyZWF0ZV9hbmRfc2F2ZV9waWVfY2hhcnQoYXgsIGVsZW1lbnRzLCBzdWJwbG90X2F4KToK
ICAgICIiIlJlY3JlYXRlIGEgcGllIGNoYXJ0IGluIGEgbmV3IGF4aXMiIiIKICAgIGlmIGVsZW1l
bnRzOgogICAgICAgICMgRmlsdGVyIG91dCB2ZXJ5IHNtYWxsIHNsaWNlcyAobGVzcyB0aGFuIDEg
ZGVncmVlKQogICAgICAgIGZpbHRlcmVkX2VsZW1lbnRzID0gW2VsZW0gZm9yIGVsZW0gaW4gZWxl
bWVudHMgaWYgZWxlbVsiYW5nbGUiXSA+IDEuMF0KCiAgICAgICAgaWYgZmlsdGVyZWRfZWxlbWVu
dHM6CiAgICAgICAgICAgIGxhYmVscyA9IFtlbGVtWyJsYWJlbCJdIGZvciBlbGVtIGluIGZpbHRl
cmVkX2VsZW1lbnRzXQogICAgICAgICAgICBhbmdsZXMgPSBbZWxlbVsiYW5nbGUiXSBmb3IgZWxl
bSBpbiBmaWx0ZXJlZF9lbGVtZW50c10KICAgICAgICAgICAgc3VicGxvdF9heC5waWUoYW5nbGVz
LCBsYWJlbHM9bGFiZWxzLCBhdXRvcGN0PSclMS4xZiUlJykKICAgICAgICBlbHNlOgogICAgICAg
ICAgICAjIEZhbGxiYWNrIGlmIGFsbCBzbGljZXMgd2VyZSBmaWx0ZXJlZCBvdXQKICAgICAgICAg
ICAgbGFiZWxzID0gW2VsZW1bImxhYmVsIl0gZm9yIGVsZW0gaW4gZWxlbWVudHNdCiAgICAgICAg
ICAgIGFuZ2xlcyA9IFtlbGVtWyJhbmdsZSJdIGZvciBlbGVtIGluIGVsZW1lbnRzXQogICAgICAg
ICAgICBzdWJwbG90X2F4LnBpZShhbmdsZXMsIGxhYmVscz1sYWJlbHMsIGF1dG9wY3Q9JyUxLjFm
JSUnKQoKICAgIHJldHVybiBzdWJwbG90X2F4CgoKZGVmIGNvcHlfYXhpc19wcm9wZXJ0aWVzKHNv
dXJjZV9heCwgdGFyZ2V0X2F4KToKICAgICIiIkNvcHkgYXhpcyBwcm9wZXJ0aWVzIGZyb20gb25l
IGF4aXMgdG8gYW5vdGhlciIiIgogICAgIyBDb3B5IHRpdGxlIGFuZCBsYWJlbHMKICAgIHRhcmdl
dF9heC5zZXRfdGl0bGUoc291cmNlX2F4LmdldF90aXRsZSgpKQogICAgdGFyZ2V0X2F4LnNldF94
bGFiZWwoc291cmNlX2F4LmdldF94bGFiZWwoKSkKICAgIHRhcmdldF9heC5zZXRfeWxhYmVsKHNv
dXJjZV9heC5nZXRfeWxhYmVsKCkpCgogICAgIyBDb3B5IHNjYWxlcwogICAgdGFyZ2V0X2F4LnNl
dF94c2NhbGUoc291cmNlX2F4LmdldF94c2NhbGUoKSkKICAgIHRhcmdldF9heC5zZXRfeXNjYWxl
KHNvdXJjZV9heC5nZXRfeXNjYWxlKCkpCgogICAgIyBDb3B5IHRpY2tzIGFuZCB0aWNrIGxhYmVs
cwogICAgdGFyZ2V0X2F4LnNldF94dGlja3Moc291cmNlX2F4LmdldF94dGlja3MoKSkKICAgIHRh
cmdldF9heC5zZXRfeXRpY2tzKHNvdXJjZV9heC5nZXRfeXRpY2tzKCkpCiAgICB0YXJnZXRfYXgu
c2V0X3h0aWNrbGFiZWxzKHNvdXJjZV9heC5nZXRfeHRpY2tsYWJlbHMoKSkKICAgIHRhcmdldF9h
eC5zZXRfeXRpY2tsYWJlbHMoc291cmNlX2F4LmdldF95dGlja2xhYmVscygpKQoKICAgIHJldHVy
biB0YXJnZXRfYXgKCgpkZWYgc2F2ZV9maWd1cmVfYXNfYmFzZTY0KGZpZywgYmJveF9pbmNoZXM9
J3RpZ2h0JywgZHBpPTEwMCk6CiAgICAiIiJTYXZlIGEgZmlndXJlIGFzIGEgYmFzZTY0LWVuY29k
ZWQgUE5HIHN0cmluZyIiIgogICAgcG5nX2J1ZmZlciA9IGlvLkJ5dGVzSU8oKQogICAgZmlnLnNh
dmVmaWcocG5nX2J1ZmZlciwgZm9ybWF0PSdwbmcnLCBiYm94X2luY2hlcz1iYm94X2luY2hlcywg
ZHBpPWRwaSkKICAgIHBuZ19idWZmZXIuc2VlaygwKQogICAgcmV0dXJuIGJhc2U2NC5iNjRlbmNv
ZGUocG5nX2J1ZmZlci5nZXR2YWx1ZSgpKS5kZWNvZGUoJ3V0Zi04JykKCgpkZWYgZXh0cmFjdF9h
bmRfcHJpbnRfZmlndXJlX21ldGFkYXRhKGZpZyk6CiAgICAiIiJFeHRyYWN0IG1ldGFkYXRhIGZy
b20gYSBtYXRwbG90bGliIGZpZ3VyZSBhbmQgcHJpbnQgYXMgSlNPTiIiIgogICAgaW1wb3J0IG1h
dHBsb3RsaWIucHlwbG90IGFzIHBsdAogICAgaW1wb3J0IG1hdHBsb3RsaWIuY29sbGVjdGlvbnMK
ICAgIGltcG9ydCBtYXRwbG90bGliLmZpZ3VyZQogICAgaW1wb3J0IG1hdHBsb3RsaWIucGF0Y2hl
cwogICAgaW1wb3J0IGpzb24KCiAgICBkZWYganNvbl9mbG9hdF9maXgob2JqKToKICAgICAgICAi
IiJIZWxwZXIgZnVuY3Rpb24gdG8gaGFuZGxlIE5hTiwgSW5maW5pdHksIGV0Yy4gaW4gSlNPTiIi
IgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBmbG9hdCk6CiAgICAgICAgICAgIGlmIG1hdGgu
aXNuYW4ob2JqKSBvciBtYXRoLmlzaW5mKG9iaik6CiAgICAgICAgICAgICAgICByZXR1cm4gMC4w
CiAgICAgICAgICAgIHJldHVybiBmbG9hdChvYmopCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKG9i
aiwgKGxpc3QsIHR1cGxlKSk6CiAgICAgICAgICAgIHJldHVybiBbanNvbl9mbG9hdF9maXgoaXRl
bSkgZm9yIGl0ZW0gaW4gb2JqXQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIGRpY3QpOgog
ICAgICAgICAgICByZXR1cm4ge2tleToganNvbl9mbG9hdF9maXgodmFsdWUpIGZvciBrZXksIHZh
bHVlIGluIG9iai5pdGVtcygpfQogICAgICAgIHJldHVybiBvYmoKCiAgICBtZXRhZGF0YSA9IHt9
CiAgICBzdWJwbG90cyA9IFtdCgogICAgIyBQcm9jZXNzIGVhY2ggYXhpcyBpbiB0aGUgZmlndXJl
CiAgICBmb3IgaSwgYXggaW4gZW51bWVyYXRlKGZpZy5heGVzKToKICAgICAgICBzdWJwbG90X2Rh
dGEgPSB7fQoKICAgICAgICAjIENoZWNrIGlmIHRoaXMgaXMgYSBjb2xvcmJhciBheGlzIC0gdGhl
c2Ugc2hvdWxkIGJlIGlnbm9yZWQgZm9yIGNsYXNzaWZpY2F0aW9uCiAgICAgICAgaXNfY29sb3Ji
YXJfYXhpcyA9IEZhbHNlCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIENvbG9yYmFyIGF4ZXMg
dHlwaWNhbGx5IGhhdmUgZmV3ZXIgY2hpbGRyZW4gYW5kIHNwZWNpZmljIHByb3BlcnRpZXMKICAg
ICAgICAgICAgaWYgaGFzYXR0cihheCwgJ2dldF9hc3BlY3QnKSBhbmQgYXguZ2V0X2FzcGVjdCgp
ID09IDIwLjA6CiAgICAgICAgICAgICAgICBpc19jb2xvcmJhcl9heGlzID0gVHJ1ZQogICAgICAg
ICAgICBpZiBoYXNhdHRyKGF4LCAnX2F4ZXMnKSBhbmQgaGFzYXR0cihheC5fYXhlcywgJ2NvbG9y
YmFyJyk6CiAgICAgICAgICAgICAgICBpc19jb2xvcmJhcl9heGlzID0gVHJ1ZQogICAgICAgICAg
ICAjIENoZWNrIGZvciBjb2xvcmJhci1zcGVjaWZpYyBjaGlsZHJlbgogICAgICAgICAgICBmb3Ig
Y2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCk6CiAgICAgICAgICAgICAgICBpZiBzdHIodHlwZShj
aGlsZCkuX19uYW1lX18pLmxvd2VyKCkuZmluZCgnY29sb3JiYXInKSA+PSAwOgogICAgICAgICAg
ICAgICAgICAgIGlzX2NvbG9yYmFyX2F4aXMgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgYnJl
YWsKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyBTa2lwIGNvbG9y
YmFyIGF4ZXMgd2hlbiBjb3VudGluZyBhY3R1YWwgc3VicGxvdHMKICAgICAgICBpZiBpc19jb2xv
cmJhcl9heGlzOgogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAjIFRpdGxlIGFuZCBsYWJl
bHMKICAgICAgICBpZiBheC5nZXRfdGl0bGUoKToKICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJ0
aXRsZSJdID0gYXguZ2V0X3RpdGxlKCkKICAgICAgICBpZiBheC5nZXRfeGxhYmVsKCk6CiAgICAg
ICAgICAgIHN1YnBsb3RfZGF0YVsieF9sYWJlbCJdID0gYXguZ2V0X3hsYWJlbCgpCiAgICAgICAg
aWYgYXguZ2V0X3lsYWJlbCgpOgogICAgICAgICAgICBzdWJwbG90X2RhdGFbInlfbGFiZWwiXSA9
IGF4LmdldF95bGFiZWwoKQoKICAgICAgICAjIEFkZCBYIGFuZCBZIHVuaXRzIC0gZXh0cmFjdCBm
cm9tIGxhYmVscyBpZiBwb3NzaWJsZQogICAgICAgIHN1YnBsb3RfZGF0YVsieF91bml0Il0gPSAi
Tm9uZSIgICMgRGVmYXVsdCB2YWx1ZQogICAgICAgIHN1YnBsb3RfZGF0YVsieV91bml0Il0gPSAi
Tm9uZSIgICMgRGVmYXVsdCB2YWx1ZQoKICAgICAgICAjIFRyeSB0byBleHRyYWN0IHVuaXRzIGZy
b20gYXhpcyBsYWJlbHMgaWYgdGhleSBjb250YWluIHBhcmVudGhlc2VzCiAgICAgICAgaWYgYXgu
Z2V0X3hsYWJlbCgpOgogICAgICAgICAgICB4X3VuaXRfbWF0Y2ggPSByZS5zZWFyY2gocidcKCgu
Kj8pXCknLCBheC5nZXRfeGxhYmVsKCkpCiAgICAgICAgICAgIGlmIHhfdW5pdF9tYXRjaDoKICAg
ICAgICAgICAgICAgIHN1YnBsb3RfZGF0YVsieF91bml0Il0gPSB4X3VuaXRfbWF0Y2guZ3JvdXAo
MSkKCiAgICAgICAgaWYgYXguZ2V0X3lsYWJlbCgpOgogICAgICAgICAgICB5X3VuaXRfbWF0Y2gg
PSByZS5zZWFyY2gocidcKCguKj8pXCknLCBheC5nZXRfeWxhYmVsKCkpCiAgICAgICAgICAgIGlm
IHlfdW5pdF9tYXRjaDoKICAgICAgICAgICAgICAgIHN1YnBsb3RfZGF0YVsieV91bml0Il0gPSB5
X3VuaXRfbWF0Y2guZ3JvdXAoMSkKCiAgICAgICAgIyBTY2FsZSB0eXBlcwogICAgICAgIHN1YnBs
b3RfZGF0YVsieF9zY2FsZSJdID0gYXguZ2V0X3hzY2FsZSgpCiAgICAgICAgc3VicGxvdF9kYXRh
WyJ5X3NjYWxlIl0gPSBheC5nZXRfeXNjYWxlKCkKCiAgICAgICAgIyBUaWNrcyBhbmQgdGljayBs
YWJlbHMKICAgICAgICB4dGlja3MgPSBheC5nZXRfeHRpY2tzKCkKICAgICAgICB5dGlja3MgPSBh
eC5nZXRfeXRpY2tzKCkKCiAgICAgICAgIyBHZXQgdGljayBsYWJlbHMsIGhhbmRsaW5nIGRpZmZl
cmVudCBtYXRwbG90bGliIHZlcnNpb25zCiAgICAgICAgdHJ5OgogICAgICAgICAgICB4dGlja2xh
YmVscyA9IFtsYWJlbC5nZXRfdGV4dCgpIGlmIGhhc2F0dHIobGFiZWwsICdnZXRfdGV4dCcpIGVs
c2Ugc3RyKGxhYmVsKQogICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgbGFiZWwgaW4gYXgu
Z2V0X3h0aWNrbGFiZWxzKCldCiAgICAgICAgICAgIHl0aWNrbGFiZWxzID0gW2xhYmVsLmdldF90
ZXh0KCkgaWYgaGFzYXR0cihsYWJlbCwgJ2dldF90ZXh0JykgZWxzZSBzdHIobGFiZWwpCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgIGZvciBsYWJlbCBpbiBheC5nZXRfeXRpY2tsYWJlbHMoKV0K
ICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICMgRmFsbGJhY2sgdG8gc2ltcGxlciBtZXRob2QK
ICAgICAgICAgICAgeHRpY2tsYWJlbHMgPSBbc3RyKGxhYmVsKSBmb3IgbGFiZWwgaW4gYXguZ2V0
X3h0aWNrbGFiZWxzKCldCiAgICAgICAgICAgIHl0aWNrbGFiZWxzID0gW3N0cihsYWJlbCkgZm9y
IGxhYmVsIGluIGF4LmdldF95dGlja2xhYmVscygpXQoKICAgICAgICAjIENvbnZlcnQgdG8gbGlz
dCBpZiBuZWVkZWQgYW5kIGVuc3VyZSBhbGwgdmFsdWVzIGFyZSBKU09OIHNlcmlhbGl6YWJsZQog
ICAgICAgIHRyeToKICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJ4X3RpY2tzIl0gPSBbZmxvYXQo
eCkgZm9yIHggaW4gKAogICAgICAgICAgICAgICAgeHRpY2tzLnRvbGlzdCgpIGlmIGhhc2F0dHIo
eHRpY2tzLCAndG9saXN0JykgZWxzZSBsaXN0KHh0aWNrcykpXQogICAgICAgICAgICBzdWJwbG90
X2RhdGFbInlfdGlja3MiXSA9IFtmbG9hdCh5KSBmb3IgeSBpbiAoCiAgICAgICAgICAgICAgICB5
dGlja3MudG9saXN0KCkgaWYgaGFzYXR0cih5dGlja3MsICd0b2xpc3QnKSBlbHNlIGxpc3QoeXRp
Y2tzKSldCiAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBUeXBlRXJyb3IpIGFzIGU6CiAgICAg
ICAgICAgIHN1YnBsb3RfZGF0YVsieF90aWNrcyJdID0gbGlzdChyYW5nZShsZW4oeHRpY2tsYWJl
bHMpKSkKICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJ5X3RpY2tzIl0gPSBsaXN0KHJhbmdlKGxl
bih5dGlja2xhYmVscykpKQoKICAgICAgICBzdWJwbG90X2RhdGFbInhfdGlja19sYWJlbHMiXSA9
IHh0aWNrbGFiZWxzCiAgICAgICAgc3VicGxvdF9kYXRhWyJ5X3RpY2tfbGFiZWxzIl0gPSB5dGlj
a2xhYmVscwoKICAgICAgICAjIFRyeSB0byBkZXRlcm1pbmUgY2hhcnQgdHlwZSBhbmQgZXh0cmFj
dCBlbGVtZW50cyBkYXRhCiAgICAgICAgY2hhcnRfdHlwZSA9ICJ1bmtub3duIiAgIyBEZWZhdWx0
IHZhbHVlIGluIHNuYWtlX2Nhc2UKICAgICAgICBlbGVtZW50cyA9IFtdCgogICAgICAgICMgUHJp
bnQgZGVidWcgaW5mbyBhYm91dCBjaGlsZHJlbgogICAgICAgIGNoaWxkX3R5cGVzID0ge30KICAg
ICAgICBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCk6CiAgICAgICAgICAgIGNoaWxkX3R5
cGUgPSB0eXBlKGNoaWxkKS5fX25hbWVfXwogICAgICAgICAgICBpZiBjaGlsZF90eXBlIG5vdCBp
biBjaGlsZF90eXBlczoKICAgICAgICAgICAgICAgIGNoaWxkX3R5cGVzW2NoaWxkX3R5cGVdID0g
MAogICAgICAgICAgICBjaGlsZF90eXBlc1tjaGlsZF90eXBlXSArPSAxCgogICAgICAgICMgSW1w
cm92ZWQgY2hhcnQgdHlwZSBkZXRlY3Rpb24gd2l0aCBtdWx0aXBsZSBjaGVja3MKCiAgICAgICAg
IyBDaGVjayBmb3IgdmFyaW91cyBjaGFydCBlbGVtZW50cwogICAgICAgIGJveF9wbG90cyA9IFtj
aGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkgaWYgaXNpbnN0YW5jZSgKICAgICAg
ICAgICAgY2hpbGQsIG1hdHBsb3RsaWIucGF0Y2hlcy5QYXRoUGF0Y2gpXQoKICAgICAgICAjIEZJ
WDogRml4ZWQgV2VkZ2UgZGV0ZWN0aW9uLCBjb3JyZWN0bHkgaW1wb3J0aW5nIGZyb20gbWF0cGxv
dGxpYi5wYXRjaGVzCiAgICAgICAgd2VkZ2VzID0gW2NoaWxkIGZvciBjaGlsZCBpbiBheC5nZXRf
Y2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgICAgICBjaGlsZCwgbWF0cGxvdGxpYi5w
YXRjaGVzLldlZGdlKV0KCiAgICAgICAgIyBDaGVjayBmb3IgbGluZXMgYW5kIHNjYXR0ZXIgcGxv
dHMKICAgICAgICBsaW5lcyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkg
aWYgaXNpbnN0YW5jZSgKICAgICAgICAgICAgY2hpbGQsIHBsdC5MaW5lMkQpIGFuZCBjaGlsZC5n
ZXRfbGluZXN0eWxlKCkgPT0gJy0nXQogICAgICAgIHNjYXR0ZXJzID0gW2NoaWxkIGZvciBjaGls
ZCBpbiBheC5nZXRfY2hpbGRyZW4oKSBpZiBpc2luc3RhbmNlKAogICAgICAgICAgICBjaGlsZCwg
bWF0cGxvdGxpYi5jb2xsZWN0aW9ucy5QYXRoQ29sbGVjdGlvbildCgogICAgICAgICMgQ2hlY2sg
Zm9yIHJlY3RhbmdsZXMgKHBvdGVudGlhbCBiYXIgY2hhcnRzKSAtIGV4cGFuZGVkIGNoZWNrCiAg
ICAgICAgcmVjdGFuZ2xlcyA9IFtjaGlsZCBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkg
aWYKICAgICAgICAgICAgICAgICAgICAgIChpc2luc3RhbmNlKGNoaWxkLCBwbHQuUmVjdGFuZ2xl
KSBhbmQgaGFzYXR0cihjaGlsZCwgJ2dldF9oZWlnaHQnKSkgb3IKICAgICAgICAgICAgICAgICAg
ICAgIChpc2luc3RhbmNlKGNoaWxkLCBtYXRwbG90bGliLnBhdGNoZXMuUmVjdGFuZ2xlKSBhbmQg
aGFzYXR0cihjaGlsZCwgJ2dldF9oZWlnaHQnKSldCgogICAgICAgICMgQWRkaXRpb25hbCBjaGVj
ayBmb3IgcGF0Y2gtYmFzZWQgcmVjdGFuZ2xlcyBpbiBuZXdlciBtYXRwbG90bGliCiAgICAgICAg
aWYgbGVuKHJlY3RhbmdsZXMpID09IDA6CiAgICAgICAgICAgIHBhdGNoX3JlY3RhbmdsZXMgPSBb
Y2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2UoCiAgICAg
ICAgICAgICAgICBjaGlsZCwgbWF0cGxvdGxpYi5wYXRjaGVzLlBhdGhQYXRjaCldCiAgICAgICAg
ICAgIGZvciBwYXRjaCBpbiBwYXRjaF9yZWN0YW5nbGVzOgogICAgICAgICAgICAgICAgdHJ5Ogog
ICAgICAgICAgICAgICAgICAgIHBhdGggPSBwYXRjaC5nZXRfcGF0aCgpCiAgICAgICAgICAgICAg
ICAgICAgdmVydGljZXMgPSBwYXRoLnZlcnRpY2VzCiAgICAgICAgICAgICAgICAgICAgaWYgbGVu
KHZlcnRpY2VzKSA+PSA0OiAgIyBSZWN0YW5nbGVzIHR5cGljYWxseSBoYXZlIGF0IGxlYXN0IDQg
dmVydGljZXMKICAgICAgICAgICAgICAgICAgICAgICAgcmVjdGFuZ2xlcy5hcHBlbmQocGF0Y2gp
CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAg
ICAjIENoZWNrIGZvciBib3ggcGxvdCBzcGVjaWZpYyBlbGVtZW50cwogICAgICAgIGNhcHMgPSBb
Y2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2UoCiAgICAg
ICAgICAgIGNoaWxkLCBwbHQuTGluZTJEKSBhbmQgY2hpbGQuZ2V0X21hcmtlcigpID09ICdfJ10K
CiAgICAgICAgIyBFbmhhbmNlZCBib3ggcGxvdCBkZXRlY3Rpb24KICAgICAgICBtZWRpYW5fbGlu
ZXMgPSBbY2hpbGQgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigpIGlmIGlzaW5zdGFuY2Uo
CiAgICAgICAgICAgIGNoaWxkLCBwbHQuTGluZTJEKSBhbmQgY2hpbGQuZ2V0X21hcmtlcigpID09
ICcnIGFuZCBjaGlsZC5nZXRfbGluZXN0eWxlKCkgPT0gJy0nIGFuZCBsZW4oY2hpbGQuZ2V0X3hk
YXRhKCkpID09IDJdCgogICAgICAgICMgQ2hlY2sgdGl0bGUgYW5kIGxhYmVscyBmb3IgaGludHMg
YWJvdXQgY2hhcnQgdHlwZQogICAgICAgIHRpdGxlID0gYXguZ2V0X3RpdGxlKCkubG93ZXIoKSBp
ZiBheC5nZXRfdGl0bGUoKSBlbHNlICIiCiAgICAgICAgeGxhYmVsID0gYXguZ2V0X3hsYWJlbCgp
Lmxvd2VyKCkgaWYgYXguZ2V0X3hsYWJlbCgpIGVsc2UgIiIKICAgICAgICB5bGFiZWwgPSBheC5n
ZXRfeWxhYmVsKCkubG93ZXIoKSBpZiBheC5nZXRfeWxhYmVsKCkgZWxzZSAiIgoKICAgICAgICAj
IEhldXJpc3RpYyBmb3IgY2hhcnQgdHlwZSBiYXNlZCBvbiB0aXRsZS9sYWJlbHMKICAgICAgICBp
c19iYXJfY2hhcnRfYnlfdGl0bGUgPSAiYmFyIiBpbiB0aXRsZQogICAgICAgIGlzX3BpZV9jaGFy
dF9ieV90aXRsZSA9ICJwaWUiIGluIHRpdGxlCiAgICAgICAgaXNfYm94X3Bsb3RfYnlfdGl0bGUg
PSAiYm94IiBpbiB0aXRsZSBvciAid2hpc2tlciIgaW4gdGl0bGUKICAgICAgICBpc19zY2F0dGVy
X2J5X3RpdGxlID0gInNjYXR0ZXIiIGluIHRpdGxlCiAgICAgICAgaXNfbGluZV9ieV90aXRsZSA9
ICJsaW5lIiBpbiB0aXRsZSBvciB0aXRsZS5zdGFydHN3aXRoKAogICAgICAgICAgICAiTGluZSBD
aGFydCIpCgogICAgICAgICMgQmV0dGVyIGNyaXRlcmlhIGZvciBib3ggcGxvdCBkZXRlY3Rpb24K
ICAgICAgICBpc19ib3hfcGxvdCA9IChpc19ib3hfcGxvdF9ieV90aXRsZSBvcgogICAgICAgICAg
ICAgICAgICAgICAgIChsZW4oYm94X3Bsb3RzKSA+IDAgYW5kIGxlbihjYXBzKSA+IDApIG9yCiAg
ICAgICAgICAgICAgICAgICAgICAgKGxlbihib3hfcGxvdHMpID4gMCBhbmQgbGVuKG1lZGlhbl9s
aW5lcykgPiAwKSkKCiAgICAgICAgIyBEZXRlcm1pbmUgY2hhcnQgdHlwZSBiYXNlZCBvbiBkZXRl
Y3RlZCBlbGVtZW50cwogICAgICAgICMgSW1wcm92ZWQgc2NhdHRlciBwbG90IGRldGVjdGlvbiBs
b2dpYwogICAgICAgIGhhc19zY2F0dGVycyA9IGxlbihzY2F0dGVycykgPiAwCiAgICAgICAgaGFz
X2NvbG9yYmFyID0gYW55KGlzaW5zdGFuY2UoY2hpbGQsIHBsdC5BeGVzKQogICAgICAgICAgICAg
ICAgICAgICAgICAgICBmb3IgY2hpbGQgaW4gYXguZ2V0X2NoaWxkcmVuKCkpCgogICAgICAgICMg
Q2hlY2sgbnVtYmVyIG9mIHN1YnBsb3RzIC0gYSBwbG90IHdpdGggYSBjb2xvcmJhciBpcyBvZnRl
biBkZXRlY3RlZCBhcyBjb21wb3NpdGUKICAgICAgICBpZiBpc19zY2F0dGVyX2J5X3RpdGxlIG9y
IGhhc19zY2F0dGVyczoKICAgICAgICAgICAgIyBQcmlvcml0aXplIHNjYXR0ZXIgZGV0ZWN0aW9u
CiAgICAgICAgICAgIGNoYXJ0X3R5cGUgPSAic2NhdHRlciIgICMgUmV2ZXJ0ZWQgdG8gc25ha2Vf
Y2FzZQogICAgICAgICAgICBlbGVtZW50cyA9IGV4dHJhY3Rfc2NhdHRlcl9wbG90X2RhdGEoYXgp
CiAgICAgICAgZWxpZiBpc19ib3hfcGxvdDoKICAgICAgICAgICAgIyBCb3ggcGxvdHMgb2Z0ZW4g
aGF2ZSB0aGVzZSBzcGVjaWZpYyBlbGVtZW50cwogICAgICAgICAgICBjaGFydF90eXBlID0gImJv
eF9hbmRfd2hpc2tlciIgICMgUmV2ZXJ0ZWQgdG8gc25ha2VfY2FzZQogICAgICAgICAgICBlbGVt
ZW50cyA9IGV4dHJhY3RfYm94X3Bsb3RfZGF0YShheCwgeHRpY2tsYWJlbHMpCiAgICAgICAgZWxp
ZiAod2VkZ2VzIGFuZCBsZW4od2VkZ2VzKSA+IDApIG9yIGlzX3BpZV9jaGFydF9ieV90aXRsZToK
ICAgICAgICAgICAgIyBQaWUgY2hhcnQKICAgICAgICAgICAgY2hhcnRfdHlwZSA9ICJwaWUiICAj
IFJldmVydGVkIHRvIHNuYWtlX2Nhc2UKICAgICAgICAgICAgZWxlbWVudHMgPSBleHRyYWN0X3Bp
ZV9jaGFydF9kYXRhKGF4KQogICAgICAgIGVsaWYgKChsaW5lcyBhbmQgbGVuKGxpbmVzKSA+IDAg
YW5kIG5vdCBpc19ib3hfcGxvdCkgb3IgaXNfbGluZV9ieV90aXRsZSk6CiAgICAgICAgICAgICMg
TGluZSBwbG90IChidXQgbm90IGJveCBwbG90IHdoaXNrZXJzKQogICAgICAgICAgICBjaGFydF90
eXBlID0gImxpbmUiICAjIFJldmVydGVkIHRvIHNuYWtlX2Nhc2UKICAgICAgICAgICAgZWxlbWVu
dHMgPSBleHRyYWN0X2xpbmVfcGxvdF9kYXRhKGF4KQogICAgICAgIGVsaWYgKChyZWN0YW5nbGVz
IGFuZCBsZW4ocmVjdGFuZ2xlcykgPiAwIGFuZCBub3QgaXNfYm94X3Bsb3QpIG9yIGlzX2Jhcl9j
aGFydF9ieV90aXRsZSk6CiAgICAgICAgICAgICMgQmFyIGNoYXJ0IChidXQgbm90IGJveCBwbG90
IGVsZW1lbnRzKQogICAgICAgICAgICBjaGFydF90eXBlID0gImJhciIgICMgUmV2ZXJ0ZWQgdG8g
c25ha2VfY2FzZQogICAgICAgICAgICBlbGVtZW50cyA9IGV4dHJhY3RfYmFyX2NoYXJ0X2RhdGEo
YXgsIHh0aWNrbGFiZWxzKQoKICAgICAgICAjIElmIG5vIGVsZW1lbnRzIHdlcmUgZGV0ZWN0ZWQg
YnV0IHdlIGhhdmUgc2NhdHRlcnMsIHRyeSBhZ2FpbiB3aXRoIHNjYXR0ZXIgZGV0ZWN0aW9uCiAg
ICAgICAgaWYgbGVuKGVsZW1lbnRzKSA9PSAwIGFuZCBoYXNfc2NhdHRlcnM6CiAgICAgICAgICAg
IGNoYXJ0X3R5cGUgPSAic2NhdHRlciIgICMgUmV2ZXJ0ZWQgdG8gc25ha2VfY2FzZQogICAgICAg
ICAgICBlbGVtZW50cyA9IGV4dHJhY3Rfc2NhdHRlcl9wbG90X2RhdGEoYXgpCgogICAgICAgICMg
SWYgd2Ugc3RpbGwgZG9uJ3QgaGF2ZSBlbGVtZW50cyBhbmQgdGl0bGUgc3VnZ2VzdHMgYSBsaW5l
IGNoYXJ0LCB0cnkgYWdhaW4gd2l0aCBsaW5lIGV4dHJhY3Rpb24KICAgICAgICBpZiBsZW4oZWxl
bWVudHMpID09IDAgYW5kIChpc19saW5lX2J5X3RpdGxlIG9yICJMaW5lIENoYXJ0IiBpbiBheC5n
ZXRfdGl0bGUoKSk6CiAgICAgICAgICAgIGNoYXJ0X3R5cGUgPSAibGluZSIKICAgICAgICAgICAg
ZWxlbWVudHMgPSBleHRyYWN0X2xpbmVfcGxvdF9kYXRhKGF4KQogICAgICAgICMgQ29udGludWUg
d2l0aCBlbXB0eSBlbGVtZW50cyBpZiBleHRyYWN0aW9uIGZhaWxzCgogICAgICAgIHN1YnBsb3Rf
ZGF0YVsidHlwZSJdID0gY2hhcnRfdHlwZQogICAgICAgIGlmIGVsZW1lbnRzOiAgIyBPbmx5IGFk
ZCBlbGVtZW50cyBpZiB3ZSBoYXZlIGFueQogICAgICAgICAgICBzdWJwbG90X2RhdGFbImVsZW1l
bnRzIl0gPSBlbGVtZW50cwoKICAgICAgICAjIFNhdmUgc3VicGxvdCBQTkcgaWYgdGhpcyBpcyBh
IG11bHRpLXN1YnBsb3QgZmlndXJlCiAgICAgICAgaWYgbGVuKGZpZy5heGVzKSA+IDE6CiAgICAg
ICAgICAgICMgQ3JlYXRlIGEgbmV3IGZpZ3VyZSB3aXRoIGp1c3QgdGhpcyBzdWJwbG90CiAgICAg
ICAgICAgIHN1YnBsb3RfZmlnID0gcGx0LmZpZ3VyZShmaWdzaXplPSg4LCA2KSkKICAgICAgICAg
ICAgc3VicGxvdF9heCA9IHN1YnBsb3RfZmlnLmFkZF9zdWJwbG90KDExMSkKCiAgICAgICAgICAg
ICMgUmVjcmVhdGUgdGhlIHBsb3QgYmFzZWQgb24gdGhlIGNoYXJ0IHR5cGUgYW5kIGVsZW1lbnRz
CiAgICAgICAgICAgIGlmIGNoYXJ0X3R5cGUgPT0gImJhciI6ICAjIFJldmVydGVkIHRvIHNuYWtl
X2Nhc2UKICAgICAgICAgICAgICAgIHN1YnBsb3RfYXggPSByZWNyZWF0ZV9hbmRfc2F2ZV9iYXJf
Y2hhcnQoCiAgICAgICAgICAgICAgICAgICAgYXgsIGVsZW1lbnRzLCBzdWJwbG90X2F4KQogICAg
ICAgICAgICBlbGlmIGNoYXJ0X3R5cGUgPT0gInNjYXR0ZXIiOiAgIyBSZXZlcnRlZCB0byBzbmFr
ZV9jYXNlCiAgICAgICAgICAgICAgICBzdWJwbG90X2F4ID0gcmVjcmVhdGVfYW5kX3NhdmVfc2Nh
dHRlcl9wbG90KAogICAgICAgICAgICAgICAgICAgIGF4LCBlbGVtZW50cywgc3VicGxvdF9heCkK
ICAgICAgICAgICAgZWxpZiBjaGFydF90eXBlID09ICJsaW5lIjogICMgUmV2ZXJ0ZWQgdG8gc25h
a2VfY2FzZQogICAgICAgICAgICAgICAgc3VicGxvdF9heCA9IHJlY3JlYXRlX2FuZF9zYXZlX2xp
bmVfcGxvdCgKICAgICAgICAgICAgICAgICAgICBheCwgZWxlbWVudHMsIHN1YnBsb3RfYXgpCiAg
ICAgICAgICAgIGVsaWYgY2hhcnRfdHlwZSA9PSAiYm94X2FuZF93aGlza2VyIjogICMgUmV2ZXJ0
ZWQgdG8gc25ha2VfY2FzZQogICAgICAgICAgICAgICAgIyBGb3IgYm94IHBsb3RzLCB1c2UgYSBk
aXJlY3QgY29weSBhcHByb2FjaAogICAgICAgICAgICAgICAgcGx0LmNsb3NlKHN1YnBsb3RfZmln
KQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgVXNlIGEgZGlyZWN0
IGNvcHkgaW5zdGVhZCAoY2FwdHVyZSB0aGUgZW50aXJlIGF4aXMpCiAgICAgICAgICAgICAgICAg
ICAgZXh0ZW50ID0gYXguZ2V0X3RpZ2h0YmJveChmaWcuY2FudmFzLmdldF9yZW5kZXJlcigpKS50
cmFuc2Zvcm1lZCgKICAgICAgICAgICAgICAgICAgICAgICAgZmlnLmRwaV9zY2FsZV90cmFucy5p
bnZlcnRlZCgpKQogICAgICAgICAgICAgICAgICAgIHN1YnBsb3RfZmlnID0gcGx0LmZpZ3VyZShm
aWdzaXplPWV4dGVudC5zaXplKQoKICAgICAgICAgICAgICAgICAgICAjIFNhdmUgdGhlIGZpZ3Vy
ZSBwb3J0aW9uIHRoYXQgY29udGFpbnMganVzdCB0aGlzIGF4aXMKICAgICAgICAgICAgICAgICAg
ICBwbmdfYnVmZmVyID0gaW8uQnl0ZXNJTygpCiAgICAgICAgICAgICAgICAgICAgZmlnLnNhdmVm
aWcocG5nX2J1ZmZlciwgZm9ybWF0PSdwbmcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGJib3hfaW5jaGVzPWV4dGVudCwgZHBpPTEwMCkKICAgICAgICAgICAgICAgICAgICBwbmdf
YnVmZmVyLnNlZWsoMCkKICAgICAgICAgICAgICAgICAgICBzdWJwbG90X2RhdGFbInBuZyJdID0g
YmFzZTY0LmI2NGVuY29kZSgKICAgICAgICAgICAgICAgICAgICAgICAgcG5nX2J1ZmZlci5nZXR2
YWx1ZSgpKS5kZWNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgICAgICAgICBwbHQuY2xvc2Uoc3Vi
cGxvdF9maWcpCiAgICAgICAgICAgICAgICAgICAgc3VicGxvdHMuYXBwZW5kKHN1YnBsb3RfZGF0
YSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4
Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICMgQ29udGludWUgdG8gdGhlIG5leHQg
c3VicGxvdCBpZiB0aGlzIGZhaWxzCiAgICAgICAgICAgICAgICAgICAgcGx0LmNsb3NlKHN1YnBs
b3RfZmlnKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGVsaWYgY2hh
cnRfdHlwZSA9PSAicGllIjogICMgUmV2ZXJ0ZWQgdG8gc25ha2VfY2FzZQogICAgICAgICAgICAg
ICAgc3VicGxvdF9heCA9IHJlY3JlYXRlX2FuZF9zYXZlX3BpZV9jaGFydCgKICAgICAgICAgICAg
ICAgICAgICBheCwgZWxlbWVudHMsIHN1YnBsb3RfYXgpCgogICAgICAgICAgICAjIFNldCB0aGUg
c3VicGxvdCBwcm9wZXJ0aWVzICh0aXRsZSwgbGFiZWxzLCBldGMuKQogICAgICAgICAgICBzdWJw
bG90X2F4ID0gY29weV9heGlzX3Byb3BlcnRpZXMoYXgsIHN1YnBsb3RfYXgpCgogICAgICAgICAg
ICAjIFNhdmUgdGhlIG5ldyBmaWd1cmUKICAgICAgICAgICAgc3VicGxvdF9maWcudGlnaHRfbGF5
b3V0KCkKICAgICAgICAgICAgc3VicGxvdF9kYXRhWyJwbmciXSA9IHNhdmVfZmlndXJlX2FzX2Jh
c2U2NChzdWJwbG90X2ZpZykKCiAgICAgICAgICAgICMgQ2xvc2UgdGhlIGZpZ3VyZSB0byBmcmVl
IG1lbW9yeQogICAgICAgICAgICBwbHQuY2xvc2Uoc3VicGxvdF9maWcpCiAgICAgICAgICAgICMg
Q29udGludWUgd2l0aG91dCB0aGUgUE5HIGlmIHRoZXJlJ3MgYW4gZXJyb3IKCiAgICAgICAgc3Vi
cGxvdHMuYXBwZW5kKHN1YnBsb3RfZGF0YSkKCiAgICBtZXRhZGF0YV9wbmcgPSBzYXZlX2ZpZ3Vy
ZV9hc19iYXNlNjQoZmlnKQoKICAgICMgQ291bnQgYWN0dWFsIHBsb3QgYXhlcyAoZXhjbHVkaW5n
IGNvbG9yYmFycykKICAgIGFjdHVhbF9wbG90X2F4ZXMgPSAwCiAgICBmb3IgYXggaW4gZmlnLmF4
ZXM6CiAgICAgICAgIyBTa2lwIGNvbG9yYmFyIGF4ZXMKICAgICAgICBpc19jb2xvcmJhcl9heGlz
ID0gRmFsc2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoYXgsICdnZXRfYXNw
ZWN0JykgYW5kIGF4LmdldF9hc3BlY3QoKSA9PSAyMC4wOgogICAgICAgICAgICAgICAgaXNfY29s
b3JiYXJfYXhpcyA9IFRydWUKICAgICAgICAgICAgaWYgaGFzYXR0cihheCwgJ19heGVzJykgYW5k
IGhhc2F0dHIoYXguX2F4ZXMsICdjb2xvcmJhcicpOgogICAgICAgICAgICAgICAgaXNfY29sb3Ji
YXJfYXhpcyA9IFRydWUKICAgICAgICAgICAgZm9yIGNoaWxkIGluIGF4LmdldF9jaGlsZHJlbigp
OgogICAgICAgICAgICAgICAgaWYgc3RyKHR5cGUoY2hpbGQpLl9fbmFtZV9fKS5sb3dlcigpLmZp
bmQoJ2NvbG9yYmFyJykgPj0gMDoKICAgICAgICAgICAgICAgICAgICBpc19jb2xvcmJhcl9heGlz
ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZXhjZXB0OgogICAgICAg
ICAgICBwYXNzCgogICAgICAgIGlmIG5vdCBpc19jb2xvcmJhcl9heGlzOgogICAgICAgICAgICBh
Y3R1YWxfcGxvdF9heGVzICs9IDEKCiAgICAjIENyZWF0ZSB0aGUgZmluYWwgbWV0YWRhdGEgc3Ry
dWN0dXJlCiAgICBpZiBhY3R1YWxfcGxvdF9heGVzID4gMToKICAgICAgICAjIE11bHRpcGxlIGFj
dHVhbCBzdWJwbG90cyAtIGNyZWF0ZSBhIG1haW4gY2hhcnQKICAgICAgICBtZXRhZGF0YSA9IHsK
ICAgICAgICAgICAgIyBUcnkgdG8gZ2V0IGZpZ3VyZSBzdXB0aXRsZQogICAgICAgICAgICAidGl0
bGUiOiBmaWcudGV4dHNbMF0uZ2V0X3RleHQoKSBpZiBmaWcudGV4dHMgZWxzZSBOb25lLAogICAg
ICAgICAgICAidHlwZSI6ICJjb21wb3NpdGVfY2hhcnQiLCAgIyBSZXZlcnRlZCB0byBzbmFrZV9j
YXNlCiAgICAgICAgICAgICJwbmciOiBtZXRhZGF0YV9wbmcsCiAgICAgICAgICAgICJzdWJwbG90
cyI6IHN1YnBsb3RzCiAgICAgICAgfQogICAgZWxzZToKICAgICAgICAjIFNpbmdsZSBwbG90IChw
b3NzaWJseSB3aXRoIGNvbG9yYmFycykgLSB1c2UgdGhlIHN1YnBsb3QgZGF0YSBkaXJlY3RseQog
ICAgICAgICMgRmluZCB0aGUgbm9uLWNvbG9yYmFyIHN1YnBsb3QKICAgICAgICBmb3Igc3VicGxv
dCBpbiBzdWJwbG90czoKICAgICAgICAgICAgaWYgc3VicGxvdC5nZXQoInR5cGUiKSAhPSAidW5r
bm93biI6CiAgICAgICAgICAgICAgICBtZXRhZGF0YSA9IHN1YnBsb3QKICAgICAgICAgICAgICAg
IG1ldGFkYXRhWyJwbmciXSA9IG1ldGFkYXRhX3BuZwogICAgICAgICAgICAgICAgYnJlYWsKICAg
ICAgICBlbHNlOgogICAgICAgICAgICAjIEZhbGxiYWNrIGlmIG5vIHZhbGlkIHN1YnBsb3QgZm91
bmQKICAgICAgICAgICAgbWV0YWRhdGEgPSBzdWJwbG90c1swXSBpZiBzdWJwbG90cyBlbHNlIHsi
dHlwZSI6ICJ1bmtub3duIn0KICAgICAgICAgICAgbWV0YWRhdGFbInBuZyJdID0gbWV0YWRhdGFf
cG5nCgogICAgIyBGaXggYW55IEpTT04gc2VyaWFsaXphdGlvbiBpc3N1ZXMgKGUuZy4sIE5hTiwg
SW5maW5pdHkpCiAgICBtZXRhZGF0YSA9IGpzb25fZmxvYXRfZml4KG1ldGFkYXRhKQoKICAgICMg
UHJpbnQgbWV0YWRhdGEgaW4gdGhlIHNwZWNpZmllZCBKU09OIGZvcm1hdAogICAganNvbl9vdXRw
dXQgPSB7CiAgICAgICAgInR5cGUiOiAiY2hhcnQiLAogICAgICAgICJ2YWx1ZSI6IG1ldGFkYXRh
CiAgICB9CgogICAgIyBpZiBtZXRhZGF0YS5nZXQoInR5cGUiKSA9PSAibGluZSI6CiAgICAjICAg
ICBtZXRhZGF0YV9jb3B5ID0gbWV0YWRhdGEuY29weSgpICAjIENyZWF0ZSBhIGNvcHkgb2YgbWV0
YWRhdGEKICAgICMgICAgIG1ldGFkYXRhX2NvcHkucG9wKCJwbmciLCBOb25lKSAgIyBSZW1vdmUg
dGhlIHBuZyBwcm9wZXJ0eQogICAgIyAgICAgcHJpbnQoZiJsaW5lOiB7bWV0YWRhdGFfY29weX0i
KQoKICAgIHByaW50KGYiZHRuX2FydGlmYWN0Ontqc29uLmR1bXBzKGpzb25fb3V0cHV0KX0iKQoK
CmNsYXNzIE1hdHBsb3RsaWJGaW5kZXIoTWV0YVBhdGhGaW5kZXIpOgogICAgIiIiQ3VzdG9tIGZp
bmRlciB0byBpbnRlcmNlcHQgbWF0cGxvdGxpYi5weXBsb3QgaW1wb3J0cyIiIgoKICAgIGRlZiBm
aW5kX3NwZWMoc2VsZiwgZnVsbG5hbWUsIHBhdGgsIHRhcmdldD1Ob25lKToKICAgICAgICBnbG9i
YWwgcGx0X3BhdGNoZWQKCiAgICAgICAgIyBPbmx5IGludGVyY2VwdCBtYXRwbG90bGliLnB5cGxv
dAogICAgICAgIGlmIGZ1bGxuYW1lID09ICdtYXRwbG90bGliLnB5cGxvdCcgYW5kIG5vdCBwbHRf
cGF0Y2hlZDoKICAgICAgICAgICAgIyBNYXJrIGFzIHBhdGNoZWQgdG8gcHJldmVudCByZWN1cnNp
b24KICAgICAgICAgICAgcGx0X3BhdGNoZWQgPSBUcnVlCgogICAgICAgICAgICAjIEZpbmQgdGhl
IG9yaWdpbmFsIHNwZWMKICAgICAgICAgICAgb3JpZ2luYWxfc3BlYyA9IGZpbmRfc3BlYyhmdWxs
bmFtZSkKICAgICAgICAgICAgaWYgb3JpZ2luYWxfc3BlYyBpcyBOb25lOgogICAgICAgICAgICAg
ICAgcmV0dXJuIE5vbmUKCiAgICAgICAgICAgICMgQ3JlYXRlIGEgc3BlYyB3aXRoIG91ciBsb2Fk
ZXIKICAgICAgICAgICAgcmV0dXJuIHNwZWNfZnJvbV9sb2FkZXIoCiAgICAgICAgICAgICAgICBm
dWxsbmFtZSwKICAgICAgICAgICAgICAgIE1hdHBsb3RsaWJMb2FkZXIob3JpZ2luYWxfc3BlYy5s
b2FkZXIpLAogICAgICAgICAgICAgICAgb3JpZ2luPW9yaWdpbmFsX3NwZWMub3JpZ2luLAogICAg
ICAgICAgICAgICAgaXNfcGFja2FnZT1vcmlnaW5hbF9zcGVjLnN1Ym1vZHVsZV9zZWFyY2hfbG9j
YXRpb25zIGlzIG5vdCBOb25lCiAgICAgICAgICAgICkKICAgICAgICByZXR1cm4gTm9uZQoKCmNs
YXNzIE1hdHBsb3RsaWJMb2FkZXIoTG9hZGVyKToKICAgICIiIkN1c3RvbSBsb2FkZXIgdG8gcGF0
Y2ggdGhlIG1hdHBsb3RsaWIucHlwbG90IG1vZHVsZSIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxm
LCBvcmlnaW5hbF9sb2FkZXIpOgogICAgICAgIHNlbGYub3JpZ2luYWxfbG9hZGVyID0gb3JpZ2lu
YWxfbG9hZGVyCgogICAgZGVmIGNyZWF0ZV9tb2R1bGUoc2VsZiwgc3BlYyk6CiAgICAgICAgIyBM
ZXQgdGhlIG9yaWdpbmFsIGxvYWRlciBjcmVhdGUgdGhlIG1vZHVsZQogICAgICAgIHJldHVybiBz
ZWxmLm9yaWdpbmFsX2xvYWRlci5jcmVhdGVfbW9kdWxlKHNwZWMpCgogICAgZGVmIGV4ZWNfbW9k
dWxlKHNlbGYsIG1vZHVsZSk6CiAgICAgICAgIyBGaXJzdCBleGVjdXRlIHRoZSByZWFsIG1vZHVs
ZQogICAgICAgIHNlbGYub3JpZ2luYWxfbG9hZGVyLmV4ZWNfbW9kdWxlKG1vZHVsZSkKCiAgICAg
ICAgIyBOb3cgcGF0Y2ggdGhlIHNob3cgZnVuY3Rpb24KICAgICAgICBpZiBoYXNhdHRyKG1vZHVs
ZSwgJ3Nob3cnKToKICAgICAgICAgICAgIyBTdG9yZSB0aGUgb3JpZ2luYWwgc2hvdyBmdW5jdGlv
bgogICAgICAgICAgICBvcmlnaW5hbF9zaG93ID0gbW9kdWxlLnNob3cKCiAgICAgICAgICAgICMg
RGVmaW5lIG91ciBjdXN0b20gc2hvdyBmdW5jdGlvbgogICAgICAgICAgICBkZWYgY3VzdG9tX3No
b3coKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgICAgIGdsb2JhbCBwcm9jZXNzZWRfZmln
dXJlcwoKICAgICAgICAgICAgICAgICMgR2V0IGFsbCBjdXJyZW50IGZpZ3VyZSBudW1iZXJzCiAg
ICAgICAgICAgICAgICBmaWdfbnVtcyA9IG1vZHVsZS5nZXRfZmlnbnVtcygpCgogICAgICAgICAg
ICAgICAgIyBDaGVjayBmb3IgbmV3IGZpZ3VyZXMKICAgICAgICAgICAgICAgIGZvciBmaWdfbnVt
IGluIGZpZ19udW1zOgogICAgICAgICAgICAgICAgICAgIGlmIGZpZ19udW0gbm90IGluIHByb2Nl
c3NlZF9maWd1cmVzOgogICAgICAgICAgICAgICAgICAgICAgICAjIFRoaXMgaXMgYSBuZXcgZmln
dXJlLCBwcm9jZXNzIGl0CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZyA9IG1vZHVsZS5maWd1
cmUoZmlnX251bSkKICAgICAgICAgICAgICAgICAgICAgICAgZXh0cmFjdF9hbmRfcHJpbnRfZmln
dXJlX21ldGFkYXRhKGZpZykKCiAgICAgICAgICAgICAgICAgICAgICAgICMgTWFyayBhcyBwcm9j
ZXNzZWQKICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2ZpZ3VyZXMuYWRkKGZpZ19u
dW0pCgogICAgICAgICAgICAgICAgIyBDYWxsIHRoZSBvcmlnaW5hbCBzaG93IGZ1bmN0aW9uIHdp
dGggYWxsIGFyZ3VtZW50cwogICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsX3Nob3coKmFy
Z3MsICoqa3dhcmdzKQoKICAgICAgICAgICAgIyBSZXBsYWNlIHRoZSBzaG93IGZ1bmN0aW9uIHdp
dGggb3VyIGN1c3RvbSB2ZXJzaW9uCiAgICAgICAgICAgIG1vZHVsZS5zaG93ID0gY3VzdG9tX3No
b3cKCgpkZWYgc2V0dXBfdXNlcl9jb2RlX2Vudmlyb25tZW50KGNvZGUpOgogICAgIiIiU2V0IHVw
IHRoZSBtb2R1bGUgdG8gcnVuIHVzZXIgY29kZSBpbiIiIgogICAgbW9kdWxlID0gdHlwZXMuTW9k
dWxlVHlwZSgnX19tYWluX18nKQogICAgbW9kdWxlLl9fZmlsZV9fID0gJzx1c2VyX2NvZGU+Jwog
ICAgc3lzLm1vZHVsZXNbJ19fbWFpbl9fJ10gPSBtb2R1bGUKCiAgICAjIEFkZCBjb2RlIHRvIGxp
bmUgY2FjaGUgZm9yIGJldHRlciB0cmFjZWJhY2tzCiAgICBjb2RlX2xpbmVzID0gY29kZS5zcGxp
dGxpbmVzKCkKICAgIGxpbmVjYWNoZS5jYWNoZVsnPHVzZXJfY29kZT4nXSA9ICgKICAgICAgICBs
ZW4oY29kZSksCiAgICAgICAgTm9uZSwKICAgICAgICBjb2RlX2xpbmVzLAogICAgICAgICc8dXNl
cl9jb2RlPicKICAgICkKCiAgICByZXR1cm4gbW9kdWxlCgoKZGVmIHJ1bl91c2VyX2NvZGUoY29k
ZSk6CiAgICAiIiJSdW4gdGhlIHVzZXIgY29kZSB3aXRoIHRoZSBtYXRwbG90bGliIGludGVyY2Vw
dG9yIGluc3RhbGxlZCIiIgogICAgIyBJbnN0YWxsIG1hdHBsb3RsaWIgaW50ZXJjZXB0b3IKICAg
IHN5cy5tZXRhX3BhdGguaW5zZXJ0KDAsIE1hdHBsb3RsaWJGaW5kZXIoKSkKCiAgICAjIFNldCB1
cCBjbGVhbiBlbnZpcm9ubWVudCBmb3IgdXNlciBjb2RlCiAgICBtb2R1bGUgPSBzZXR1cF91c2Vy
X2NvZGVfZW52aXJvbm1lbnQoY29kZSkKCiAgICAjIENvbXBpbGUgYW5kIHJ1biB0aGUgY29kZQog
ICAgY29tcGlsZWQgPSBjb21waWxlKGNvZGUsICc8dXNlcl9jb2RlPicsICdleGVjJykKCiAgICAj
IEV4ZWN1dGUgaW4gdGhlIG1vZHVsZSdzIG5hbWVzcGFjZQogICAgZXhlYyhjb21waWxlZCwgbW9k
dWxlLl9fZGljdF9fKQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICB0cnk6CiAgICAg
ICAgIyBHZXQgdGhlIGVuY29kZWQgdXNlciBjb2RlCiAgICAgICAgdXNlcl9jb2RlID0gYmFzZTY0
LmI2NGRlY29kZSgie2VuY29kZWRfY29kZX0iKS5kZWNvZGUoKQoKICAgICAgICAjIFJ1biB0aGUg
Y29kZQogICAgICAgIHJ1bl91c2VyX2NvZGUodXNlcl9jb2RlKQogICAgZXhjZXB0IEV4Y2VwdGlv
bjoKICAgICAgICAjIFByaW50IG9ubHkgdGhlIHJlbGV2YW50IHBhcnRzIG9mIHRoZSB0cmFjZWJh
Y2sKICAgICAgICBleGNfdHlwZSwgZXhjX3ZhbHVlLCBleGNfdGIgPSBzeXMuZXhjX2luZm8oKQoK
ICAgICAgICAjIEZpbHRlciB0cmFjZWJhY2sgdG8gb25seSBzaG93IHVzZXIgY29kZSBmcmFtZXMK
ICAgICAgICBmaWx0ZXJlZF90YiA9IFtdCiAgICAgICAgdGIgPSBleGNfdGIKICAgICAgICB3aGls
ZSB0YiBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgdGIudGJfZnJhbWUuZl9jb2RlLmNvX2Zp
bGVuYW1lID09ICc8dXNlcl9jb2RlPic6CiAgICAgICAgICAgICAgICBmaWx0ZXJlZF90Yi5hcHBl
bmQodGIpCiAgICAgICAgICAgIHRiID0gdGIudGJfbmV4dAoKICAgICAgICBpZiBmaWx0ZXJlZF90
YjoKICAgICAgICAgICAgIyBDcmVhdGUgYSBuZXcgdHJhY2ViYWNrIGZyb20gdGhlIGZpbHRlcmVk
IGZyYW1lcwogICAgICAgICAgICBleGNfdmFsdWUuX190cmFjZWJhY2tfXyA9IGZpbHRlcmVkX3Ri
Wy0xXQogICAgICAgICAgICB0cmFjZWJhY2sucHJpbnRfZXhjZXB0aW9uKAogICAgICAgICAgICAg
ICAgZXhjX3R5cGUsIGV4Y192YWx1ZSwgZXhjX3ZhbHVlLl9fdHJhY2ViYWNrX18pCiAgICAgICAg
ZWxzZToKICAgICAgICAgICAgIyBGYWxsYmFjayBpZiBubyB1c2VyIGNvZGUgZnJhbWVzIGZvdW5k
IC0gcmFpc2UgdGhlIG9yaWdpbmFsIGV4Y2VwdGlvbiB0eXBlCiAgICAgICAgICAgICMgd2l0aCB0
aGUgb3JpZ2luYWwgbWVzc2FnZSBidXQgY3JlYXRlIGEgZnJlc2ggdHJhY2ViYWNrCiAgICAgICAg
ICAgIHJhaXNlIGV4Y190eXBlKHN0cihleGNfdmFsdWUpKSBmcm9tIE5vbmUKCiAgICAgICAgc3lz
LmV4aXQoMSkK
"""
